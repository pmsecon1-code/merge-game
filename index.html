<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- ìºì‹œ ë¹„í™œì„±í™” -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ê³ ì–‘ì´ & ê°•ì•„ì§€ ë¨¸ì§€ (Ver 4.0.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <!-- ë¶„ë¦¬ëœ CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <!-- ë¶„ë¦¬ëœ ìƒìˆ˜/ë°ì´í„° -->
    <script src="js/constants.js"></script>
    <style>
        /* ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì€ css/styles.cssë¡œ ì´ë™ë¨ */
    </style>
</head>
<body>

<!-- ë¡œê·¸ì¸ í™”ë©´ (ê²Œì„ ì‹œì‘ ì „) -->
<div id="login-screen" class="fixed inset-0 bg-gradient-to-b from-rose-100 to-amber-100 flex flex-col items-center justify-center z-50">
    <div class="text-center px-6">
        <div class="text-8xl mb-6 animate-bounce">ğŸ±ğŸ¶</div>
        <h1 class="text-5xl font-bold text-rose-500 mb-3" style="font-family: 'Jua', sans-serif;">ë©ëƒ¥ ë¨¸ì§€</h1>
        <p class="text-gray-400 text-sm mb-10">ê·€ì—¬ìš´ ë™ë¬¼ë“¤ì„ í•©ì³ì„œ ì„±ì¥ì‹œí‚¤ì„¸ìš”!</p>

        <button id="google-login-btn" onclick="startGoogleLogin()"
            class="flex items-center justify-center gap-3 bg-white hover:bg-gray-50 text-gray-700 font-bold py-4 px-8 rounded-full shadow-lg transition-all hover:scale-105 mx-auto">
            <svg class="w-6 h-6" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            <span>Googleë¡œ ì‹œì‘í•˜ê¸°</span>
        </button>

        <p id="login-status" class="text-sm text-gray-400 mt-6 hidden">ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...</p>
    </div>
</div>


<div id="game-container" style="display: none;">
    <!-- ìƒíƒœë°” -->
    <div class="status-bar">
        <h1 class="text-sm font-bold text-rose-500 mr-1 flex-shrink-0">ë©ëƒ¥ ë¨¸ì§€</h1>
        <div class="status-item border-yellow-300">
            <span class="text-xs">âš¡</span>
            <div class="flex flex-col leading-none">
                <span id="energy-val" class="text-xs font-bold text-yellow-500">100</span>
                <span id="energy-timer" class="text-[8px] text-gray-400 font-mono">FULL</span>
            </div>
        </div>
        <div class="status-item border-yellow-500"><span class="text-xs">ğŸª™</span><span id="coin-val" class="text-xs text-yellow-600 font-bold">0</span></div>
        <div class="status-item border-cyan-400"><span class="text-xs">ğŸ’</span><span id="diamond-val" class="text-xs text-cyan-600 font-bold">0</span></div>
        <div class="status-item border-purple-400">
            <div class="flex flex-col items-center leading-none">
                <span id="level-val" class="text-xs font-bold text-purple-600">Lv.1</span>
                <span id="quest-progress" class="text-[8px] text-gray-500 font-bold mt-0.5">0/3</span>
            </div>
        </div>
        <button id="login-btn" onclick="handleGoogleLogin()" class="status-item border-blue-400 cursor-pointer hover:bg-blue-50">
            <span class="text-xs">ğŸ”‘</span><span id="login-text" class="text-xs text-blue-600 font-bold">ë¡œê·¸ì¸</span>
        </button>
        <div id="save-status" class="text-[10px] text-gray-400 hidden">ğŸ’¾</div>
    </div>

    <!-- 1. ëˆ„ì  í€˜ìŠ¤íŠ¸ -->
    <div id="special-quest-bar" class="event-bar">
        <div class="flex justify-between items-end mb-1">
            <span class="text-[10px] font-bold text-gray-600">ğŸ‘‘ ëˆ„ì  ì½”ì¸ (ì¹¸ë§ˆë‹¤ 50ğŸª™)</span>
            <span id="cumulative-text" class="text-[9px] text-yellow-600 font-bold">0 / 200</span>
        </div>
        <div class="progress-track">
            <div id="cumulative-bar" class="progress-fill"></div>
            <div class="milestone-marker" style="left: 20%"></div><div class="milestone-marker" style="left: 40%"></div><div class="milestone-marker" style="left: 60%"></div><div class="milestone-marker" style="left: 80%"></div>
        </div>
    </div>

    <!-- 2. ì¼ë°˜ í€˜ìŠ¤íŠ¸ -->
    <div id="quest-area" class="event-bar">
        <span class="text-[10px] font-bold text-purple-600">ğŸ“‹ ì¼ë°˜ í€˜ìŠ¤íŠ¸</span>
        <div id="quest-wrapper">
            <button id="quest-prev" class="quest-nav-btn" onclick="scrollQuests(-1)">â€¹</button>
            <div id="quest-container"></div>
            <button id="quest-next" class="quest-nav-btn" onclick="scrollQuests(1)">â€º</button>
        </div>
    </div>

    <!-- 3. ë§µ -->
    <div id="board-wrapper">
        <div id="scroll-area">
            <div id="game-board" class="grid-layout"></div>
        </div>
    </div>

    <!-- 4. ìƒì‹œ ë¯¸ì…˜ -->
    <div id="persistent-mission-bar" class="event-bar">
        <div class="flex justify-between items-end mb-1">
            <span id="pm-label" class="text-[10px] font-bold text-purple-600">ğŸ”¨ 100ë²ˆ í•©ì„±í•˜ê¸° (100ğŸª™)</span>
            <span id="pm-text" class="text-[9px] text-purple-500 font-bold">0/100</span>
        </div>
        <div class="progress-track">
            <div id="pm-bar" class="progress-fill" style="background: linear-gradient(90deg, #a78bfa, #7c3aed);"></div>
        </div>
    </div>

    <!-- 5. ìŠ¤í˜ì…œ í€˜ìŠ¤íŠ¸ (ìƒˆ/ë¬¼ê³ ê¸°/íŒŒì¶©ë¥˜) -->
    <div id="special-quest-area" class="event-bar">
        <span class="text-[10px] font-bold text-yellow-600">â­ ìŠ¤í˜ì…œ í€˜ìŠ¤íŠ¸</span>
        <div id="special-mission-container">
            <div id="sp-mission-0" class="sp-mission-card"><div class="sp-icon">ğŸ¦</div><div id="sp-text-0" class="sp-text">Lv.3<br>ì˜¤í”ˆ</div><div class="sp-reward-text">ë³´ìƒ: 500ğŸª™ 10ğŸ’</div><div id="sp-btn-0" class="sp-btn" onclick="completeSpecialMission(0)">ì™„ë£Œ!</div></div>
            <div id="sp-mission-1" class="sp-mission-card"><div class="sp-icon">ğŸ </div><div id="sp-text-1" class="sp-text">Lv.6<br>ì˜¤í”ˆ</div><div class="sp-reward-text">ë³´ìƒ: 500ğŸª™ 10ğŸ’</div><div id="sp-btn-1" class="sp-btn" onclick="completeSpecialMission(1)">ì™„ë£Œ!</div></div>
            <div id="sp-mission-2" class="sp-mission-card"><div class="sp-icon">ğŸ¦</div><div id="sp-text-2" class="sp-text">Lv.9<br>ì˜¤í”ˆ</div><div class="sp-reward-text">ë³´ìƒ: 500ğŸª™ 10ğŸ’</div><div id="sp-btn-2" class="sp-btn" onclick="completeSpecialMission(2)">ì™„ë£Œ!</div></div>
        </div>
    </div>

    <!-- 6. êµ¬ì¡° í˜„ì¥ -->
    <div id="rescue-quest-bar" class="event-bar">
        <div class="flex justify-between items-end mb-1">
            <span class="text-[10px] font-bold text-blue-600">ğŸš‘ ëª¨ë‘ êµ¬ì¡° (1000ğŸª™)</span>
            <div class="flex items-center gap-2">
                <span id="rescue-timer" class="text-[9px] text-red-500 font-mono font-bold">59:59</span>
                <span id="rescue-text" class="text-[9px] text-blue-500 font-bold">0 / 15</span>
            </div>
        </div>
        <div class="progress-track">
            <div id="rescue-bar" class="progress-fill"></div>
            <div class="milestone-marker" style="left: 33.33%"></div><div class="milestone-marker" style="left: 66.67%"></div>
        </div>
    </div>
    <div id="apartment-area"></div>

    <!-- 7. ìƒì  -->
    <div id="shop-area">
        <div id="shop-timer-badge">ê°±ì‹ : 05:00</div>
        <div class="grid-layout" id="shop-grid"></div>
    </div>

    <!-- 8. ì°½ê³  -->
    <div id="storage-wrapper" class="event-bar">
        <span class="text-[10px] font-bold text-emerald-600">ğŸ“¦ ì°½ê³ </span>
        <div id="storage-area" class="grid-layout"></div>
    </div>

    <div id="tutorial-pointer" class="hidden">ğŸ‘†</div>
    </div>
</div>

<!-- íŒì—…ë“¤ -->
<div id="toast"></div>


<div id="levelup-overlay" class="overlay-bg">
    <div class="overlay-content">
        <div class="text-6xl mb-4">ğŸ‰</div><h2 class="text-3xl font-bold text-rose-500 mb-2">LEVEL UP!</h2>
        <p class="text-xl text-gray-600 mb-4">Lv.<span id="levelup-num">2</span> ë‹¬ì„±!</p>
        <div class="bg-cyan-100 text-cyan-700 px-6 py-3 rounded-xl font-bold text-lg mb-6">ğŸ’ +<span id="levelup-reward">5</span></div>
        <button onclick="closeOverlay('levelup-overlay')" class="bg-rose-500 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-rose-600">í™•ì¸</button>
    </div>
</div>

<div id="milestone-overlay" class="overlay-bg">
    <div class="overlay-content">
        <div class="text-6xl mb-4">ğŸŠ</div><h2 class="text-3xl font-bold text-yellow-500 mb-2">ëª©í‘œ ë‹¬ì„±!</h2>
        <p id="milestone-text" class="text-xl text-gray-600 mb-4"></p>
        <div class="bg-yellow-100 text-yellow-700 px-6 py-3 rounded-xl font-bold text-lg mb-6">ë³´ìƒ: <span id="milestone-reward"></span></div>
        <button onclick="closeOverlay('milestone-overlay')" class="bg-yellow-500 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-yellow-600">ë©‹ì ¸ìš”!</button>
    </div>
</div>

<div id="energy-popup" class="overlay-bg">
    <div class="overlay-content bg-white p-6 rounded-2xl shadow-xl border-4 border-yellow-300">
        <div class="text-5xl mb-3">âš¡</div><h2 class="text-2xl font-bold text-gray-800 mb-2">ì—ë„ˆì§€ ë¶€ì¡±!</h2>
        <p class="text-sm text-gray-500 mb-2">ì—ë„ˆì§€ 100ê°œ ì¶©ì „</p>
        <p class="text-xs text-yellow-600 font-bold mb-2">ë³´ìœ : <span id="popup-coin-val">0</span>ğŸª™</p>
        <p class="text-xs text-blue-500 mb-4">ğŸ”„ ê°€ê²© ë¦¬ì…‹: <span id="energy-reset-timer" class="font-mono font-bold">00:00:00</span></p>
        <p id="energy-err" class="text-xs text-red-500 font-bold mb-2 hidden"></p>
        <div class="flex gap-2 justify-center">
            <button onclick="closeEnergyPopup()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold">ì·¨ì†Œ</button>
            <button onclick="buyEnergy()" class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-bold shadow-md"><span id="energy-price">500</span>ğŸª™ êµ¬ë§¤</button>
        </div>
    </div>
</div>

<div id="sell-popup" class="overlay-bg">
    <div class="overlay-content bg-white p-6 rounded-2xl shadow-xl border-4 border-yellow-400">
        <div class="text-4xl mb-2">ğŸ’°</div><h2 class="text-xl font-bold text-gray-800 mb-2">íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>
        <p id="sell-desc" class="text-sm text-gray-500 mb-4"></p>
        <div class="flex gap-2 justify-center">
            <button onclick="closeOverlay('sell-popup')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold">ì·¨ì†Œ</button>
            <button id="confirm-sell-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-bold shadow-md">íŒë§¤</button>
        </div>
    </div>
</div>

<div id="roulette-popup" class="overlay-bg">
    <div class="overlay-content bg-white p-6 rounded-2xl shadow-xl border-4 border-red-400 w-80 flex flex-col items-center">
        <h2 class="text-2xl font-bold text-rose-500 mb-2">ğŸ”¥ í™”ì¬ ì§„ì•• ë£°ë › ğŸ”¥</h2>
        <div class="relative w-48 h-48 mb-2">
            <div id="roulette-wheel" class="w-full h-full rounded-full border-4 border-gray-700 overflow-hidden relative shadow-lg transition-transform ease-out"></div>
            <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-2 w-4 h-6 bg-red-600 z-10 clip-triangle shadow-sm"></div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 mb-2 relative overflow-hidden">
             <div id="popup-fire-hp-bar" class="h-full bg-red-500 transition-all" style="width: 100%"></div>
             <span id="popup-fire-hp-text" class="absolute inset-0 text-[10px] text-white flex items-center justify-center font-bold"></span>
        </div>
        <p class="text-xs text-yellow-600 font-bold mb-2">ë³´ìœ : <span id="roulette-coin-val">0</span>ğŸª™</p>
        <p id="roulette-err" class="text-xs text-red-500 font-bold mb-2 hidden"></p>
        <div class="flex gap-2 w-full justify-center">
            <button onclick="closeOverlay('roulette-popup')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold">ë‹«ê¸°</button>
            <button id="btn-spin" onclick="startSpin()" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-bold shadow-md"><span>100ğŸª™</span> ë¬¼ ë¿Œë¦¬ê¸°</button>
        </div>
    </div>
</div>

<!-- ë„ê° ëª¨ë‹¬ -->
<div id="guide-modal" class="modal" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
        <h2 id="modal-title" class="text-center text-xl text-gray-700 font-bold mb-4">ë„ê°</h2>
        <div class="tab-container">
            <div id="tab-animal" class="tab-btn active" onclick="switchGuideTab('animal')">ë™ë¬¼</div>
            <div id="tab-snack" class="tab-btn" onclick="switchGuideTab('snack')">ê°„ì‹</div>
            <div id="tab-upgrade" class="tab-btn" onclick="switchGuideTab('upgrade')">ì—…ê·¸ë ˆì´ë“œ</div>
        </div>
        <div id="guide-list-container" class="flex-1 overflow-y-auto min-h-[200px]"></div>
        <div id="upgrade-container" class="hidden flex-col items-center justify-center py-4 space-y-4">
            <div id="upgrade-msg" class="text-center text-gray-400 py-8" style="display:none;">ì—…ê·¸ë ˆì´ë“œ ë¶ˆê°€</div>
            <div id="upgrade-content">
                <div class="text-center">
                    <p class="text-gray-500 text-sm mb-1">í˜„ì¬ ë ˆë²¨</p>
                    <div class="text-3xl font-bold text-rose-500">Lv.<span id="upg-current-lv">1</span></div>
                    <p class="text-xs text-gray-400">í–‰ìš´: <span id="upg-current-luck">5</span>%</p>
                </div>
                <div class="text-2xl text-gray-300 text-center my-2">â¬‡ï¸</div>
                <div class="text-center">
                    <p class="text-gray-500 text-sm mb-1">ë‹¤ìŒ ë ˆë²¨</p>
                    <div class="text-3xl font-bold text-green-500">Lv.<span id="upg-next-lv">2</span></div>
                    <p class="text-xs text-gray-400">í–‰ìš´: <span id="upg-next-luck">6</span>%</p>
                </div>
                <button onclick="upgradeGenerator()" class="bg-blue-500 text-white w-full py-3 rounded-xl font-bold shadow-md mt-4 flex justify-center items-center gap-2"><span>1,000ğŸª™</span> ì—…ê·¸ë ˆì´ë“œ</button>
            </div>
        </div>
        <button onclick="closeModal()" class="w-full mt-4 bg-gray-200 py-2 rounded-lg text-gray-600 font-bold">ë‹«ê¸°</button>
    </div>
</div>

<script>
    console.log('[Script] Loading...');

    // --- ìƒìˆ˜/ë°ì´í„°ëŠ” js/constants.jsì—ì„œ ë¡œë“œë¨ ---
    if (typeof BOARD_SIZE === 'undefined') {
        console.error('[Script] constants.js not loaded!');
        alert('ê²Œì„ ë¡œë“œ ì‹¤íŒ¨: constants.jsë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ë³€ìˆ˜
    let boardState=new Array(BOARD_SIZE).fill(null), storageState=new Array(STORAGE_SIZE).fill(null), apartmentState=new Array(APARTMENT_ROOMS).fill(null), shopItems=new Array(SHOP_SIZE).fill(null);
    for(let i=0;i<STORAGE_SIZE;i++) storageState[i]={type:'locked_storage',cost:(i+1)*5};
    let coins=0, cumulativeCoins=0, nextSpecialTarget=SPECIAL_QUEST_STEP;
    let currentSetRescues=0; // í˜„ì¬ ì„¸íŠ¸ì—ì„œ êµ¬ì¡°í•œ ìˆ˜ (0~3)
    let diamonds=0, energy=MAX_ENERGY, recoveryCountdown=RECOVERY_SEC;
    let userLevel=1, questProgress=0, quests=[], questIdCounter=0, questPage=0, prevReadyCount=0;
    let genLevels={cat:1,dog:1}, dragData=null, currentRouletteRoom=-1, isSpinning=false;
    let currentGuideType='cat', currentGuideTab='animal', sellTarget=null, shopNextRefresh=Date.now()+SHOP_REFRESH_MS;
    let discoveredItems = new Set();
    let newlyDiscoveredItems = new Map(); // key -> timestamp (10ì´ˆê°„ NEW ë±ƒì§€)
    let specialMissionCycles=[0,0,0], isTutorialActive=true;
    // ìƒì‹œ ë¯¸ì…˜: 0=í•©ì„±, 1=ìƒì„±
    let pmType=0, pmProgress=0;
    // ì—ë„ˆì§€ êµ¬ë§¤: 3ì‹œê°„ë§ˆë‹¤ ë¦¬ì…‹, êµ¬ë§¤í•  ë•Œë§ˆë‹¤ 100ì½”ì¸ì”© ì¦ê°€
    let energyPurchaseCount=0, energyPurchaseResetTime=Date.now()+3*60*60*1000;
    // ì´ ì™„ë£Œí•œ ì¼ë°˜ í€˜ìŠ¤íŠ¸ ìˆ˜
    let totalQuestsCompleted=0;

    // DOM (ë‚˜ì¤‘ì— initì—ì„œ ì´ˆê¸°í™”)
    let boardEl, storageEl, apartmentEl, shopGrid;
    let coinEl, diamondEl, energyEl, energyTimerEl;
    let levelEl, questProgEl, questContainer;
    let cumulativeBar, cumulativeText;
    let rescueBar, rescueText, rescueTimerEl;
    let shopTimerBadge, rouletteWheel;
    let tutorialPointer;

    // --- Firebase ì´ˆê¸°í™” ---
    const firebaseConfig = {
        apiKey: "AIzaSyCmca1GswvALHTh_PtNXCJ39VVlje3HUZY",
        authDomain: "merge-game-7cf5f.firebaseapp.com",
        projectId: "merge-game-7cf5f",
        storageBucket: "merge-game-7cf5f.firebasestorage.app",
        messagingSenderId: "400056855947",
        appId: "1:400056855947:web:492180660615c92df6d38e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;
    let currentSessionId = null;

    // ì„¸ì…˜ ID ìƒì„±
    function generateSessionId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // ì„¸ì…˜ ë“±ë¡ (ë¡œê·¸ì¸ ì‹œ)
    async function registerSession() {
        if (!currentUser) return;
        currentSessionId = generateSessionId();
        console.log('[Session] Registering session:', currentSessionId);
        try {
            await db.collection('sessions').doc(currentUser.uid).set({
                sessionId: currentSessionId,
                loginAt: Date.now(),
                device: navigator.userAgent.substring(0, 100)
            });
            console.log('[Session] Session registered successfully');
        } catch (e) {
            console.error('[Session] Registration failed:', e);
        }
    }

    // ì„¸ì…˜ ë¦¬ìŠ¤ë„ˆ (ì‹¤ì‹œê°„ ê°ì§€)
    let sessionUnsubscribe = null;

    // ì‹¤ì‹œê°„ ì„¸ì…˜ ê°ì‹œ ì‹œì‘
    function startSessionListener() {
        if (!currentUser || !currentSessionId) return;

        // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ
        if (sessionUnsubscribe) {
            sessionUnsubscribe();
        }

        console.log('[Session] Starting realtime listener...');
        sessionUnsubscribe = db.collection('sessions').doc(currentUser.uid)
            .onSnapshot((doc) => {
                if (doc.exists && currentSessionId) {
                    const serverSessionId = doc.data().sessionId;
                    if (serverSessionId !== currentSessionId) {
                        console.log('[Session] Different session detected, logging out...');
                        showToast('ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë¡œê·¸ì¸ë˜ì–´ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.');
                        if (sessionUnsubscribe) {
                            sessionUnsubscribe();
                            sessionUnsubscribe = null;
                        }
                        auth.signOut();
                    }
                }
            }, (e) => {
                console.error('[Session] Listener error:', e);
            });
    }

    // ì„¸ì…˜ ë¦¬ìŠ¤ë„ˆ ì¤‘ì§€
    function stopSessionListener() {
        if (sessionUnsubscribe) {
            sessionUnsubscribe();
            sessionUnsubscribe = null;
        }
    }

    // --- Google ë¡œê·¸ì¸ ---
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
    async function startGoogleLogin() {
        console.log('[Auth] startGoogleLogin called');
        document.getElementById('login-status').textContent = 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...';
        document.getElementById('login-status').classList.remove('hidden');
        document.getElementById('google-login-btn').disabled = true;

        try {
            // íŒì—… ë°©ì‹ìœ¼ë¡œ ë¡œê·¸ì¸
            console.log('[Auth] Calling signInWithPopup...');
            const result = await auth.signInWithPopup(googleProvider);
            console.log('[Auth] Popup login success:', result.user.email);
        } catch (e) {
            console.error('[Auth] Login error:', e);
            alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message);
            document.getElementById('login-status').textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
            document.getElementById('google-login-btn').disabled = false;
        }
    }

    // ìƒë‹¨ë°” ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
    async function handleGoogleLogin() {
        if (currentUser) {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await auth.signOut();
            }
        }
    }

    // í™”ë©´ ì „í™˜ í•¨ìˆ˜
    function showLoginScreen() {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('game-container').style.display = 'none';
        document.getElementById('login-status').classList.add('hidden');
        document.getElementById('google-login-btn').disabled = false;
    }

    function showGameScreen() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
    }

    // redirect ê²°ê³¼ ì²˜ë¦¬ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
    auth.getRedirectResult().then((result) => {
        if (result.user) {
            console.log('[Auth] Redirect login success');
        }
    }).catch((e) => {
        console.error('[Auth] Redirect error:', e);
        document.getElementById('login-status').textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        document.getElementById('google-login-btn').disabled = false;
    });

    // ë¡œê·¸ì¸ ìƒíƒœ ë³€ê²½ ê°ì§€
    auth.onAuthStateChanged(async (user) => {
        console.log('[Auth] State changed:', user ? user.email : 'logged out');

        if (user) {
            try {
                currentUser = user;
                const name = user.displayName?.split(' ')[0] || 'ìœ ì €';
                document.getElementById('login-text').innerText = name.length > 3 ? name.substring(0, 3) : name;

                // í•­ìƒ ìƒˆ ì„¸ì…˜ ë“±ë¡ (ë¡œê·¸ì¸ ì‹œë§ˆë‹¤)
                console.log('[Auth] Registering session...');
                await registerSession();
                console.log('[Auth] Session registered OK');

                // ì‹¤ì‹œê°„ ì„¸ì…˜ ê°ì‹œ ì‹œì‘
                startSessionListener();

                // í´ë¼ìš°ë“œì—ì„œ ë°ì´í„° ë¡œë“œ
                console.log('[Auth] Loading from cloud...');
                const loaded = await loadFromCloud();
                console.log('[Auth] Cloud load result:', loaded);

                if (!loaded) {
                    // í´ë¼ìš°ë“œì— ë°ì´í„° ì—†ìœ¼ë©´ ìƒˆ ê²Œì„ ì´ˆê¸°í™”
                    console.log('[Auth] No cloud data, initializing new game');
                    initNewGame();
                }

                // ê²Œì„ í™”ë©´ í‘œì‹œ
                console.log('[Auth] Showing game screen...');
                showGameScreen();
                showToast(`í™˜ì˜í•©ë‹ˆë‹¤, ${user.displayName}!`);

            } catch (e) {
                console.error('[Auth] Login process error:', e);
                alert('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + e.message);
            }
        } else {
            // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
            stopSessionListener();
            currentUser = null;
            currentSessionId = null;
            document.getElementById('login-text').innerText = 'ë¡œê·¸ì¸';
            showLoginScreen();
        }
    });

    // --- ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ---
    function getGameData() {
        return {
            boardState, storageState, apartmentState,
            coins, cumulativeCoins, nextSpecialTarget,
            currentSetRescues, totalQuestsCompleted,
            diamonds, energy, recoveryCountdown,
            userLevel, questProgress, quests, questIdCounter,
            genLevels, shopItems, shopNextRefresh: shopNextRefresh - Date.now(),
            discoveredItems: [...discoveredItems],
            specialMissionCycles, pmType, pmProgress,
            energyPurchaseCount, energyPurchaseResetTime: energyPurchaseResetTime - Date.now(),
            isTutorialActive, savedAt: Date.now()
        };
    }

    function applyGameData(d) {
        boardState = d.boardState || boardState;
        storageState = d.storageState || storageState;
        apartmentState = d.apartmentState || apartmentState;
        coins = d.coins ?? 0;
        cumulativeCoins = d.cumulativeCoins ?? 0;
        nextSpecialTarget = d.nextSpecialTarget ?? SPECIAL_QUEST_STEP;
        currentSetRescues = d.currentSetRescues ?? 0;
        totalQuestsCompleted = d.totalQuestsCompleted ?? 0;
        diamonds = d.diamonds ?? 0;
        energy = d.energy ?? MAX_ENERGY;
        recoveryCountdown = d.recoveryCountdown ?? RECOVERY_SEC;
        userLevel = d.userLevel ?? 1;
        questProgress = d.questProgress ?? 0;
        quests = d.quests || [];
        questIdCounter = d.questIdCounter ?? 0;
        genLevels = d.genLevels || {cat:1, dog:1};
        shopItems = d.shopItems || shopItems;
        shopNextRefresh = Date.now() + (d.shopNextRefresh ?? SHOP_REFRESH_MS);
        discoveredItems = new Set(d.discoveredItems || []);
        specialMissionCycles = d.specialMissionCycles || [0,0,0];
        pmType = d.pmType ?? 0;
        pmProgress = d.pmProgress ?? 0;
        energyPurchaseCount = d.energyPurchaseCount ?? 0;
        energyPurchaseResetTime = Date.now() + (d.energyPurchaseResetTime ?? 3*60*60*1000);
        isTutorialActive = d.isTutorialActive ?? true;

        // 7í–‰ ë¯¸ì…˜ ë³µêµ¬ (v4.1.6 ë§ˆì´ê·¸ë ˆì´ì…˜)
        migrateRow7Missions();
    }

    // 7í–‰ ë¯¸ì…˜ ë§ˆì´ê·¸ë ˆì´ì…˜: ë¯¸ë‹¬ì„± ìƒíƒœì¸ë° ì—´ë ¤ìˆìœ¼ë©´ ë‹¤ì‹œ ì ê¸ˆ
    function migrateRow7Missions() {
        // 30ë²ˆ: ìº£íƒ€ì›Œ Lv.2
        if (genLevels.cat < 2 && (!boardState[30] || boardState[30].type !== 'upgrade_mission')) {
            boardState[30] = { type: 'upgrade_mission', target: 'cat', reqLevel: 2 };
        }
        // 31ë²ˆ: ê°œì§‘ Lv.2
        if (genLevels.dog < 2 && (!boardState[31] || boardState[31].type !== 'upgrade_mission')) {
            boardState[31] = { type: 'upgrade_mission', target: 'dog', reqLevel: 2 };
        }
        // 32ë²ˆ: ì‚¬ì (cat Lv.11)
        const hasCatMax = boardState.some(b => b && b.type === 'cat' && b.level >= 11) ||
                          storageState.some(s => s && s.type === 'cat' && s.level >= 11);
        if (!hasCatMax && (!boardState[32] || boardState[32].type !== 'animal_mission')) {
            boardState[32] = { type: 'animal_mission', target: 'cat', reqLevel: 11 };
        }
        // 33ë²ˆ: ë¶ê·¹ê³° (dog Lv.11)
        const hasDogMax = boardState.some(b => b && b.type === 'dog' && b.level >= 11) ||
                          storageState.some(s => s && s.type === 'dog' && s.level >= 11);
        if (!hasDogMax && (!boardState[33] || boardState[33].type !== 'animal_mission')) {
            boardState[33] = { type: 'animal_mission', target: 'dog', reqLevel: 11 };
        }
        // 34ë²ˆ: í€˜ìŠ¤íŠ¸ 100ê°œ
        if (totalQuestsCompleted < 100 && (!boardState[34] || boardState[34].type !== 'quest_count_mission')) {
            boardState[34] = { type: 'quest_count_mission', reqCount: 100 };
        }
    }

    // í´ë¼ìš°ë“œ ì €ì¥ ë””ë°”ìš´ìŠ¤ (500ms)
    let cloudSaveTimeout = null;
    let cloudSavePromise = null;
    let pendingCloudData = null;

    function saveGame() {
        const data = getGameData();
        localStorage.setItem('mergeGame', JSON.stringify(data));

        // í´ë¼ìš°ë“œ ì €ì¥ (ë””ë°”ìš´ìŠ¤)
        if (currentUser) {
            pendingCloudData = data;
            clearTimeout(cloudSaveTimeout);
            cloudSaveTimeout = setTimeout(() => {
                if (pendingCloudData) {
                    saveToCloud(pendingCloudData);
                    pendingCloudData = null;
                }
            }, 500);
        }
    }

    // ì¦‰ì‹œ í´ë¼ìš°ë“œ ì €ì¥ (ì¤‘ìš”í•œ ì•¡ì…˜ìš©)
    async function saveGameNow() {
        const data = getGameData();
        localStorage.setItem('mergeGame', JSON.stringify(data));
        if (currentUser) {
            clearTimeout(cloudSaveTimeout);
            pendingCloudData = null;
            await saveToCloud(data);
        }
    }

    function updateSaveStatus(status) {
        const el = document.getElementById('save-status');
        if (!el) return;
        el.classList.remove('hidden');
        if (status === 'saving') {
            el.innerText = 'ğŸ’¾â³';
            el.className = 'text-[10px] text-yellow-500';
        } else if (status === 'saved') {
            el.innerText = 'ğŸ’¾âœ“';
            el.className = 'text-[10px] text-green-500';
            setTimeout(() => { el.className = 'text-[10px] text-gray-400'; }, 2000);
        } else if (status === 'error') {
            el.innerText = 'ğŸ’¾âœ—';
            el.className = 'text-[10px] text-red-500';
        } else if (status === 'offline') {
            el.innerText = 'ğŸ“´';
            el.className = 'text-[10px] text-red-500';
        }
    }

    async function saveToCloud(data) {
        if (!currentUser) return;
        if (!navigator.onLine) {
            updateSaveStatus('offline');
            return;
        }
        // ì´ì „ ì €ì¥ì´ ì§„í–‰ ì¤‘ì´ë©´ ëŒ€ê¸°
        if (cloudSavePromise) {
            await cloudSavePromise;
        }
        updateSaveStatus('saving');
        cloudSavePromise = (async () => {
            try {
                await db.collection('saves').doc(currentUser.uid).set(data);
                updateSaveStatus('saved');
            } catch (e) {
                console.error('Cloud save failed:', e);
                // 1íšŒ ì¬ì‹œë„
                try {
                    await db.collection('saves').doc(currentUser.uid).set(data);
                    updateSaveStatus('saved');
                } catch (e2) {
                    console.error('Cloud save retry failed:', e2);
                    updateSaveStatus('error');
                    showToast('í´ë¼ìš°ë“œ ì €ì¥ ì‹¤íŒ¨');
                }
            } finally {
                cloudSavePromise = null;
            }
        })();
        return cloudSavePromise;
    }

    // í´ë¼ìš°ë“œì—ì„œ ë°ì´í„° ë¡œë“œ (í•­ìƒ í´ë¼ìš°ë“œ ìš°ì„ )
    async function loadFromCloud() {
        console.log('[Cloud] Loading from cloud...');
        if (!currentUser) return false;
        try {
            const doc = await db.collection('saves').doc(currentUser.uid).get();
            if (doc.exists) {
                console.log('[Cloud] Data found, applying...');
                const cloudData = doc.data();
                const validatedData = validateGameData(cloudData);
                applyGameData(validatedData);
                localStorage.setItem('mergeGame', JSON.stringify(validatedData));
                updateAll();
                return true;
            }
            console.log('[Cloud] No data found');
            return false;
        } catch (e) {
            console.error('[Cloud] Load failed:', e);
            return false;
        }
    }

    // ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦
    function validateGameData(data) {
        const errors = [];

        // ìˆ«ì í•„ë“œ ê²€ì¦
        const numChecks = [
            ['coins', 0, 9999999],
            ['diamonds', 0, 99999],
            ['energy', 0, MAX_ENERGY],
            ['userLevel', 1, 999],
            ['cumulativeCoins', 0, 9999999],
            ['currentSetRescues', 0, 3],
            ['questProgress', 0, 100],
            ['pmProgress', 0, 200]
        ];

        for (const [key, min, max] of numChecks) {
            if (data[key] !== undefined) {
                if (typeof data[key] !== 'number' || data[key] < min || data[key] > max) {
                    errors.push(`${key}: ë²”ìœ„ ì´ˆê³¼ (${data[key]})`);
                    data[key] = Math.max(min, Math.min(max, Number(data[key]) || min));
                }
            }
        }

        // ë°°ì—´ í•„ë“œ ê²€ì¦
        const arrChecks = [
            ['boardState', BOARD_SIZE],
            ['storageState', STORAGE_SIZE],
            ['apartmentState', APARTMENT_ROOMS],
            ['quests', 10],
            ['shopItems', SHOP_SIZE]
        ];

        for (const [key, maxLen] of arrChecks) {
            if (data[key] && (!Array.isArray(data[key]) || data[key].length > maxLen)) {
                errors.push(`${key}: ë°°ì—´ ì˜¤ë¥˜`);
                if (Array.isArray(data[key])) data[key] = data[key].slice(0, maxLen);
            }
        }

        // íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦ (ë¯¸ë˜ ì‹œê°„ ë°©ì§€)
        if (data.savedAt && data.savedAt > Date.now() + 60000) {
            errors.push('savedAt: ë¯¸ë˜ ì‹œê°„');
            data.savedAt = Date.now();
        }

        if (errors.length > 0) {
            console.warn('ë°ì´í„° ê²€ì¦ ê²½ê³ :', errors);
        }

        return data;
    }

    // --- ìƒˆ ê²Œì„ ì´ˆê¸°í™” (í´ë¼ìš°ë“œì— ë°ì´í„° ì—†ì„ ë•Œ) ---
    function initNewGame() {
        console.log('[Game] Initializing new game...');

        // ë°°ì—´ ì´ˆê¸°í™”
        boardState = new Array(BOARD_SIZE).fill(null);
        storageState = new Array(STORAGE_SIZE).fill(null);
        for(let i=0;i<STORAGE_SIZE;i++) storageState[i]={type:'locked_storage',cost:(i+1)*5};

        // ê¸°ë³¸ ê°’ ì´ˆê¸°í™”
        coins = 0;
        cumulativeCoins = 0;
        diamonds = 0;
        energy = MAX_ENERGY;
        userLevel = 1;
        questProgress = 0;
        quests = [];
        genLevels = {cat:1, dog:1};
        discoveredItems = new Set();
        specialMissionCycles = [0,0,0];
        pmType = 0;
        pmProgress = 0;
        currentSetRescues = 0;

        // ì´ˆê¸° ì¼€ì´ì§€ ë°°ì¹˜
        boardState[0] = { type: 'cat_generator' };
        boardState[4] = { type: 'dog_generator' };

        // 7í–‰ ë¯¸ì…˜
        boardState[30] = { type: 'upgrade_mission', target: 'cat', reqLevel: 2 };
        boardState[31] = { type: 'upgrade_mission', target: 'dog', reqLevel: 2 };
        boardState[32] = { type: 'animal_mission', target: 'cat', reqLevel: 11 }; // ì‚¬ì
        boardState[33] = { type: 'animal_mission', target: 'dog', reqLevel: 11 }; // ë¶ê·¹ê³°
        boardState[34] = { type: 'quest_count_mission', reqCount: 100 }; // í€˜ìŠ¤íŠ¸ 100ê°œ

        // ì•„íŒŒíŠ¸ ì´ˆê¸°í™”
        initApartment();

        // ìƒì  ì´ˆê¸°í™”
        refreshShop();

        // í€˜ìŠ¤íŠ¸ ìƒì„± (6ê°œ)
        for (let i = 0; i < 6; i++) {
            generateNewQuest();
        }

        // ë Œë”ë§ ë° ì €ì¥
        updateAll();
        saveGame();
    }

    // --- ì´ˆê¸°í™” í•¨ìˆ˜ (UI ì…‹ì—…ë§Œ) ---
    function init() {
        // DOM ìš”ì†Œ ì´ˆê¸°í™”
        boardEl = document.getElementById('game-board');
        storageEl = document.getElementById('storage-area');
        apartmentEl = document.getElementById('apartment-area');
        shopGrid = document.getElementById('shop-grid');
        coinEl = document.getElementById('coin-val');
        diamondEl = document.getElementById('diamond-val');
        energyEl = document.getElementById('energy-val');
        energyTimerEl = document.getElementById('energy-timer');
        levelEl = document.getElementById('level-val');
        questProgEl = document.getElementById('quest-progress');
        questContainer = document.getElementById('quest-container');
        cumulativeBar = document.getElementById('cumulative-bar');
        cumulativeText = document.getElementById('cumulative-text');
        rescueBar = document.getElementById('rescue-bar');
        rescueText = document.getElementById('rescue-text');
        rescueTimerEl = document.getElementById('rescue-timer');
        shopTimerBadge = document.getElementById('shop-timer-badge');
        rouletteWheel = document.getElementById('roulette-wheel');
        tutorialPointer = document.getElementById('tutorial-pointer');

        // ë³´ë“œ ì…€ ìƒì„±
        createBoardCells();
        createStorageCells();
        createShopCells();

        // íƒ€ì´ë¨¸ ì‹œì‘
        startEnergyRecovery();
        startShopTimer();
        startAnimalHPTimer();
        startRescueTimer();
        startCooldownTimer();

        // ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë“±ë¡
        document.addEventListener('mousedown', handleDragStart);
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);
        document.addEventListener('touchstart', handleDragStart, { passive: false });
        document.addEventListener('touchmove', handleDragMove, { passive: false });
        document.addEventListener('touchend', handleDragEnd);

        console.log('[Init] Game UI ready');
    }

    function createBoardCells() {
        boardEl.innerHTML = '';
        for (let i = 0; i < BOARD_SIZE; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.zone = 'board';
            cell.dataset.index = i;
            cell.onclick = () => handleCellClick('board', i);
            boardEl.appendChild(cell);
        }
    }

    function createStorageCells() {
        storageEl.innerHTML = '';
        for (let i = 0; i < STORAGE_SIZE; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.zone = 'storage';
            cell.dataset.index = i;
            cell.onclick = () => handleCellClick('storage', i);
            storageEl.appendChild(cell);
        }
    }

    function createShopCells() {
        shopGrid.innerHTML = '';
        for (let i = 0; i < SHOP_SIZE; i++) {
            const cell = document.createElement('div');
            cell.className = 'shop-cell';
            cell.dataset.index = i;
            shopGrid.appendChild(cell);
        }
    }

    // --- ë°œê²¬ ê¸°ë¡ ---
    function discoverItem(type, level) {
        const key = `${type}_${level}`;
        const isNew = !discoveredItems.has(key);
        if (isNew) {
            newlyDiscoveredItems.set(key, Date.now());
        }
        discoveredItems.add(key);
        return isNew;
    }

    // --- í€˜ìŠ¤íŠ¸ í•¨ìˆ˜ ---
    function countEasyQuests() {
        return quests.filter(q => q.reqs.every(r => r.level <= 3)).length;
    }

    function generateNewQuest(forceEasy = false) {
        // ì‰¬ìš´ í€˜ìŠ¤íŠ¸ê°€ 2ê°œ ë¯¸ë§Œì´ë©´ ê°•ì œë¡œ ì‰¬ìš´ í€˜ìŠ¤íŠ¸ ìƒì„±
        const needEasy = forceEasy || countEasyQuests() < 2;
        const npc=NPC_AVATARS[Math.floor(Math.random()*NPC_AVATARS.length)];
        // ë ˆë²¨ë³„ ë‚œì´ë„ ìŠ¤ì¼€ì¼ë§
        const twoItemChance = Math.min(0.3 + userLevel * 0.05, 0.8); // 30%~80%
        const cnt = Math.random() < twoItemChance ? 2 : 1;
        const minLv = needEasy ? 4 : Math.min(Math.max(2, Math.floor(userLevel / 2)), 6);
        const maxLvAnimal = needEasy ? 5 : Math.min(minLv + 3 + Math.floor(userLevel / 4), 10);
        const maxLvSnack = needEasy ? 4 : Math.min(Math.ceil(minLv / 2) + 2, 5);
        const reqs = []; let sc = 0;
        for(let i=0; i<cnt; i++) {
            const isSnack = Math.random() < 0.25;
            const base = Math.random() > 0.5 ? 'cat' : 'dog';
            const type = isSnack ? base + '_snack' : base;
            const min = isSnack ? 2 : minLv;
            const max = isSnack ? maxLvSnack : maxLvAnimal;
            const lv = Math.floor(Math.random() * (max - min + 1)) + min;
            reqs.push({type, level: lv}); sc += (lv * (isSnack ? 15 : 10));
        }
        quests.push({id:questIdCounter++, npc, reqs, reward:20+sc+Math.floor(Math.random()*10)});
        updateQuestUI();
    }

    function updateQuestUI() {
        questContainer.innerHTML=''; const inv={};
        [...boardState,...storageState].forEach(i=>{ if(i&&!i.type.includes('locked')&&!i.type.includes('generator')&&!i.type.includes('mission')) inv[`${i.type}_${i.level}`]=(inv[`${i.type}_${i.level}`]||0)+1; });

        // ì™„ë£Œ ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬ í•¨ìˆ˜
        const canComplete = (q) => {
            const tInv={...inv};
            for(const r of q.reqs) {
                const k=`${r.type}_${r.level}`;
                if(tInv[k]>0) tInv[k]--; else return false;
            }
            return true;
        };

        // ì™„ë£Œ ê°€ëŠ¥í•œ í€˜ìŠ¤íŠ¸ ë¨¼ì € ì •ë ¬
        quests.sort((a, b) => canComplete(b) - canComplete(a));

        // ì™„ë£Œ ê°€ëŠ¥ í€˜ìŠ¤íŠ¸ ìˆ˜ ì²´í¬
        const readyCount = quests.filter(q => canComplete(q)).length;
        // ìƒˆë¡œìš´ ì™„ë£Œ ê°€ëŠ¥ í€˜ìŠ¤íŠ¸ ìƒê¸°ë©´ 1í˜ì´ì§€ë¡œ ìë™ ì´ë™
        if(readyCount > prevReadyCount && questPage > 0) {
            questPage = 0;
        }
        prevReadyCount = readyCount;

        // í˜ì´ì§€ ë²”ìœ„ ì²´í¬
        const maxPage = Math.ceil(quests.length / 3) - 1;
        if (questPage > maxPage) questPage = Math.max(0, maxPage);
        const start = questPage * 3, end = start + 3;

        quests.slice(start, end).forEach((q, idx)=>{
            const i = start + idx;
            const d=document.createElement('div'); d.className='quest-card';
            const ok = canComplete(q);
            if(ok) d.classList.add('ready');
            let h=`<div class="quest-top"><div class="quest-npc">${q.npc}</div><div class="quest-reqs">`;
            q.reqs.forEach(r=>{
                let l; if(r.type==='cat')l=CATS; else if(r.type==='dog')l=DOGS; else if(r.type.includes('snack')) l=r.type.includes('cat')?CAT_SNACKS:DOG_SNACKS;
                h+=`<div class="req-item" title="Lv.${r.level}"><span class="text-lg">${l[r.level-1].emoji}</span></div>`;
            });
            h+=`</div></div><div class="text-[9px] text-yellow-600 mb-1">ë³´ìƒ: ${q.reward}ğŸª™</div><div class="quest-btn ${ok?'complete':'incomplete'}" onclick="${ok?`completeQuest(${i})`:''}">${ok?'ì™„ë£Œ!':'êµ¬í•´ì¤˜'}</div>`;
            d.innerHTML=h; questContainer.appendChild(d);
        });
        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        document.getElementById('quest-prev').disabled = questPage === 0;
        document.getElementById('quest-next').disabled = questPage >= maxPage;
    }

    function scrollQuests(dir) {
        const maxPage = Math.ceil(quests.length / 3) - 1;
        questPage = Math.max(0, Math.min(maxPage, questPage + dir));
        updateQuestUI();
    }

    function completeQuest(i) {
        const q=quests[i], rem=[...q.reqs];
        const delArr=(arr)=>{ for(let j=0; j<arr.length; j++){ if(rem.length===0)break; const it=arr[j]; if(it&&!it.type.includes('locked')&&!it.type.includes('generator')){ const idx=rem.findIndex(r=>r.type===it.type&&r.level===it.level); if(idx!==-1){ arr[j]=null; rem.splice(idx,1); } } } };
        delArr(boardState); if(rem.length>0) delArr(storageState);
        coins+=q.reward; cumulativeCoins+=q.reward; questProgress++; totalQuestsCompleted++; checkAutoCompleteMissions(); showToast(`ì™„ë£Œ! +${q.reward}ì½”ì¸`);
        if(questProgress>=userLevel*2) { userLevel++; questProgress=0; diamonds+=userLevel*5; document.getElementById('levelup-num').innerText=userLevel; document.getElementById('levelup-reward').innerText=userLevel*5; document.getElementById('levelup-overlay').style.display='flex'; }
        quests.splice(i,1); generateNewQuest(); updateAll();
    }

    // --- ì•„ì´í…œ ìƒì„± ---
    function spawnItem(baseType, inputLevel = 1, isFree = false) {
        if(!isFree) { if(energy<=0) { openEnergyPopup(); return; } energy--; updateUI(); updateTimerUI(); }
        const empties=[]; boardState.forEach((v,i)=>{ if(v===null) empties.push(i); });
        if(empties.length===0) { showToast("ê³µê°„ ë¶€ì¡±!"); return; }
        let finalType=baseType, finalLevel=inputLevel, isLucky=false;
        if(inputLevel===1 && (baseType==='cat'||baseType==='dog')) {
            const rand=Math.random(), gl=genLevels[baseType];
            const luckChance = 0.05 + (gl-1)*0.01; // 5%~9%
            if(rand < luckChance) {
                // í–‰ìš´: Lv1â†’2, Lv2â†’3, Lv3+â†’4
                const luckyLv = gl >= 3 ? 4 : gl + 1;
                const isSnack = Math.random() < 0.5; // 50% í™•ë¥ ë¡œ ê°„ì‹
                if(isSnack) { finalType += '_snack'; finalLevel = Math.min(luckyLv, 5); }
                else { finalLevel = luckyLv; }
                isLucky = true;
            } else if(rand < luckChance + SNACK_CHANCE) {
                // ì¼ë°˜ ê°„ì‹ (15%)
                finalType += '_snack'; finalLevel = 1;
            }
        }
        // ìƒì„±ê¸° ìœ„ì¹˜ ì°¾ê¸°
        const genIdx = boardState.findIndex(x => x && x.type === `${baseType}_generator`);
        const genRow = Math.floor(genIdx / GRID_COLS), genCol = genIdx % GRID_COLS;
        // ê±°ë¦¬ìˆœ ì •ë ¬ (ë§¨í•´íŠ¼ ê±°ë¦¬)
        empties.sort((a, b) => {
            const aRow = Math.floor(a / GRID_COLS), aCol = a % GRID_COLS;
            const bRow = Math.floor(b / GRID_COLS), bCol = b % GRID_COLS;
            const aDist = Math.abs(aRow - genRow) + Math.abs(aCol - genCol);
            const bDist = Math.abs(bRow - genRow) + Math.abs(bCol - genCol);
            return aDist - bDist;
        });
        const targetIdx = empties[0];
        boardState[targetIdx]={type:finalType, level:finalLevel};
        discoverItem(finalType, finalLevel);
        addPmProgress(1); // ìƒì„± ë¯¸ì…˜ ì§„í–‰
        renderGrid('board', boardState, boardEl);
        const cell=boardEl.children[targetIdx];
        if(cell&&cell.firstChild) { cell.firstChild.classList.add('pop-anim'); setTimeout(()=>cell.firstChild.classList.remove('pop-anim'),400); }
        // ìƒì„± ìœ„ì¹˜ì— ì´í™íŠ¸
        setTimeout(() => { spawnItemEffect(cell, isLucky); }, 50);
        if(isLucky) { showLuckyEffect(cell); }
    }

    function handleCellClick(zone, idx) {
        const s=zone==='board'?boardState:storageState, it=s[idx]; if(!it)return;
        if(it.type==='locked_board') { if(coins>=UNLOCK_COST_BOARD){ coins-=UNLOCK_COST_BOARD; s[idx]=null; showToast("í•´ì œ!"); updateAll(); } else showToast("ì½”ì¸ë¶€ì¡±"); }
        else if(it.type==='locked_storage') { if(idx>0 && s[idx-1]?.type==='locked_storage') { showToast("ì• ì¹¸ë¶€í„°!"); return; } if(diamonds>=it.cost){ diamonds-=it.cost; s[idx]=null; showToast("í™•ì¥!"); updateAll(); } else showToast("ë‹¤ì´ì•„ë¶€ì¡±"); }
        else if(it.type==='upgrade_mission') {
            const done = genLevels[it.target] >= it.reqLevel;
            if(done) {
                // ë‹¬ì„± ì™„ë£Œ - ì…€ í•´ì œ
                s[idx] = null;
                showToast("ë¯¸ì…˜ ì™„ë£Œ! ì¹¸ í•´ì œ!");
                updateAll();
            } else {
                // ë¯¸ë‹¬ì„± - ì—…ê·¸ë ˆì´ë“œ íƒ­ìœ¼ë¡œ ì´ë™
                openGuide(it.target);
                switchGuideTab('upgrade');
            }
        }
        else if(it.type==='animal_mission') {
            const list = it.target === 'cat' ? CATS : DOGS;
            const targetData = list[it.reqLevel - 1];
            const done = boardState.some(b => b && b.type === it.target && b.level >= it.reqLevel) || storageState.some(st => st && st.type === it.target && st.level >= it.reqLevel);
            if(done) {
                s[idx] = null;
                showToast(`${targetData.name} ë¯¸ì…˜ ì™„ë£Œ! ì¹¸ í•´ì œ!`);
                updateAll();
            } else {
                showToast(`${targetData.name}ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”!`);
            }
        }
        else if(it.type==='quest_count_mission') {
            const done = totalQuestsCompleted >= it.reqCount;
            if(done) {
                s[idx] = null;
                showToast("í€˜ìŠ¤íŠ¸ ë¯¸ì…˜ ì™„ë£Œ! ì¹¸ í•´ì œ!");
                updateAll();
            } else {
                showToast(`í€˜ìŠ¤íŠ¸ ${totalQuestsCompleted}/${it.reqCount} ì™„ë£Œ`);
            }
        }
        else if(it.type.includes('generator')) triggerGen(idx, it);
    }

    function triggerGen(idx, item) {
        const cell=boardEl.children[idx], cage=cell.querySelector('.cage-generator');
        if(cage){
            cage.classList.add('cage-shake');
            setTimeout(()=>cage.classList.remove('cage-shake'),300);
            spawnParticles(cell);
        }
        const baseType=item.type.replace('_generator','');
        if(['bird','fish','reptile'].includes(baseType)) {
            if(item.cooldown>Date.now()){ showToast("ê³¼ì—´!"); return; }
            if(energy<=0) { openEnergyPopup(); return; }
            item.clicks=(item.clicks||0)+1; if(item.clicks>=6){ item.cooldown=Date.now()+60000; item.clicks=0; showToast("ê³¼ì—´! 1ë¶„ íœ´ì‹"); }
            spawnItem(baseType, 1, false);
        } else spawnItem(baseType, 1, false);
    }
    function spawnParticles(cell) {
        const particles = ['âœ¨', 'â­', 'ğŸ’«', 'ğŸŒŸ', 'âœ¦'];
        const rect = cell.getBoundingClientRect();
        for(let i = 0; i < 6; i++) {
            const p = document.createElement('div');
            p.className = 'spawn-particle';
            p.innerText = particles[Math.floor(Math.random() * particles.length)];
            const angle = (i / 6) * Math.PI * 2;
            const dist = 40 + Math.random() * 20;
            p.style.setProperty('--tx', `${Math.cos(angle) * dist}px`);
            p.style.setProperty('--ty', `${Math.sin(angle) * dist}px`);
            p.style.left = `${rect.left + rect.width/2}px`;
            p.style.top = `${rect.top + rect.height/2}px`;
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 600);
        }
    }
    function spawnItemEffect(cell, isLucky) {
        const rect = cell.getBoundingClientRect();
        // ë§ ì´í™íŠ¸
        const ring = document.createElement('div');
        ring.className = 'spawn-ring';
        ring.style.left = `${rect.left + rect.width/2}px`;
        ring.style.top = `${rect.top + rect.height/2}px`;
        if(isLucky) ring.classList.add('lucky');
        document.body.appendChild(ring);
        setTimeout(() => ring.remove(), 500);
        // ì‘ì€ íŒŒí‹°í´
        const sparkles = isLucky ? ['ğŸŒŸ', 'â­', 'âœ¨', 'ğŸ’', 'ğŸ‰'] : ['âœ¨', 'Â·', 'â€¢'];
        const particleCount = isLucky ? 12 : 4;
        for(let i = 0; i < particleCount; i++) {
            const s = document.createElement('div');
            s.className = 'spawn-particle';
            s.innerText = sparkles[Math.floor(Math.random() * sparkles.length)];
            s.style.fontSize = isLucky ? '1.2rem' : '0.6rem';
            const angle = (i / particleCount) * Math.PI * 2 + Math.random() * 0.5;
            const dist = isLucky ? (40 + Math.random() * 30) : (25 + Math.random() * 15);
            s.style.setProperty('--tx', `${Math.cos(angle) * dist}px`);
            s.style.setProperty('--ty', `${Math.sin(angle) * dist}px`);
            s.style.left = `${rect.left + rect.width/2}px`;
            s.style.top = `${rect.top + rect.height/2}px`;
            document.body.appendChild(s);
            setTimeout(() => s.remove(), isLucky ? 700 : 500);
        }
    }

    function showLuckyEffect(cell) {
        // ì…€ ê¸€ë¡œìš°
        cell.classList.add('lucky-glow');
        setTimeout(() => cell.classList.remove('lucky-glow'), 800);
        // í™”ë©´ í”Œë˜ì‹œ
        const flash = document.createElement('div');
        flash.className = 'lucky-flash';
        document.body.appendChild(flash);
        setTimeout(() => flash.remove(), 500);
        // í° Lucky! í…ìŠ¤íŠ¸
        const txt = document.createElement('div');
        txt.className = 'lucky-text';
        txt.innerText = 'âœ¨ Lucky! âœ¨';
        document.body.appendChild(txt);
        setTimeout(() => txt.remove(), 1000);
    }

    // --- ê·¸ë¦¬ë“œ ë Œë”ë§ ---
    function renderGrid(zone, state, cont) {
        const cells=cont.querySelectorAll('.cell');
        cells.forEach((c, i) => {
            if(dragData && dragData.zone===zone && dragData.index===i) return;
            c.className='cell'; c.innerHTML='';
            const item=state[i];
            if(item) {
                if(item.type==='locked_board') { c.classList.add('locked'); c.innerHTML=`<div class="text-xl opacity-50">ğŸ”’</div><div class="text-[8px] font-bold text-gray-500">${UNLOCK_COST_BOARD}ğŸª™</div>`; }
                else if(item.type==='locked_storage') { c.classList.add('storage-locked'); c.innerHTML=`<div class="text-xl">ğŸ”’</div><div class="text-[9px] font-bold mt-1">ğŸ’${item.cost}</div>`; }
                else if(item.type==='upgrade_mission') {
                    const done = genLevels[item.target] >= item.reqLevel;
                    const name = item.target === 'cat' ? 'ìº£íƒ€ì›Œ' : 'ê°œì§‘';
                    c.classList.add('upgrade-mission-cell');
                    if(done) c.classList.add('done');
                    c.innerHTML=`<div class="text-lg">${done ? 'âœ…' : 'ğŸ¯'}</div><div class="text-[8px] font-bold">${name} Lv.${item.reqLevel}</div>`;
                    c.dataset.missionTarget = item.target;
                }
                else if(item.type==='animal_mission') {
                    const list = item.target === 'cat' ? CATS : DOGS;
                    const maxLv = list.length;
                    const targetData = list[item.reqLevel - 1];
                    const done = boardState.some(b => b && b.type === item.target && b.level >= item.reqLevel) || storageState.some(s => s && s.type === item.target && s.level >= item.reqLevel);
                    c.classList.add('upgrade-mission-cell');
                    if(done) c.classList.add('done');
                    c.innerHTML=`<div class="text-lg">${done ? 'âœ…' : targetData.emoji}</div><div class="text-[8px] font-bold">${targetData.name} ë§Œë“¤ê¸°</div>`;
                }
                else if(item.type==='quest_count_mission') {
                    const done = totalQuestsCompleted >= item.reqCount;
                    c.classList.add('upgrade-mission-cell');
                    if(done) c.classList.add('done');
                    c.innerHTML=`<div class="text-lg">${done ? 'âœ…' : 'ğŸ“‹'}</div><div class="text-[8px] font-bold">ì¼ë°˜ í€˜ìŠ¤íŠ¸<br>${totalQuestsCompleted}/${item.reqCount}</div>`;
                }
                else c.appendChild(createItem(item, zone, i));
            }
        });
    }

    function createItem(item, zone, index) {
        if(item.type.includes('generator')) {
            const d=document.createElement('div'); d.className='cage-generator';
            let emoji='ğŸ“¦', label='ì¼€ì´ì§€', type=item.type.replace('_generator','');
            let specialUI='';
            if(['bird','fish','reptile'].includes(type)) {
                const rem=6-(item.clicks||0);
                if(item.cooldown>Date.now()) specialUI=`<div class="cooldown-overlay"><span>ğŸ’¤</span><span>${Math.ceil((item.cooldown-Date.now())/1000)}s</span></div>`;
                else specialUI=`<div class="usage-badge">${rem}/6</div>`;
            }
            if(type==='cat') { emoji='ğŸ±'; label=`ìº£íƒ€ì›Œ (Lv.${genLevels.cat})`; }
            else if(type==='dog') { emoji='ğŸ¶'; label=`ê°œì§‘ (Lv.${genLevels.dog})`; }
            else if(type==='bird') { emoji='ğŸ¦'; label='ìƒˆì¥'; } else if(type==='fish') { emoji='ğŸ '; label='ì–´í•­'; } else if(type==='reptile') { emoji='ğŸ¦'; label='ì‚¬ìœ¡ì¥'; }
            d.innerHTML=`${specialUI}<div class="animal-inside">${emoji}</div><div class="cage-label">${label}</div><div class="help-btn" data-gen-type="${type}">?</div>`;
            return d;
        }
        const d=document.createElement('div'); d.className='item';
        let list, isSnack=item.type.includes('snack');
        if(item.type==='cat') list=CATS; else if(item.type==='dog') list=DOGS;
        else if(item.type==='cat_snack') list=CAT_SNACKS; else if(item.type==='dog_snack') list=DOG_SNACKS;
        else if(item.type==='bird') list=BIRDS; else if(item.type==='fish') list=FISH; else if(item.type==='reptile') list=REPTILES;
        const data=list[item.level-1]||list[list.length-1];
        // NEW ë±ƒì§€ ì²´í¬ (10ì´ˆ ì´ë‚´)
        const itemKey = `${item.type}_${item.level}`;
        const discoveredAt = newlyDiscoveredItems.get(itemKey);
        const isNew = discoveredAt && (Date.now() - discoveredAt < 10000);
        const newBadge = isNew ? '<div class="new-badge">NEW</div>' : '';
        d.innerHTML=`<div class="${isSnack?'bg-square':'bg-circle'}" style="background-color:${data.color}"></div><div style="font-size:${isSnack?'1.5rem':'2rem'}">${data.emoji}</div><div class="level-badge">Lv.${item.level}</div>${newBadge}`;
        const sellBtn=document.createElement('div'); sellBtn.className='sell-btn'; sellBtn.innerText='â“’';
        sellBtn.onclick=(e)=>askSellItem(zone,index,e); d.appendChild(sellBtn);
        return d;
    }

    // --- UI ì—…ë°ì´íŠ¸ ---
    function updateAll() { renderGrid('board',boardState,boardEl); renderGrid('storage',storageState,storageEl); renderShop(); renderApartment(); updateUI(); updateTimerUI(); updateQuestUI(); updateSpecialQuestUI(); updateRescueQuestUI(); updateSpecialMissionUI(); updatePmUI(); saveGame(); }
    function updateUI() { coinEl.innerText=coins.toLocaleString(); diamondEl.innerText=diamonds.toLocaleString(); energyEl.innerText=energy; levelEl.innerText=`Lv.${userLevel}`; questProgEl.innerText=`${questProgress}/${userLevel*2}`; energyEl.className=energy===0?"text-xs font-bold text-red-500":"text-xs font-bold text-yellow-500"; }
    function updateTimerUI() { energyTimerEl.innerText=energy>=MAX_ENERGY?"FULL":`${Math.floor(recoveryCountdown/60)}:${(recoveryCountdown%60).toString().padStart(2,'0')}`; }

    function updateSpecialQuestUI() {
        while(cumulativeCoins>=nextSpecialTarget) { giveSpecialReward(); showMilestonePopup("ëˆ„ì  ì½”ì¸ ëª©í‘œ ë‹¬ì„±!","50 ì½”ì¸"); nextSpecialTarget+=SPECIAL_QUEST_STEP; if(nextSpecialTarget>SPECIAL_QUEST_GOAL){ cumulativeCoins=0; nextSpecialTarget=SPECIAL_QUEST_STEP; showToast("ëˆ„ì  ì½”ì¸ ë¦¬ì…‹!"); break; } }
        const disp=Math.min(cumulativeCoins,SPECIAL_QUEST_GOAL); cumulativeBar.style.width=`${(disp/SPECIAL_QUEST_GOAL)*100}%`; cumulativeText.innerText=`${Math.floor(disp).toLocaleString()} / ${SPECIAL_QUEST_GOAL.toLocaleString()}`;
    }
    function updateRescueQuestUI() {
        // 3ë§ˆë¦¬ ì„¸íŠ¸ ì™„ë£Œ ì‹œ ë³´ìƒ
        if(currentSetRescues >= 3) {
            coins += RESCUE_QUEST_REWARD;
            showToast(`ëª¨ë‘ êµ¬ì¡° ì™„ë£Œ! +${RESCUE_QUEST_REWARD}ì½”ì¸`);
            showMilestonePopup("ëª¨ë‘ êµ¬ì¡° ë‹¬ì„±!", `${RESCUE_QUEST_REWARD} ì½”ì¸`);
            currentSetRescues = 0;
            updateUI();
        }
        // UI ì—…ë°ì´íŠ¸
        rescueBar.style.width = `${(currentSetRescues/3)*100}%`;
        rescueText.innerText = `${currentSetRescues} / 3`;
    }

    // --- ìƒì‹œ ë¯¸ì…˜ ---
    function addPmProgress(type) {
        if(type !== pmType) return; // í˜„ì¬ ë¯¸ì…˜ íƒ€ì…ì´ ì•„ë‹ˆë©´ ë¬´ì‹œ
        pmProgress++;
        if(pmProgress >= PM_GOALS[pmType]) {
            coins += PM_REWARD;
            showToast(`ìƒì‹œ ë¯¸ì…˜ ì™„ë£Œ! +${PM_REWARD}ğŸª™`);
            showMilestonePopup(PM_TITLES[pmType] + " ì™„ë£Œ!", `${PM_REWARD} ì½”ì¸`);
            pmProgress = 0;
            pmType = pmType === 0 ? 1 : 0; // íƒ€ì… ì „í™˜
            updateUI();
        }
        updatePmUI();
    }
    function updatePmUI() {
        const goal = PM_GOALS[pmType];
        document.getElementById('pm-label').innerText = `${PM_ICONS[pmType]} ${PM_TITLES[pmType]}(${PM_REWARD}ğŸª™)`;
        document.getElementById('pm-bar').style.width = `${(pmProgress / goal) * 100}%`;
        document.getElementById('pm-text').innerText = `${pmProgress}/${goal}`;
    }

    // --- ë¯¸ì…˜ ìë™ ì™„ë£Œ ì²´í¬ ---
    function checkAutoCompleteMissions() {
        let changed = false;
        boardState.forEach((item, idx) => {
            if (!item) return;
            if (item.type === 'animal_mission') {
                const hasAnimal = boardState.some(b => b && b.type === item.target && b.level >= item.reqLevel) ||
                                  storageState.some(s => s && s.type === item.target && s.level >= item.reqLevel);
                if (hasAnimal) {
                    const list = item.target === 'cat' ? CATS : DOGS;
                    const targetData = list[item.reqLevel - 1];
                    boardState[idx] = null;
                    showToast(`${targetData.name} ë¯¸ì…˜ ì™„ë£Œ! ì¹¸ í•´ì œ!`);
                    changed = true;
                }
            } else if (item.type === 'quest_count_mission') {
                if (totalQuestsCompleted >= item.reqCount) {
                    boardState[idx] = null;
                    showToast("í€˜ìŠ¤íŠ¸ ë¯¸ì…˜ ì™„ë£Œ! ì¹¸ í•´ì œ!");
                    changed = true;
                }
            }
        });
        return changed;
    }

    // --- ìœ í‹¸ë¦¬í‹° ---
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.opacity='1'; setTimeout(()=>t.style.opacity='0',2000); }
    function showMilestonePopup(t,r){ document.getElementById('milestone-text').innerText=t; document.getElementById('milestone-reward').innerText=r; document.getElementById('milestone-overlay').style.display='flex'; }
    function closeOverlay(id){ document.getElementById(id).style.display='none'; }
    function giveSpecialReward() { coins+=SPECIAL_QUEST_REWARD_COINS; updateUI(); }
    function getEnergyPrice() {
        // 3ì‹œê°„ ë¦¬ì…‹ ì²´í¬
        if (Date.now() >= energyPurchaseResetTime) {
            energyPurchaseCount = 0;
            energyPurchaseResetTime = Date.now() + 3*60*60*1000;
        }
        return 500 + energyPurchaseCount * 100;
    }
    function formatTime(ms) {
        if (ms <= 0) return '00:00:00';
        const h = Math.floor(ms / 3600000);
        const m = Math.floor((ms % 3600000) / 60000);
        const s = Math.floor((ms % 60000) / 1000);
        return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    let energyPopupTimer = null;
    function updateEnergyPopupTimer() {
        const remaining = energyPurchaseResetTime - Date.now();
        document.getElementById('energy-reset-timer').innerText = formatTime(remaining);
        if (remaining <= 0) {
            // ë¦¬ì…‹ ë°œìƒ - ê°€ê²© ì—…ë°ì´íŠ¸
            const price = getEnergyPrice();
            document.getElementById('energy-price').innerText = price;
        }
    }
    function openEnergyPopup() {
        const price = getEnergyPrice();
        document.getElementById('popup-coin-val').innerText=coins.toLocaleString();
        document.getElementById('energy-price').innerText=price;
        updateEnergyPopupTimer();
        document.getElementById('energy-err').classList.add('hidden');
        document.getElementById('energy-popup').style.display='flex';
        // ì‹¤ì‹œê°„ íƒ€ì´ë¨¸ ì‹œì‘
        if (energyPopupTimer) clearInterval(energyPopupTimer);
        energyPopupTimer = setInterval(updateEnergyPopupTimer, 1000);
    }
    function closeEnergyPopup() {
        if (energyPopupTimer) { clearInterval(energyPopupTimer); energyPopupTimer = null; }
        closeOverlay('energy-popup');
    }
    function buyEnergy() {
        const price = getEnergyPrice();
        document.getElementById('energy-err').classList.add('hidden');
        if(coins>=price){
            coins-=price;
            energy=MAX_ENERGY;
            recoveryCountdown=RECOVERY_SEC;
            energyPurchaseCount++;
            closeEnergyPopup();
            showToast("ì¶©ì „ ì™„ë£Œ!");
            updateUI(); updateTimerUI(); saveGame();
        } else {
            document.getElementById('energy-err').innerText="ì½”ì¸ ë¶€ì¡±!";
            document.getElementById('energy-err').classList.remove('hidden');
        }
    }

    // --- ìŠ¤í˜ì…œ ë¯¸ì…˜ ---
    // ìŠ¬ë¡¯ë³„ í™œì„±í™” ë ˆë²¨: ìŠ¬ë¡¯0(ìƒˆ)=3,12,21..., ìŠ¬ë¡¯1(ë¬¼ê³ ê¸°)=6,15,24..., ìŠ¬ë¡¯2(íŒŒì¶©ë¥˜)=9,18,27...
    function getSlotUnlockLevel(slotIdx, cycle) { return (slotIdx + 1) * 3 + cycle * 9; }
    function updateSpecialMissionUI() {
        const types = ['bird', 'fish', 'reptile'];
        for (let i = 0; i < 3; i++) {
            const unlockLv = getSlotUnlockLevel(i, specialMissionCycles[i]);
            const isActive = userLevel >= unlockLv;
            updateSlot(i, isActive, types[i], unlockLv);
        }
    }
    function updateSlot(i, isActive, t, unlockLv) {
        const c = document.getElementById(`sp-mission-${i}`), txt = document.getElementById(`sp-text-${i}`), btn = document.getElementById(`sp-btn-${i}`);
        if (isActive) {
            c.classList.add('active');
            const hasGen = boardState.some(x => x && x.type === `${t}_generator`);
            const hasMax = boardState.some(x => x && x.type === t && x.level === 7);
            // ì¼€ì´ì§€ê°€ ì—†ê³  Lv.7ë„ ì—†ìœ¼ë©´ ìƒì„±
            if (!hasGen && !hasMax) { spawnSpecialGenerator(t); }
            const nameKo = t === 'bird' ? 'ìƒˆ' : t === 'fish' ? 'ë¬¼ê³ ê¸°' : 'íŒŒì¶©ë¥˜';
            if (hasMax) { txt.innerText = "ëª©í‘œë‹¬ì„±!"; btn.style.display = "block"; }
            else { txt.innerText = `Lv.7 ${nameKo}\në§Œë“¤ê¸°`; btn.style.display = "none"; }
        } else {
            c.classList.remove('active');
            txt.innerText = `Lv.${unlockLv}\nì˜¤í”ˆ`;
            btn.style.display = "none";
        }
    }
    function spawnSpecialGenerator(t) { const e=boardState.findIndex(x=>x===null); if(e!==-1){ boardState[e]={type:`${t}_generator`, clicks:0, cooldown:0}; renderGrid('board',boardState,boardEl); showToast("ìŠ¤í˜ì…œ ì¼€ì´ì§€ ë„ì°©!"); } else showToast("ê³µê°„ ë¶€ì¡±!"); }
    function completeSpecialMission(idx) {
        const type=['bird','fish','reptile'][idx]; coins+=500; diamonds+=10; showToast(`ì™„ë£Œ! +500ğŸª™ +10ğŸ’`);
        for(let i=0;i<BOARD_SIZE;i++){ if(boardState[i]&&(boardState[i].type===type||boardState[i].type===`${type}_generator`)) boardState[i]=null; }
        specialMissionCycles[idx]++; // ë‹¤ìŒ ì‚¬ì´í´ë¡œ
        const nextLv = getSlotUnlockLevel(idx, specialMissionCycles[idx]);
        document.getElementById(`sp-text-${idx}`).innerText=`Lv.${nextLv}\nì˜¤í”ˆ`; document.getElementById(`sp-btn-${idx}`).style.display="none";
        for(let i=0;i<SHOP_SIZE;i++){ if(shopItems[i]&&shopItems[i].type.includes(type)) shopItems[i]=generateRandomShopItem(getActiveTypes()); }
        renderShop(); updateAll();
    }

    // --- íŒë§¤ ---
    function askSellItem(z, i, e) {
        e.stopPropagation(); const it=z==='board'?boardState[i]:storageState[i]; if(!it)return;
        sellTarget={zone:z, index:i, item:it}; const p=it.level;
        let list; if(it.type.includes('cat')) list=it.type.includes('snack')?CAT_SNACKS:CATS; else if(it.type.includes('dog')) list=it.type.includes('snack')?DOG_SNACKS:DOGS; else if(it.type.includes('bird')) list=BIRDS; else if(it.type.includes('fish')) list=FISH; else list=REPTILES;
        const n=(list[it.level-1]||list[list.length-1]).name;
        document.getElementById('sell-desc').innerText=`'${n} (Lv.${it.level})' - ${p}ì½”ì¸`;
        document.getElementById('sell-popup').style.display='flex';
    }
    document.getElementById('confirm-sell-btn').onclick=()=>{ if(sellTarget){ const p=sellTarget.item.level; coins+=p; cumulativeCoins+=p; (sellTarget.zone==='board'?boardState:storageState)[sellTarget.index]=null; updateAll(); showToast(`${p}ì½”ì¸ íšë“!`); closeOverlay('sell-popup'); sellTarget=null; } };

    // --- ìƒì  ---
    function startShopTimer(){ setInterval(()=>{ if(Date.now()>=shopNextRefresh) refreshShop(); const d=shopNextRefresh-Date.now(), m=Math.floor(d/60000), s=Math.floor((d%60000)/1000); document.getElementById('shop-timer-badge').innerText=`ê°±ì‹ : ${m}:${s.toString().padStart(2,'0')}`; },1000); }
    function getActiveTypes() { const t=[]; if(boardState.some(i=>i&&i.type==='cat_generator')) t.push('cat'); if(boardState.some(i=>i&&i.type==='dog_generator')) t.push('dog'); ['bird','fish','reptile'].forEach(x=>{ if(boardState.some(i=>i&&i.type===`${x}_generator`)) t.push(x); }); if(t.length===0) t.push('cat','dog'); return t; }
    function refreshShop() { shopNextRefresh=Date.now()+SHOP_REFRESH_MS; const t=getActiveTypes(); for(let i=0;i<SHOP_SIZE-1;i++) shopItems[i]=generateRandomShopItem(t); shopItems[SHOP_SIZE-1]={type:'diamond_pack', amount:10, price:500}; renderShop(); }
    function generateRandomShopItem(types) { const tb=types[Math.floor(Math.random()*types.length)], canSnack=(tb==='cat'||tb==='dog'), isS=canSnack&&Math.random()<0.3, type=isS?`${tb}_snack`:tb, lv=Math.floor(Math.random()*5)+1; return {type,level:lv}; }
    function renderShop() {
        shopGrid.innerHTML=''; shopItems.forEach((item,idx)=>{
            const d=document.createElement('div'); d.className='shop-cell';
            if(item){
                d.onclick=()=>buyShopItem(idx);
                if(item.type==='diamond_pack') {
                    d.innerHTML=`<div class="bg-circle" style="background-color:#67e8f9"></div><div style="font-size:1.2rem">ğŸ’x${item.amount}</div><div class="shop-price-tag" style="color:#fbbf24">ğŸª™${item.price}</div>`;
                } else {
                    let list; if(item.type.includes('cat')) list=item.type.includes('snack')?CAT_SNACKS:CATS; else if(item.type.includes('dog')) list=item.type.includes('snack')?DOG_SNACKS:DOGS; else if(item.type.includes('bird')) list=BIRDS; else if(item.type.includes('fish')) list=FISH; else list=REPTILES;
                    const data=list[item.level-1]||list[list.length-1], isS=item.type.includes('snack');
                    d.innerHTML=`<div class="${isS?'bg-square':'bg-circle'}" style="background-color:${data.color}"></div><div style="font-size:1.2rem">${data.emoji}</div><div class="level-badge">Lv.${item.level}</div><div class="shop-price-tag">ğŸ’${item.level}</div>`;
                }
            } else d.innerHTML=`<span class="text-xs text-gray-400">í’ˆì ˆ</span>`;
            shopGrid.appendChild(d);
        });
    }
    function buyShopItem(idx) {
        const item=shopItems[idx]; if(!item)return;
        // ë‹¤ì´ì•„ íŒ© êµ¬ë§¤
        if(item.type==='diamond_pack') {
            if(coins<item.price){ showToast("ì½”ì¸ ë¶€ì¡±!"); return; }
            coins-=item.price; diamonds+=item.amount;
            showToast(`ğŸ’ +${item.amount} íšë“!`); updateAll(); return;
        }
        // ì¼ë°˜ ì•„ì´í…œ êµ¬ë§¤
        const p=item.level;
        if(diamonds<p){ showToast("ë‹¤ì´ì•„ ë¶€ì¡±!"); return; }
        let tz='board', eIdx=boardState.findIndex(v=>v===null);
        if(eIdx===-1){ const si=storageState.findIndex(v=>v===null); if(si!==-1){ tz='storage'; eIdx=si; } }
        if(eIdx===-1){ showToast("ê³µê°„ ë¶€ì¡±!"); return; }
        diamonds-=p; (tz==='board'?boardState:storageState)[eIdx]={...item};
        discoverItem(item.type, item.level);
        shopItems[idx]=generateRandomShopItem(getActiveTypes()); showToast("êµ¬ë§¤ ì™„ë£Œ!"); updateAll(); renderShop();
    }

    // --- ì•„íŒŒíŠ¸ & ë£°ë › ---
    function initApartment(){
        const emojis = ['ğŸ˜¿', 'ğŸ™€'];
        let assigned = [];
        for(let i=0; i<APARTMENT_ROOMS; i++){
            let emoji;
            // 3ê°œ ëª¨ë‘ ê°™ì€ ì´ëª¨ì§€ ë°©ì§€
            if(i === 2 && assigned[0] === assigned[1]) {
                emoji = assigned[0] === emojis[0] ? emojis[1] : emojis[0];
            } else {
                emoji = emojis[Math.floor(Math.random() * emojis.length)];
            }
            assigned.push(emoji);
            apartmentState[i] = { emoji: emoji, hp: 100, fireHp: 100, rescued: false };
        }
        renderApartment();
    }
    function startAnimalHPTimer(){ setInterval(()=>{ let ch=false; let helpRooms=[]; apartmentState.forEach((r,i)=>{ if(r && !r.rescued){ const prevHp = r.hp; r.hp-=ANIMAL_HP_DECAY; if(Math.floor(prevHp/10) > Math.floor(r.hp/10) && r.hp > 0){ helpRooms.push(i); } if(r.hp<=0){ apartmentState[i]=null; showToast("êµ¬ì¡° ì‹¤íŒ¨..."); } ch=true; } }); if(ch) { const allDoneOrNull = apartmentState.every(x => !x || x.rescued); if(allDoneOrNull && apartmentState.some(x => x === null)) { currentSetRescues=0; setTimeout(()=>{ showToast("ìƒˆ êµ¬ì¡° ìš”ì²­!"); initApartment(); }, 2000); } else { renderApartment(); helpRooms.forEach(i => showHelpBubble(i)); } } }, ANIMAL_HP_DECAY_SEC*1000); }
    function showHelpBubble(roomIdx) {
        const room = apartmentEl.children[roomIdx];
        if(!room) return;
        const bubble = document.createElement('div');
        bubble.className = 'help-bubble';
        bubble.innerText = 'HELP!';
        room.appendChild(bubble);
        setTimeout(() => bubble.remove(), 1500);
    }
    function renderApartment(){
        apartmentEl.innerHTML=''; apartmentState.forEach((r,i)=>{
            const d=document.createElement('div'); d.className='apt-room';
            if(r && r.rescued) {
                d.classList.add('rescued');
                const happyEmoji = r.emoji==='ğŸ˜¿' ? 'ğŸ˜º' : 'ğŸ˜¸';
                d.innerHTML=`<div class="rescued-badge">âœ… êµ¬ì¡° ì™„ë£Œ</div><div class="text-3xl z-10">${happyEmoji}</div>`;
            } else if(r) {
                d.onclick=()=>{ isTutorialActive=false; openRoulette(i); renderApartment(); };
                let html=`<div class="status-badge fire-badge absolute top-1"><span>ğŸ”¥</span><span>${r.fireHp}</span></div><div class="fire-icon">ğŸ”¥</div><div class="text-3xl z-10">${r.emoji}</div><div class="status-badge hp-badge absolute bottom-1"><span>â¤ï¸</span><span>${r.hp}</span></div><div class="fire-overlay"></div>`;
                if(isTutorialActive) html+=`<div class="tutorial-badge">CLICK!</div>`;
                d.innerHTML=html;
            } else {
                d.classList.add('empty');
                d.innerHTML=`<span class="text-gray-500 text-sm">ë¹ˆ ë°©</span>`;
            }
            apartmentEl.appendChild(d);
        });
    }
    function openRoulette(i){ if(isSpinning)return; currentRouletteRoom=i; const r=apartmentState[i]; if(!r)return; currentRotation=0; rouletteWheel.style.transition='none'; rouletteWheel.style.transform='rotate(0deg)'; rouletteWheel.offsetHeight; renderRouletteLabels(); updateRoulettePopupUI(r); document.getElementById('roulette-err').classList.add('hidden'); document.getElementById('roulette-popup').style.display='flex'; }
    function renderRouletteLabels() {
        // ê¸°ì¡´ ë¼ë²¨ ì œê±°
        rouletteWheel.querySelectorAll('.roulette-label').forEach(el => el.remove());
        const radius = 70; // ë¼ë²¨ ìœ„ì¹˜ ë°˜ì§€ë¦„
        ROULETTE_SEGMENTS.forEach((val, idx) => {
            const angle = (idx * 60 + 30) * Math.PI / 180; // ê° ì„¸ê·¸ë¨¼íŠ¸ ì¤‘ì•™ (30ë„ì”© ì˜¤í”„ì…‹)
            const x = 96 + radius * Math.sin(angle); // ì¤‘ì‹¬ 96px ê¸°ì¤€
            const y = 96 - radius * Math.cos(angle);
            const label = document.createElement('div');
            label.className = 'roulette-label';
            label.innerText = val;
            label.style.left = `${x}px`;
            label.style.top = `${y}px`;
            label.style.transform = 'translate(-50%, -50%)';
            rouletteWheel.appendChild(label);
        });
    }
    function updateRoulettePopupUI(r){ const b=document.getElementById('popup-fire-hp-bar'), t=document.getElementById('popup-fire-hp-text'); b.style.width=`${r.fireHp}%`; t.innerText=`${r.fireHp}/100`; document.getElementById('roulette-coin-val').innerText=coins.toLocaleString(); }
    let currentRotation = 0;
    function startSpin(){
        if(isSpinning)return; document.getElementById('roulette-err').classList.add('hidden');
        if(coins<FIRE_EXTINGUISH_COST){ const e=document.getElementById('roulette-err'); e.innerText="ì½”ì¸ ë¶€ì¡±!"; e.classList.remove('hidden'); return; }
        if(currentRouletteRoom===-1||!apartmentState[currentRouletteRoom])return;
        coins-=FIRE_EXTINGUISH_COST; updateUI(); updateRoulettePopupUI(apartmentState[currentRouletteRoom]);
        isSpinning=true;
        const deg=Math.floor(Math.random()*360);
        const spins = 360 * 5; // 5ë°”í€´
        currentRotation += spins + deg;
        rouletteWheel.style.transition='transform 3s cubic-bezier(0.25, 0.1, 0.25, 1)';
        rouletteWheel.style.transform=`rotate(${currentRotation}deg)`;
        setTimeout(()=>finishSpin(currentRotation),3000);
    }
    function finishSpin(angle){
        isSpinning=false; const n=angle%360, p=(360-n)%360, idx=Math.floor(p/60), dmg=ROULETTE_SEGMENTS[idx], r=apartmentState[currentRouletteRoom];
        r.fireHp-=dmg; showToast(`ğŸ”¥ ë¶ˆ ì²´ë ¥ -${dmg}!`);
        if(r.fireHp<=0){
            currentSetRescues++;
            showToast(`êµ¬ì¡° ì„±ê³µ!`);
            r.rescued=true; r.hp=100;
            closeOverlay('roulette-popup'); updateRescueQuestUI();
            const allRescued = apartmentState.every(x => x && x.rescued);
            if(allRescued) setTimeout(()=>{ showToast("ëª¨ë“  ë™ë¬¼ êµ¬ì¡° ì™„ë£Œ! ìƒˆ êµ¬ì¡° ìš”ì²­!"); initApartment(); }, 2000);
        } else {
            updateRoulettePopupUI(r);
        }
        renderApartment(); updateUI(); saveGameNow(); // ì¤‘ìš” ì•¡ì…˜: ì¦‰ì‹œ ì €ì¥
    }

    // --- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ---
    function handleDragStart(e) {
        if(e.target.closest('.help-btn')||e.target.closest('.quest-btn')||e.target.closest('.sp-btn')||e.target.closest('#btn-spin')||e.target.closest('.sell-btn')||e.target.closest('.shop-cell')){ if(e.target.closest('.help-btn')) openGuide(e.target.closest('.help-btn').dataset.genType); e.stopPropagation(); return; }
        const t=e.target.closest('.item, .cage-generator'); if(!t)return;
        const p=t.parentElement; if(p.classList.contains('locked')||p.classList.contains('storage-locked'))return;
        e.preventDefault(); const z=p.dataset.zone, i=parseInt(p.dataset.index);
        dragData={zone:z, index:i, el:t, startX:e.touches?e.touches[0].clientX:e.clientX, startY:e.touches?e.touches[0].clientY:e.clientY};
        const r=t.getBoundingClientRect(); dragData.offsetX=dragData.startX-r.left; dragData.offsetY=dragData.startY-r.top;
        t.style.position='fixed'; t.style.width=r.width+'px'; t.style.height=r.height+'px'; t.style.left=r.left+'px'; t.style.top=r.top+'px'; t.style.zIndex=1000; t.style.pointerEvents='none';
    }
    function handleDragMove(e) {
        if(!dragData)return; e.preventDefault();
        const cx=e.touches?e.touches[0].clientX:e.clientX, cy=e.touches?e.touches[0].clientY:e.clientY;
        dragData.el.style.left=(cx-dragData.offsetX)+'px'; dragData.el.style.top=(cy-dragData.offsetY)+'px';
    }
    function handleDragEnd(e) {
        if(!dragData)return;
        const cx=e.changedTouches?e.changedTouches[0].clientX:e.clientX, cy=e.changedTouches?e.changedTouches[0].clientY:e.clientY;
        if(Math.hypot(cx-dragData.startX, cy-dragData.startY)<5) { dragData.el.style.display=''; handleCellClick(dragData.zone, dragData.index); dragData=null; updateAll(); return; }
        dragData.el.style.display='none'; const el=document.elementFromPoint(cx,cy); dragData.el.style.display='flex';
        const tc=el?el.closest('.cell'):null;
        if(tc) { const tz=tc.dataset.zone, ti=parseInt(tc.dataset.index), ts=tz==='board'?boardState:storageState; if(ts[ti]&&(ts[ti].type.includes('locked'))) showToast("ì ê²¨ìˆìŒ!"); else moveItem(dragData.zone, dragData.index, tz, ti); }
        dragData=null; updateAll();
    }
    function moveItem(fz, fi, tz, ti) {
        if(fz===tz && fi===ti) return;
        const ss=fz==='board'?boardState:storageState, ts=tz==='board'?boardState:storageState; const fIt=ss[fi], tIt=ts[ti];
        if(!tIt) { ts[ti]=fIt; ss[fi]=null; return; }
        if(fIt.type===tIt.type && fIt.level===tIt.level) {
            let max=11; if(fIt.type.includes('snack')) max=5; if(['bird','fish','reptile'].includes(fIt.type)) max=7;
            if(fIt.level<max) { const newLv=fIt.level+1; ts[ti]={type:fIt.type, level:newLv}; ss[fi]=null; discoverItem(fIt.type, newLv); addPmProgress(0); checkAutoCompleteMissions(); const cell=(tz==='board'?boardEl:storageEl).children[ti]; setTimeout(()=>{ showFloatText(cell, "UP!", "#f43f5e"); },50); } else { ts[ti]=fIt; ss[fi]=tIt; }
        } else { ts[ti]=fIt; ss[fi]=tIt; }
    }
    function showFloatText(c,t,col) { if(!c)return; const r=c.getBoundingClientRect(); const d=document.createElement('div'); d.className='floating-text'; d.innerText=t; d.style.color=col; d.style.left=(r.left+r.width/2-10)+'px'; d.style.top=r.top+'px'; document.body.appendChild(d); setTimeout(()=>d.remove(),1000); }

    // --- ë„ê°/ëª¨ë‹¬ ---
    function openGuide(type) {
        currentGuideType = type;
        currentGuideTab = 'animal';
        document.getElementById('guide-modal').classList.add('show');
        switchGuideTab('animal');
    }

    function closeModal() {
        document.getElementById('guide-modal').classList.remove('show');
    }

    function switchGuideTab(tab) {
        currentGuideTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');

        const listContainer = document.getElementById('guide-list-container');
        const upgradeContainer = document.getElementById('upgrade-container');

        if (tab === 'upgrade') {
            listContainer.classList.add('hidden');
            upgradeContainer.classList.remove('hidden');
            upgradeContainer.classList.add('flex');
            updateUpgradeUI();
        } else {
            listContainer.classList.remove('hidden');
            upgradeContainer.classList.add('hidden');
            upgradeContainer.classList.remove('flex');
            renderGuideList(tab);
        }
    }

    function renderGuideList(tab) {
        const container = document.getElementById('guide-list-container');
        let list = [];

        if (tab === 'animal') {
            if (currentGuideType === 'cat') list = CATS;
            else if (currentGuideType === 'dog') list = DOGS;
            else if (currentGuideType === 'bird') list = BIRDS;
            else if (currentGuideType === 'fish') list = FISH;
            else if (currentGuideType === 'reptile') list = REPTILES;
        } else if (tab === 'snack') {
            if (currentGuideType === 'cat' || currentGuideType === 'dog') {
                list = currentGuideType === 'cat' ? CAT_SNACKS : DOG_SNACKS;
            } else {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">ì´ ë™ë¬¼ì€ ê°„ì‹ì´ ì—†ì–´ìš”</div>';
                return;
            }
        }

        // ë°œê²¬í•œ ë™ë¬¼ ì²´í¬ - ì „ì—­ discoveredItems ì‚¬ìš©
        let html = '<div class="guide-list">';
        list.forEach(item => {
            const key = `${currentGuideType}${tab === 'snack' ? '_snack' : ''}_${item.level}`;
            const isDiscovered = discoveredItems.has(key);
            html += `
                <div class="guide-item ${isDiscovered ? '' : 'locked'}">
                    <div class="guide-emoji">${item.emoji}</div>
                    <div class="guide-name">${isDiscovered ? item.name : '???'}</div>
                    <div class="guide-level">Lv.${item.level}</div>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    function updateUpgradeUI() {
        const type = currentGuideType;
        const upgradeContent = document.getElementById('upgrade-content');
        const upgradeMsg = document.getElementById('upgrade-msg');
        if (type !== 'cat' && type !== 'dog') {
            if(upgradeContent) upgradeContent.style.display = 'none';
            if(upgradeMsg) upgradeMsg.style.display = 'block';
            return;
        }
        if(upgradeContent) upgradeContent.style.display = 'block';
        if(upgradeMsg) upgradeMsg.style.display = 'none';
        const currentLv = genLevels[type];
        const nextLv = Math.min(currentLv + 1, CAGE_MAX_LEVEL);
        document.getElementById('upg-current-lv').innerText = currentLv;
        document.getElementById('upg-current-luck').innerText = 5 + (currentLv - 1);
        document.getElementById('upg-next-lv').innerText = nextLv;
        document.getElementById('upg-next-luck').innerText = 5 + (nextLv - 1);
    }

    function upgradeGenerator() {
        const type = currentGuideType;
        if (type !== 'cat' && type !== 'dog') return;
        if (genLevels[type] >= CAGE_MAX_LEVEL) {
            showToast("ìµœëŒ€ ë ˆë²¨!");
            return;
        }
        if (coins < CAGE_UPGRADE_COST) {
            showToast("ì½”ì¸ ë¶€ì¡±!");
            return;
        }
        coins -= CAGE_UPGRADE_COST;
        genLevels[type]++;
        showToast(`${type === 'cat' ? 'ìº£íƒ€ì›Œ' : 'ê°œì§‘'} Lv.${genLevels[type]}!`);
        // ì—…ê·¸ë ˆì´ë“œ ë¯¸ì…˜ ìë™ ì™„ë£Œ
        boardState.forEach((item, idx) => {
            if (item && item.type === 'upgrade_mission' && item.target === type && genLevels[type] >= item.reqLevel) {
                boardState[idx] = null;
                showToast("ë¯¸ì…˜ ì™„ë£Œ! ì¹¸ í•´ì œ!");
            }
        });
        updateUpgradeUI();
        updateAll();
    }

    // --- íƒ€ì´ë¨¸ë“¤ ---
    function startCooldownTimer() { setInterval(() => { let needsUpdate=false; [...boardState, ...storageState].forEach(i => { if (i&&i.type.endsWith('_generator')&&i.cooldown>0&&i.cooldown<=Date.now()){ i.cooldown=0; i.clicks=0; needsUpdate=true; } }); if(needsUpdate) { renderGrid('board', boardState, boardEl); renderGrid('storage', storageState, storageEl); } }, 1000); }
    function startEnergyRecovery() { setInterval(() => { if(energy<MAX_ENERGY) { recoveryCountdown--; if(recoveryCountdown<=0) { energy++; recoveryCountdown=RECOVERY_SEC; updateUI(); } updateTimerUI(); } else { recoveryCountdown=RECOVERY_SEC; updateTimerUI(); } }, 1000); }
    function startRescueTimer() {
        setInterval(() => {
            // êµ¬ì¡°ë˜ì§€ ì•Šì€ ë™ë¬¼ ì¤‘ ê°€ì¥ ë‚®ì€ HP ì°¾ê¸°
            let minHp = Infinity;
            apartmentState.forEach(r => { if(r && !r.rescued && r.hp < minHp) minHp = r.hp; });
            if(minHp === Infinity) { rescueTimerEl.innerText = '--:--'; return; }
            // HPê°€ 0ì´ ë  ë•Œê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚° (HP / ê°ì†ŒëŸ‰ * ê°ì†Œì£¼ê¸°)
            const remainSec = Math.ceil(minHp / ANIMAL_HP_DECAY) * ANIMAL_HP_DECAY_SEC;
            const m = Math.floor(remainSec / 60), s = remainSec % 60;
            rescueTimerEl.innerText = `${m}:${s.toString().padStart(2,'0')}`;
        }, 1000);
    }

    // í˜ì´ì§€ ì´íƒˆ/íƒ­ ì „í™˜ ì‹œ ì¦‰ì‹œ ì €ì¥
    window.addEventListener('beforeunload', () => {
        // localStorageëŠ” ë™ê¸°ì ìœ¼ë¡œ ì¦‰ì‹œ ì €ì¥
        const data = getGameData();
        localStorage.setItem('mergeGame', JSON.stringify(data));
    });

    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            // íƒ­ ë¹„í™œì„±í™” ì‹œ ì¦‰ì‹œ í´ë¼ìš°ë“œ ì €ì¥
            saveGameNow();
        }
    });

    // ì˜¤í”„ë¼ì¸/ì˜¨ë¼ì¸ ê°ì§€
    window.addEventListener('offline', () => {
        updateSaveStatus('offline');
        showToast('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤');
    });
    window.addEventListener('online', () => {
        showToast('ì˜¨ë¼ì¸ ë³µêµ¬! ì €ì¥ ì¤‘...');
        saveGameNow();
    });

    // ê²Œì„ ì‹œì‘
    init();
</script>
</body>
</html>
