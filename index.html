<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê³ ì–‘ì´ & ê°•ì•„ì§€ ë¨¸ì§€ (Ver 3.2.1 - Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Jua', sans-serif; touch-action: pan-y; user-select: none; background-color: #fdf2f8; overflow-y: auto; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        #game-container { width: 100%; max-width: 420px; min-height: 100vh; display: flex; flex-direction: column; gap: 4px; padding: 4px 0; }

        /* 1. ìƒë‹¨ë°” */
        .status-bar { display: flex; align-items: center; gap: 6px; padding: 0 8px; overflow-x: auto; flex-shrink: 0; height: 40px; scrollbar-width: none; }
        .status-item { display: flex; align-items: center; gap: 4px; background: white; padding: 2px 8px; border-radius: 10px; border: 2px solid #e2e8f0; flex-shrink: 0; height: 28px; font-size: 0.8rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* 2. ì´ë²¤íŠ¸ ì§„í–‰ë°” */
        .event-bar { width: 95%; background: white; border-radius: 10px; padding: 4px 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); flex-shrink: 0; display: flex; flex-direction: column; gap: 2px; margin: 0 auto; }
        #special-quest-bar { border: 2px solid #fcd34d; }
        #persistent-mission-bar { display: flex; align-items: center; gap: 8px; background: white; border: 2px solid #a78bfa; border-radius: 8px; padding: 6px 10px; margin-top: 4px; font-size: 0.75rem; font-weight: bold; }
        #pm-label { color: #7c3aed; white-space: nowrap; }
        #pm-progress-wrap { flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        #pm-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #c4b5fd, #8b5cf6); transition: width 0.3s; }
        #pm-text { color: #6b7280; white-space: nowrap; }
        #rescue-quest-bar { border: 2px solid #60a5fa; }
        .progress-track { width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; width: 0%; transition: width 0.5s ease-out; }
        #cumulative-bar { background: linear-gradient(90deg, #fcd34d, #f59e0b); }
        #rescue-bar { background: linear-gradient(90deg, #60a5fa, #2563eb); }
        .milestone-marker { position: absolute; top: 0; bottom: 0; width: 1px; background: rgba(255,255,255,0.8); z-index: 10; }

        /* 3. í€˜ìŠ¤íŠ¸ ì¹´ë“œ */
        #quest-wrapper { width: 100%; display: flex; align-items: center; gap: 4px; padding: 0 4px; flex-shrink: 0; }
        .quest-nav-btn { width: 24px; height: 60px; background: #e2e8f0; border: none; border-radius: 6px; font-size: 1.2rem; color: #64748b; cursor: pointer; flex-shrink: 0; }
        .quest-nav-btn:hover { background: #cbd5e1; }
        .quest-nav-btn:active { background: #94a3b8; }
        .quest-nav-btn:disabled { background: #f1f5f9; color: #cbd5e1; cursor: default; }
        #quest-container { flex: 1; display: flex; gap: 6px; overflow: hidden; }
        .quest-card { background: white; border-radius: 10px; border: 2px solid #e2e8f0; flex: 1; min-width: 0; aspect-ratio: 1.4; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 4px; position: relative; box-shadow: 0 2px 2px rgba(0,0,0,0.05); }
        .quest-card.ready { background-color: #fff1f2; transform: translateY(-2px); animation: rainbow-border 2s linear infinite; }
        @keyframes rainbow-border { 0% { border-color: #ff0000; } 14% { border-color: #ff7f00; } 28% { border-color: #ffff00; } 42% { border-color: #00ff00; } 57% { border-color: #0000ff; } 71% { border-color: #4b0082; } 85% { border-color: #9400d3; } 100% { border-color: #ff0000; } }
        .quest-npc { font-size: 1.1rem; line-height: 1; }
        .quest-reqs { display: flex; gap: 2px; flex-wrap: wrap; justify-content: center; }
        .req-item { font-size: 0.8rem; }
        .quest-btn { width: 100%; padding: 1px 0; border-radius: 4px; font-size: 0.65rem; font-weight: bold; text-align: center; cursor: default; }
        .quest-btn.incomplete { background: #f3f4f6; color: #9ca3af; }
        .quest-btn.complete { background: #f43f5e; color: white; animation: pulse 1.5s infinite; cursor: pointer; }

        /* 4. ë³´ë“œ ë˜í¼ */
        #board-wrapper { width: 95%; display: flex; flex-direction: column; gap: 0; overflow: hidden; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); background: #fbcfe8; position: relative; margin: 0 auto; }

        /* ìŠ¤í˜ì…œ ë¯¸ì…˜ í—¤ë” */
        #special-mission-container { width: 100%; display: flex; gap: 4px; flex-shrink: 0; padding: 4px; background: #f1f5f9; border-bottom: 1px solid #cbd5e1; }
        .sp-mission-card { flex: 1; background: white; border: 2px solid #cbd5e1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4px; height: 70px; opacity: 0.6; transition: all 0.3s; }
        .sp-mission-card.active { opacity: 1; border-color: #8b5cf6; background: #f5f3ff; box-shadow: 0 2px 4px rgba(139, 92, 246, 0.2); }
        .sp-icon { font-size: 1.4rem; }
        .sp-text { font-size: 0.6rem; color: #64748b; text-align: center; line-height: 1.1; }
        .sp-reward-text { font-size: 0.5rem; color: #7c3aed; font-weight: bold; }
        .sp-btn { display: none; margin-top: 2px; background: #8b5cf6; color: white; font-size: 0.6rem; padding: 2px 8px; border-radius: 4px; cursor: pointer; animation: pulse 1s infinite; }

        /* ì•„íŒŒíŠ¸ (í™”ì¬) */
        #apartment-area { background: #cbd5e1; border-top: 4px solid #64748b; border-bottom: 4px solid #64748b; padding: 8px; flex-shrink: 0; display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; position: relative; }
        #apartment-area::before { content: 'ğŸ”¥ êµ¬ì¡° í˜„ì¥ ğŸ”¥'; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #ef4444; color: white; font-size: 0.7rem; padding: 0 8px; border-radius: 4px; font-weight: bold; z-index: 10; }
        .apt-room { background: #334155; border: 2px solid #94a3b8; border-radius: 6px; aspect-ratio: 1.1; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .apt-room.empty { background: #1e293b; opacity: 0.5; cursor: default; }
        .apt-room.rescued { background: linear-gradient(135deg, #86efac, #4ade80); border-color: #22c55e; cursor: default; }
        .rescued-badge { position: absolute; top: 4px; background: #22c55e; color: white; font-size: 0.55rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; z-index: 20; }
        .help-bubble { position: absolute; top: 25%; right: -10px; background: white; color: #ef4444; font-size: 0.6rem; font-weight: bold; padding: 3px 6px; border-radius: 8px; border: 2px solid #ef4444; z-index: 30; animation: bubble-pop 1.5s ease-out forwards; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .help-bubble::after { content: ''; position: absolute; top: 50%; left: -6px; transform: translateY(-50%); border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-right: 6px solid #ef4444; }
        @keyframes bubble-pop { 0% { transform: scale(0); opacity: 0; } 20% { transform: scale(1.2); opacity: 1; } 40% { transform: scale(1); } 80% { opacity: 1; } 100% { opacity: 0; transform: translateY(-10px); } }
        .fire-overlay { position: absolute; inset: 0; background: linear-gradient(0deg, rgba(239,68,68,0.5) 0%, transparent 80%); animation: burn 0.5s infinite alternate; z-index: 5; pointer-events: none; }
        .status-badge { background: white; border-radius: 4px; padding: 1px 4px; font-size: 0.6rem; font-weight: bold; display: flex; align-items: center; gap: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.3); z-index: 20; position: absolute; }
        .fire-badge { top: 2px; color: #ef4444; }
        .hp-badge { bottom: 2px; color: #16a34a; }
        .fire-icon { font-size: 1.2rem; animation: fireFloat 0.5s ease-in-out infinite alternate; z-index: 15; }
        @keyframes fireFloat { 0% { transform: translateY(0) scale(1); } 100% { transform: translateY(-3px) scale(1.1); } }

        /* ë©”ì¸ ë³´ë“œ (ê³ ì •) */
        #scroll-area { padding: 8px; display: flex; flex-direction: column; gap: 8px; }
        .grid-layout { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; width: 100%; }
        #game-board { grid-template-rows: repeat(7, 1fr); }
        #game-board .cell { aspect-ratio: 1 / 1 !important; width: 100%; height: auto; }

        /* ìƒì  */
        #shop-area { background: #fffbeb; border-top: 4px solid #f59e0b; padding: 8px; flex-shrink: 0; z-index: 15; position: relative; }
        #shop-area::before { content: 'ğŸ›’ ìƒì  ğŸ›’'; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #f59e0b; color: white; font-size: 0.7rem; padding: 0 8px; border-radius: 4px; font-weight: bold; z-index: 10; }
        #shop-timer-badge { position: absolute; top: -10px; right: 10px; background: #f59e0b; color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .shop-cell { background: white; border-radius: 8px; border: 1px solid #fde68a; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; aspect-ratio: 1; cursor: pointer; }
        .shop-cell:active { transform: scale(0.95); }
        .shop-price-tag { position: absolute; bottom: 2px; right: 2px; background: rgba(0,0,0,0.7); color: #22d3ee; font-size: 0.6rem; padding: 1px 4px; border-radius: 4px; font-weight: bold; }

        /* ì°½ê³  */
        #storage-area { background: #e2e8f0; border-top: 4px solid #94a3b8; padding: 8px; flex-shrink: 0; z-index: 10; }

        /* ì…€ ê³µí†µ */
        .cell { background: rgba(255, 255, 255, 0.6); border-radius: 8px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; justify-content: center; align-items: center; overflow: hidden; aspect-ratio: 1; }
        .cell.locked { background: rgba(0, 0, 0, 0.15); cursor: pointer; flex-direction: column; }
        .storage-locked { background: repeating-linear-gradient(45deg, #cbd5e1, #cbd5e1 10px, #94a3b8 10px, #94a3b8 20px); display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; color: #475569; text-shadow: 0 1px 0 rgba(255,255,255,0.5); }
        .upgrade-mission-cell { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px dashed #f59e0b; cursor: pointer; flex-direction: column; }
        .upgrade-mission-cell.done { background: linear-gradient(135deg, #d1fae5, #a7f3d0); border: 2px solid #10b981; }

        .item { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; cursor: grab; position: absolute; top: 0; left: 0; z-index: 10; }
        .bg-circle { position: absolute; width: 85%; height: 85%; border-radius: 50%; opacity: 0.5; z-index: -1; }
        .bg-square { position: absolute; width: 80%; height: 80%; border-radius: 20%; opacity: 0.6; z-index: -1; border: 2px dashed rgba(255,255,255,0.5); }
        .level-badge { position: absolute; bottom: 1px; right: 1px; background: rgba(0,0,0,0.6); color: white; font-size: 0.5rem; padding: 0 3px; border-radius: 4px; pointer-events: none; }
        .sell-btn { position: absolute; top: 1px; right: 1px; width: 14px; height: 14px; background: #fbbf24; border: 1px solid #d97706; color: white; border-radius: 50%; font-size: 9px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }

        .cage-generator { width: 95%; height: 95%; background: #f1f5f9; border: 2px solid #64748b; border-radius: 6px; position: relative; display: flex; justify-content: center; align-items: center; font-size: 1.8rem; overflow: hidden; box-shadow: 0 3px 0 #475569; cursor: grab; }
        .cage-generator:active { cursor: grabbing; }
        .cage-generator::after { content: ''; position: absolute; inset: 0; pointer-events: none; z-index: 2; background: repeating-linear-gradient(90deg, transparent, transparent 10px, rgba(100,116,139,0.6) 10px, rgba(100,116,139,0.6) 13px); }
        .cage-label { position: absolute; bottom: 0; width: 100%; background: #64748b; color: white; font-size: 0.5rem; text-align: center; z-index: 3; }
        .animal-inside { z-index: 1; filter: grayscale(0.2); }
        .help-btn { position: absolute; top: 2px; right: 2px; width: 14px; height: 14px; background: white; border: 1px solid #cbd5e1; border-radius: 50%; color: #64748b; font-size: 9px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; }
        .cooldown-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); z-index: 20; color: white; font-size: 0.8rem; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; border-radius: 6px; }
        .usage-badge { position: absolute; top: 2px; left: 2px; background: rgba(0,0,0,0.5); color: white; font-size: 0.5rem; padding: 1px 3px; border-radius: 4px; z-index: 40; pointer-events: none; }

        /* UI ì• ë‹ˆë©”ì´ì…˜ */
        .pop-anim { animation: pop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes pop { 0% {transform: scale(0) rotate(-20deg); opacity: 0;} 50% {transform: scale(1.3) rotate(10deg);} 100% {transform: scale(1) rotate(0deg); opacity: 1;} }
        .spawn-particle { position: absolute; pointer-events: none; font-size: 1rem; animation: particle-burst 0.6s ease-out forwards; z-index: 100; }
        @keyframes particle-burst { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }
        .spawn-ring { position: fixed; pointer-events: none; width: 10px; height: 10px; border: 3px solid #f472b6; border-radius: 50%; transform: translate(-50%, -50%); animation: ring-expand 0.5s ease-out forwards; z-index: 99; }
        .spawn-ring.lucky { border-color: #fbbf24; border-width: 6px; box-shadow: 0 0 20px #fbbf24, 0 0 40px #f59e0b; animation: ring-expand-lucky 0.7s ease-out forwards; }
        @keyframes ring-expand { 0% { width: 10px; height: 10px; opacity: 1; } 100% { width: 60px; height: 60px; opacity: 0; } }
        @keyframes ring-expand-lucky { 0% { width: 10px; height: 10px; opacity: 1; } 100% { width: 100px; height: 100px; opacity: 0; } }
        .lucky-glow { animation: lucky-glow 0.8s ease-out; }
        @keyframes lucky-glow { 0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.8); } 50% { box-shadow: 0 0 30px 15px rgba(251, 191, 36, 0.6); } 100% { box-shadow: none; } }
        .lucky-flash { position: fixed; inset: 0; background: radial-gradient(circle, rgba(251,191,36,0.4) 0%, transparent 70%); pointer-events: none; z-index: 1000; animation: flash-fade 0.5s ease-out forwards; }
        @keyframes flash-fade { 0% { opacity: 1; } 100% { opacity: 0; } }
        .lucky-text { position: fixed; left: 50%; top: 30%; transform: translate(-50%, -50%); font-size: 3rem; font-weight: bold; color: #fbbf24; text-shadow: 0 0 10px #f59e0b, 0 0 20px #fbbf24, 2px 2px 0 #92400e; pointer-events: none; z-index: 1001; animation: lucky-text-anim 1s ease-out forwards; }
        @keyframes lucky-text-anim { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 30% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; } 50% { transform: translate(-50%, -50%) scale(1); } 100% { transform: translate(-50%, -50%) translateY(-30px); opacity: 0; } }
        .cage-shake { animation: cage-shake 0.3s ease-in-out; }
        @keyframes cage-shake { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-4px) rotate(-2deg); } 40% { transform: translateX(4px) rotate(2deg); } 60% { transform: translateX(-3px) rotate(-1deg); } 80% { transform: translateX(3px) rotate(1deg); } }
        .floating-text { position: absolute; font-weight: bold; font-size: 1.2rem; pointer-events: none; animation: floatUp 1s forwards; z-index: 100; }
        @keyframes floatUp { 0% {transform: translateY(0); opacity: 1;} 100% {transform: translateY(-50px); opacity: 0;} }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        @keyframes burn { 0% { opacity: 0.5; } 100% { opacity: 0.8; } }

        /* íŠœí† ë¦¬ì–¼ */
        .tutorial-badge { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #ef4444; color: white; font-weight: bold; font-size: 0.8rem; padding: 4px 8px; border-radius: 20px; box-shadow: 0 0 10px rgba(239, 68, 68, 0.8); animation: pulse-scale 1s infinite; z-index: 50; pointer-events: none; white-space: nowrap; }
        @keyframes pulse-scale { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.1); } }

        /* ì˜¤ë²„ë ˆì´ */
        .overlay-bg { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .overlay-content { animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 80%; max-width: 300px; }

        /* í† ìŠ¤íŠ¸ */
        #toast { position: fixed; bottom: 32px; background: #1f2937; color: white; padding: 8px 16px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; pointer-events: none; z-index: 3000; opacity: 0; transition: opacity 0.3s; }

        .clip-triangle { clip-path: polygon(50% 100%, 0 0, 100% 0); }

        /* ë„ê° ëª¨ë‹¬ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2500; display: none; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 16px; padding: 16px; width: 90%; max-width: 320px; max-height: 80vh; display: flex; flex-direction: column; animation: pop 0.3s ease-out; }
        .tab-container { display: flex; gap: 4px; margin-bottom: 12px; }
        .tab-btn { flex: 1; padding: 8px 4px; border-radius: 8px; background: #f1f5f9; color: #64748b; font-size: 0.75rem; font-weight: bold; text-align: center; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { background: #f43f5e; color: white; }
        .guide-list { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .guide-item { display: flex; flex-direction: column; align-items: center; padding: 8px 4px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
        .guide-item.locked { opacity: 0.4; filter: grayscale(1); }
        .guide-emoji { font-size: 1.5rem; }
        .guide-name { font-size: 0.6rem; color: #475569; margin-top: 2px; }
        .guide-level { font-size: 0.5rem; color: #94a3b8; }

        /* ë£°ë › íœ  */
        #roulette-wheel {
            background: conic-gradient(
                #dbeafe 0deg 60deg,
                #3b82f6 60deg 120deg,
                #93c5fd 120deg 180deg,
                #60a5fa 180deg 240deg,
                #1d4ed8 240deg 300deg,
                #1e3a8a 300deg 360deg
            );
        }
        .roulette-label { position: absolute; font-size: 0.7rem; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); transform-origin: center center; pointer-events: none; }
    </style>
</head>
<body>

<div id="game-container">
    <!-- ìƒíƒœë°” -->
    <div class="status-bar">
        <h1 class="text-sm font-bold text-rose-500 mr-1 flex-shrink-0">ë©ëƒ¥ ë¨¸ì§€</h1>
        <div class="status-item border-yellow-300">
            <span class="text-xs">âš¡</span>
            <div class="flex flex-col leading-none">
                <span id="energy-val" class="text-xs font-bold text-yellow-500">100</span>
                <span id="energy-timer" class="text-[8px] text-gray-400 font-mono">FULL</span>
            </div>
        </div>
        <div class="status-item border-yellow-500"><span class="text-xs">ğŸª™</span><span id="coin-val" class="text-xs text-yellow-600 font-bold">0</span></div>
        <div class="status-item border-cyan-400"><span class="text-xs">ğŸ’</span><span id="diamond-val" class="text-xs text-cyan-600 font-bold">0</span></div>
        <div class="status-item border-purple-400">
            <div class="flex flex-col items-center leading-none">
                <span id="level-val" class="text-xs font-bold text-purple-600">Lv.1</span>
                <span id="quest-progress" class="text-[8px] text-gray-500 font-bold mt-0.5">0/3</span>
            </div>
        </div>
        <button id="login-btn" onclick="handleGoogleLogin()" class="status-item border-blue-400 cursor-pointer hover:bg-blue-50">
            <span class="text-xs">ğŸ”‘</span><span id="login-text" class="text-xs text-blue-600 font-bold">ë¡œê·¸ì¸</span>
        </button>
    </div>

    <!-- 1. ëˆ„ì  í€˜ìŠ¤íŠ¸ -->
    <div id="special-quest-bar" class="event-bar">
        <div class="flex justify-between items-end mb-1">
            <span class="text-[10px] font-bold text-gray-600">ğŸ‘‘ ëˆ„ì  ì½”ì¸ (ì¹¸ë§ˆë‹¤ 50ğŸª™)</span>
            <span id="cumulative-text" class="text-[9px] text-yellow-600 font-bold">0 / 200</span>
        </div>
        <div class="progress-track">
            <div id="cumulative-bar" class="progress-fill"></div>
            <div class="milestone-marker" style="left: 20%"></div><div class="milestone-marker" style="left: 40%"></div><div class="milestone-marker" style="left: 60%"></div><div class="milestone-marker" style="left: 80%"></div>
        </div>
    </div>

    <!-- 2. ì¼ë°˜ í€˜ìŠ¤íŠ¸ -->
    <div id="quest-wrapper">
        <button id="quest-prev" class="quest-nav-btn" onclick="scrollQuests(-1)">â€¹</button>
        <div id="quest-container"></div>
        <button id="quest-next" class="quest-nav-btn" onclick="scrollQuests(1)">â€º</button>
    </div>

    <div id="board-wrapper">
        <!-- 3. ë§µ -->
        <div id="scroll-area">
            <div id="game-board" class="grid-layout"></div>
            <!-- 4. ìƒì‹œ ë¯¸ì…˜ -->
            <div id="persistent-mission-bar">
                <span id="pm-label">ğŸ”¨ 100ë²ˆ í•©ì„±í•˜ê¸°(100ğŸª™)</span>
                <div id="pm-progress-wrap"><div id="pm-bar"></div></div>
                <span id="pm-text">0/100</span>
            </div>
        </div>

        <!-- 5. ìŠ¤í˜ì…œ í€˜ìŠ¤íŠ¸ (ìƒˆ/ë¬¼ê³ ê¸°/íŒŒì¶©ë¥˜) -->
        <div id="special-mission-container">
            <div id="sp-mission-0" class="sp-mission-card"><div class="sp-icon">ğŸ¦</div><div id="sp-text-0" class="sp-text">Lv.3<br>ì˜¤í”ˆ</div><div class="sp-reward-text">ë³´ìƒ: 500ğŸª™ 10ğŸ’</div><div id="sp-btn-0" class="sp-btn" onclick="completeSpecialMission(0)">ì™„ë£Œ!</div></div>
            <div id="sp-mission-1" class="sp-mission-card"><div class="sp-icon">ğŸ </div><div id="sp-text-1" class="sp-text">Lv.6<br>ì˜¤í”ˆ</div><div class="sp-reward-text">ë³´ìƒ: 500ğŸª™ 10ğŸ’</div><div id="sp-btn-1" class="sp-btn" onclick="completeSpecialMission(1)">ì™„ë£Œ!</div></div>
            <div id="sp-mission-2" class="sp-mission-card"><div class="sp-icon">ğŸ¦</div><div id="sp-text-2" class="sp-text">Lv.9<br>ì˜¤í”ˆ</div><div class="sp-reward-text">ë³´ìƒ: 500ğŸª™ 10ğŸ’</div><div id="sp-btn-2" class="sp-btn" onclick="completeSpecialMission(2)">ì™„ë£Œ!</div></div>
        </div>

        <!-- 6. êµ¬ì¡° í˜„ì¥ -->
        <div id="rescue-quest-bar" class="event-bar" style="margin:4px 10px;">
            <div class="flex justify-between items-end mb-1">
                <span class="text-[10px] font-bold text-blue-600">ğŸš‘ ëª¨ë‘ êµ¬ì¡° (500ğŸª™)</span>
                <div class="flex items-center gap-2">
                    <span id="rescue-timer" class="text-[9px] text-red-500 font-mono font-bold">59:59</span>
                    <span id="rescue-text" class="text-[9px] text-blue-500 font-bold">0 / 15</span>
                </div>
            </div>
            <div class="progress-track">
                <div id="rescue-bar" class="progress-fill"></div>
                <div class="milestone-marker" style="left: 33.33%"></div><div class="milestone-marker" style="left: 66.67%"></div>
            </div>
        </div>
        <div id="apartment-area"></div>

        <!-- 7. ìƒì  -->
        <div id="shop-area">
            <div id="shop-timer-badge">ê°±ì‹ : 05:00</div>
            <div class="grid-layout" id="shop-grid"></div>
        </div>

        <!-- 8. ì°½ê³  -->
        <div id="storage-area" class="grid-layout"></div>

        <div id="tutorial-pointer" class="hidden">ğŸ‘†</div>
    </div>
</div>

<!-- íŒì—…ë“¤ -->
<div id="toast"></div>

<div id="levelup-overlay" class="overlay-bg">
    <div class="overlay-content">
        <div class="text-6xl mb-4">ğŸ‰</div><h2 class="text-3xl font-bold text-rose-500 mb-2">LEVEL UP!</h2>
        <p class="text-xl text-gray-600 mb-4">Lv.<span id="levelup-num">2</span> ë‹¬ì„±!</p>
        <div class="bg-cyan-100 text-cyan-700 px-6 py-3 rounded-xl font-bold text-lg mb-6">ğŸ’ +<span id="levelup-reward">5</span></div>
        <button onclick="closeOverlay('levelup-overlay')" class="bg-rose-500 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-rose-600">í™•ì¸</button>
    </div>
</div>

<div id="milestone-overlay" class="overlay-bg">
    <div class="overlay-content">
        <div class="text-6xl mb-4">ğŸŠ</div><h2 class="text-3xl font-bold text-yellow-500 mb-2">ëª©í‘œ ë‹¬ì„±!</h2>
        <p id="milestone-text" class="text-xl text-gray-600 mb-4"></p>
        <div class="bg-yellow-100 text-yellow-700 px-6 py-3 rounded-xl font-bold text-lg mb-6">ë³´ìƒ: <span id="milestone-reward"></span></div>
        <button onclick="closeOverlay('milestone-overlay')" class="bg-yellow-500 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-yellow-600">ë©‹ì ¸ìš”!</button>
    </div>
</div>

<div id="energy-popup" class="overlay-bg">
    <div class="overlay-content bg-white p-6 rounded-2xl shadow-xl border-4 border-yellow-300">
        <div class="text-5xl mb-3">âš¡</div><h2 class="text-2xl font-bold text-gray-800 mb-2">ì—ë„ˆì§€ ë¶€ì¡±!</h2>
        <p class="text-sm text-gray-500 mb-2">ì—ë„ˆì§€ 100ê°œ ì¶©ì „</p>
        <p class="text-xs text-yellow-600 font-bold mb-4">ë³´ìœ : <span id="popup-coin-val">0</span>ğŸª™</p>
        <p id="energy-err" class="text-xs text-red-500 font-bold mb-2 hidden"></p>
        <div class="flex gap-2 justify-center">
            <button onclick="closeOverlay('energy-popup')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold">ì·¨ì†Œ</button>
            <button onclick="buyEnergy()" class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-bold shadow-md"><span>500ğŸª™</span> êµ¬ë§¤</button>
        </div>
    </div>
</div>

<div id="sell-popup" class="overlay-bg">
    <div class="overlay-content bg-white p-6 rounded-2xl shadow-xl border-4 border-yellow-400">
        <div class="text-4xl mb-2">ğŸ’°</div><h2 class="text-xl font-bold text-gray-800 mb-2">íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>
        <p id="sell-desc" class="text-sm text-gray-500 mb-4"></p>
        <div class="flex gap-2 justify-center">
            <button onclick="closeOverlay('sell-popup')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold">ì·¨ì†Œ</button>
            <button id="confirm-sell-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-bold shadow-md">íŒë§¤</button>
        </div>
    </div>
</div>

<div id="roulette-popup" class="overlay-bg">
    <div class="overlay-content bg-white p-6 rounded-2xl shadow-xl border-4 border-red-400 w-80 flex flex-col items-center">
        <h2 class="text-2xl font-bold text-rose-500 mb-2">ğŸ”¥ í™”ì¬ ì§„ì•• ë£°ë › ğŸ”¥</h2>
        <div class="relative w-48 h-48 mb-2">
            <div id="roulette-wheel" class="w-full h-full rounded-full border-4 border-gray-700 overflow-hidden relative shadow-lg transition-transform ease-out"></div>
            <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-2 w-4 h-6 bg-red-600 z-10 clip-triangle shadow-sm"></div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 mb-2 relative overflow-hidden">
             <div id="popup-fire-hp-bar" class="h-full bg-red-500 transition-all" style="width: 100%"></div>
             <span id="popup-fire-hp-text" class="absolute inset-0 text-[10px] text-white flex items-center justify-center font-bold"></span>
        </div>
        <p class="text-xs text-yellow-600 font-bold mb-2">ë³´ìœ : <span id="roulette-coin-val">0</span>ğŸª™</p>
        <p id="roulette-err" class="text-xs text-red-500 font-bold mb-2 hidden"></p>
        <div class="flex gap-2 w-full justify-center">
            <button onclick="closeOverlay('roulette-popup')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold">ë‹«ê¸°</button>
            <button id="btn-spin" onclick="startSpin()" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-bold shadow-md"><span>100ğŸª™</span> ë¬¼ ë¿Œë¦¬ê¸°</button>
        </div>
    </div>
</div>

<!-- ë„ê° ëª¨ë‹¬ -->
<div id="guide-modal" class="modal" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
        <h2 id="modal-title" class="text-center text-xl text-gray-700 font-bold mb-4">ë„ê°</h2>
        <div class="tab-container">
            <div id="tab-animal" class="tab-btn active" onclick="switchGuideTab('animal')">ë™ë¬¼</div>
            <div id="tab-snack" class="tab-btn" onclick="switchGuideTab('snack')">ê°„ì‹</div>
            <div id="tab-upgrade" class="tab-btn" onclick="switchGuideTab('upgrade')">ì—…ê·¸ë ˆì´ë“œ</div>
        </div>
        <div id="guide-list-container" class="flex-1 overflow-y-auto min-h-[200px]"></div>
        <div id="upgrade-container" class="hidden flex-col items-center justify-center py-4 space-y-4">
            <div id="upgrade-msg" class="text-center text-gray-400 py-8" style="display:none;">ì—…ê·¸ë ˆì´ë“œ ë¶ˆê°€</div>
            <div id="upgrade-content">
                <div class="text-center">
                    <p class="text-gray-500 text-sm mb-1">í˜„ì¬ ë ˆë²¨</p>
                    <div class="text-3xl font-bold text-rose-500">Lv.<span id="upg-current-lv">1</span></div>
                    <p class="text-xs text-gray-400">í–‰ìš´: <span id="upg-current-luck">5</span>%</p>
                </div>
                <div class="text-2xl text-gray-300 text-center my-2">â¬‡ï¸</div>
                <div class="text-center">
                    <p class="text-gray-500 text-sm mb-1">ë‹¤ìŒ ë ˆë²¨</p>
                    <div class="text-3xl font-bold text-green-500">Lv.<span id="upg-next-lv">2</span></div>
                    <p class="text-xs text-gray-400">í–‰ìš´: <span id="upg-next-luck">6</span>%</p>
                </div>
                <button onclick="upgradeGenerator()" class="bg-blue-500 text-white w-full py-3 rounded-xl font-bold shadow-md mt-4 flex justify-center items-center gap-2"><span>1,000ğŸª™</span> ì—…ê·¸ë ˆì´ë“œ</button>
            </div>
        </div>
        <button onclick="closeModal()" class="w-full mt-4 bg-gray-200 py-2 rounded-lg text-gray-600 font-bold">ë‹«ê¸°</button>
    </div>
</div>

<script>
    // --- ìƒìˆ˜ ì •ì˜ ---
    const GRID_COLS=5, GRID_ROWS=7, BOARD_SIZE=35, STORAGE_SIZE=5, APARTMENT_ROOMS=3;
    const SHOP_SIZE=5, SHOP_REFRESH_MS=300000;
    const MAX_ENERGY=100, RECOVERY_SEC=30, UNLOCK_COST_BOARD=100, SNACK_CHANCE=0.15;
    const SPECIAL_QUEST_GOAL=1000, SPECIAL_QUEST_STEP=200, SPECIAL_QUEST_REWARD_COINS=50;
    const ENERGY_COST=500, CAGE_UPGRADE_COST=1000, CAGE_MAX_LEVEL=5;
    const RESCUE_QUEST_REWARD=500; // 3ë§ˆë¦¬ ì„¸íŠ¸ ì™„ë£Œ ë³´ìƒ
    const ANIMAL_HP_DECAY=2, ANIMAL_HP_DECAY_SEC=10, FIRE_EXTINGUISH_COST=100, FIRE_EXTINGUISH_REWARD=100;
    const ROULETTE_SEGMENTS=[0,70,30,50,90,100], ROULETTE_COLORS=['#dbeafe','#3b82f6','#93c5fd','#60a5fa','#1d4ed8','#1e3a8a'];
    const NPC_AVATARS=["ğŸ‘©â€ğŸŒ¾","ğŸ‘¨â€ğŸ³","ğŸ‘®â€â™€ï¸","ğŸ§™â€â™‚ï¸","ğŸ‘¸","ğŸ•µï¸â€â™‚ï¸","ğŸ…","ğŸ§‘â€ğŸš€","ğŸ‘¨â€ğŸ¨","ğŸ¦¸â€â™€ï¸"];

    // ë°ì´í„°
    const CATS=[{level:1,emoji:"ğŸ±",name:"ì•„ê¸° ëƒ¥ì´",color:"#fecdd3"},{level:2,emoji:"ğŸˆ",name:"ì–¼ë£© ëƒ¥ì´",color:"#a3e635"},{level:3,emoji:"ğŸˆâ€â¬›",name:"ê²€ì€ ëƒ¥ì´",color:"#a1a1aa"},{level:4,emoji:"ğŸ˜¹",name:"ì›ƒìŒ ëƒ¥ì´",color:"#38bdf8"},{level:5,emoji:"ğŸ˜¾",name:"ë¾°ë¡œí†µ ëƒ¥ì´",color:"#fb923c"},{level:6,emoji:"ğŸ˜»",name:"ì‚¬ë‘ ëƒ¥ì´",color:"#f472b6"},{level:7,emoji:"ğŸ˜¼",name:"ì‹œí¬ ëƒ¥ì´",color:"#a78bfa"},{level:8,emoji:"ğŸ™€",name:"ê¹œì§ ëƒ¥ì´",color:"#fde047"},{level:9,emoji:"ğŸ˜½",name:"ë½€ë½€ ëƒ¥ì´",color:"#2dd4bf"},{level:10,emoji:"ğŸ¯",name:"í˜¸ë‘ì´",color:"#fbbf24"},{level:11,emoji:"ğŸ¦",name:"ì‚¬ì ì™•",color:"#ef4444"}];
    const DOGS=[{level:1,emoji:"ğŸ¶",name:"ì•„ê¸° ë©ë©",color:"#fecdd3"},{level:2,emoji:"ğŸ•",name:"ëˆ„ë ì´",color:"#fcd34d"},{level:3,emoji:"ğŸ©",name:"í‘¸ë“¤",color:"#e9d5ff"},{level:4,emoji:"ğŸ¦®",name:"ì•ˆë‚´ê²¬",color:"#86efac"},{level:5,emoji:"ğŸ•â€ğŸ¦º",name:"ë“¬ì§ê²¬",color:"#38bdf8"},{level:6,emoji:"ğŸº",name:"ëŠ‘ëŒ€",color:"#94a3b8"},{level:7,emoji:"ğŸ¦Š",name:"ì—¬ìš°",color:"#fb923c"},{level:8,emoji:"ğŸ¦",name:"ë„ˆêµ¬ë¦¬",color:"#a78bfa"},{level:9,emoji:"ğŸ¼",name:"íŒ¬ë”",color:"#1e293b"},{level:10,emoji:"ğŸ»",name:"ê³°ëŒì´",color:"#92400e"},{level:11,emoji:"ğŸ»â€â„ï¸",name:"ë¶ê·¹ê³°",color:"#e0f2fe"}];
    const BIRDS=[{level:1,emoji:"ğŸ£",name:"ì•„ê¸°ìƒˆ",color:"#bae6fd"},{level:2,emoji:"ğŸ¤",name:"ë³‘ì•„ë¦¬",color:"#fde047"},{level:3,emoji:"ğŸ¦",name:"íŒŒë‘ìƒˆ",color:"#60a5fa"},{level:4,emoji:"ğŸ•Šï¸",name:"ë¹„ë‘˜ê¸°",color:"#e2e8f0"},{level:5,emoji:"ğŸ¦¢",name:"ë°±ì¡°",color:"#f8fafc"},{level:6,emoji:"ğŸ¦…",name:"ë…ìˆ˜ë¦¬",color:"#78350f"},{level:7,emoji:"ğŸ¦š",name:"ê³µì‘",color:"#10b981"}];
    const FISH=[{level:1,emoji:"ğŸŸ",name:"ì†¡ì‚¬ë¦¬",color:"#bae6fd"},{level:2,emoji:"ğŸ ",name:"ì—´ëŒ€ì–´",color:"#fde047"},{level:3,emoji:"ğŸ¡",name:"ë³µì–´",color:"#fbbf24"},{level:4,emoji:"ğŸ¦‘",name:"ì˜¤ì§•ì–´",color:"#f87171"},{level:5,emoji:"ğŸ™",name:"ë¬¸ì–´",color:"#ef4444"},{level:6,emoji:"ğŸ¦ˆ",name:"ìƒì–´",color:"#94a3b8"},{level:7,emoji:"ğŸ³",name:"ê³ ë˜",color:"#3b82f6"}];
    const REPTILES=[{level:1,emoji:"ğŸ¸",name:"ê°œêµ¬ë¦¬",color:"#86efac"},{level:2,emoji:"ğŸ¦",name:"ë„ë§ˆë±€",color:"#4ade80"},{level:3,emoji:"ğŸ",name:"ë±€",color:"#16a34a"},{level:4,emoji:"ğŸ¢",name:"ê±°ë¶ì´",color:"#15803d"},{level:5,emoji:"ğŸŠ",name:"ì•…ì–´",color:"#14532d"},{level:6,emoji:"ğŸ¦•",name:"ë¸Œë¼í‚¤ì˜¤",color:"#60a5fa"},{level:7,emoji:"ğŸ‰",name:"ë“œë˜ê³¤",color:"#ef4444"}];
    const CAT_SNACKS=[{level:1,emoji:"ğŸ¥›",name:"ìš°ìœ ",color:"#fce7f3"},{level:2,emoji:"ğŸŸ",name:"ë©¸ì¹˜",color:"#fbcfe8"},{level:3,emoji:"ğŸ¥«",name:"í†µì¡°ë¦¼",color:"#f9a8d4"},{level:4,emoji:"ğŸ¡",name:"ì¸„ë¥´",color:"#f472b6"},{level:5,emoji:"ğŸŒ¿",name:"ìº£ë‹¢",color:"#ec4899"}];
    const DOG_SNACKS=[{level:1,emoji:"ğŸ¦´",name:"ë¼ˆë‹¤ê·€",color:"#e0f2fe"},{level:2,emoji:"ğŸ¥–",name:"ê°œê»Œ",color:"#bae6fd"},{level:3,emoji:"ğŸ¥©",name:"ìœ¡í¬",color:"#7dd3fc"},{level:4,emoji:"ğŸŒ­",name:"ì†Œì„¸ì§€",color:"#38bdf8"},{level:5,emoji:"ğŸ–",name:"ìŠ¤í…Œì´í¬",color:"#0ea5e9"}];

    // ë³€ìˆ˜
    let boardState=new Array(BOARD_SIZE).fill(null), storageState=new Array(STORAGE_SIZE).fill(null), apartmentState=new Array(APARTMENT_ROOMS).fill(null), shopItems=new Array(SHOP_SIZE).fill(null);
    for(let i=0;i<STORAGE_SIZE;i++) storageState[i]={type:'locked_storage',cost:(i+1)*5};
    let coins=0, cumulativeCoins=0, nextSpecialTarget=SPECIAL_QUEST_STEP;
    let currentSetRescues=0; // í˜„ì¬ ì„¸íŠ¸ì—ì„œ êµ¬ì¡°í•œ ìˆ˜ (0~3)
    let diamonds=0, energy=MAX_ENERGY, recoveryCountdown=RECOVERY_SEC;
    let userLevel=1, questProgress=0, quests=[], questIdCounter=0, questPage=0, prevReadyCount=0;
    let genLevels={cat:1,dog:1}, dragData=null, currentRouletteRoom=-1, isSpinning=false;
    let currentGuideType='cat', currentGuideTab='animal', sellTarget=null, shopNextRefresh=Date.now()+SHOP_REFRESH_MS;
    let discoveredItems = new Set();
    let specialMissionCycles=[0,0,0], isTutorialActive=true;
    // ìƒì‹œ ë¯¸ì…˜: 0=í•©ì„±, 1=ìƒì„±
    let pmType=0, pmProgress=0;
    const PM_GOALS=[100, 200], PM_TITLES=['100ë²ˆ í•©ì„±í•˜ê¸°','200ë²ˆ ìƒì„±í•˜ê¸°'], PM_ICONS=['ğŸ”¨','âœ¨'], PM_REWARD=100;

    // DOM
    const boardEl=document.getElementById('game-board'), storageEl=document.getElementById('storage-area'), apartmentEl=document.getElementById('apartment-area'), shopGrid=document.getElementById('shop-grid');
    const coinEl=document.getElementById('coin-val'), diamondEl=document.getElementById('diamond-val'), energyEl=document.getElementById('energy-val'), energyTimerEl=document.getElementById('energy-timer');
    const levelEl=document.getElementById('level-val'), questProgEl=document.getElementById('quest-progress'), questContainer=document.getElementById('quest-container');
    const cumulativeBar=document.getElementById('cumulative-bar'), cumulativeText=document.getElementById('cumulative-text');
    const rescueBar=document.getElementById('rescue-bar'), rescueText=document.getElementById('rescue-text'), rescueTimerEl=document.getElementById('rescue-timer');
    const shopTimerBadge=document.getElementById('shop-timer-badge'), rouletteWheel=document.getElementById('roulette-wheel');
    const tutorialPointer=document.getElementById('tutorial-pointer');

    // --- Firebase ì´ˆê¸°í™” ---
    const firebaseConfig = {
        apiKey: "AIzaSyCmca1GswvALHTh_PtNXCJ39VVlje3HUZY",
        authDomain: "merge-game-7cf5f.firebaseapp.com",
        projectId: "merge-game-7cf5f",
        storageBucket: "merge-game-7cf5f.firebasestorage.app",
        messagingSenderId: "400056855947",
        appId: "1:400056855947:web:492180660615c92df6d38e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;

    // --- Google ë¡œê·¸ì¸ ---
    async function handleGoogleLogin() {
        if (currentUser) {
            // ë¡œê·¸ì•„ì›ƒ
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await auth.signOut();
                currentUser = null;
                document.getElementById('login-text').innerText = 'ë¡œê·¸ì¸';
                showToast('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
            }
        } else {
            // ë¡œê·¸ì¸
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                currentUser = result.user;
                document.getElementById('login-text').innerText = currentUser.displayName?.split(' ')[0] || 'ìœ ì €';
                showToast(`í™˜ì˜í•©ë‹ˆë‹¤, ${currentUser.displayName}!`);
                // í´ë¼ìš°ë“œì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                await loadFromCloud();
            } catch (e) {
                console.error('Login error:', e);
                showToast('ë¡œê·¸ì¸ ì‹¤íŒ¨');
            }
        }
    }

    // ë¡œê·¸ì¸ ìƒíƒœ ë³µì›
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('login-text').innerText = user.displayName?.split(' ')[0] || 'ìœ ì €';
        }
    });

    // --- ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ---
    function getGameData() {
        return {
            boardState, storageState, apartmentState,
            coins, cumulativeCoins, nextSpecialTarget,
            currentSetRescues,
            diamonds, energy, recoveryCountdown,
            userLevel, questProgress, quests, questIdCounter,
            genLevels, shopItems, shopNextRefresh: shopNextRefresh - Date.now(),
            discoveredItems: [...discoveredItems],
            specialMissionCycles, pmType, pmProgress,
            isTutorialActive, savedAt: Date.now()
        };
    }

    function applyGameData(d) {
        boardState = d.boardState || boardState;
        storageState = d.storageState || storageState;
        apartmentState = d.apartmentState || apartmentState;
        coins = d.coins ?? 0;
        cumulativeCoins = d.cumulativeCoins ?? 0;
        nextSpecialTarget = d.nextSpecialTarget ?? SPECIAL_QUEST_STEP;
        currentSetRescues = d.currentSetRescues ?? 0;
        diamonds = d.diamonds ?? 0;
        energy = d.energy ?? MAX_ENERGY;
        recoveryCountdown = d.recoveryCountdown ?? RECOVERY_SEC;
        userLevel = d.userLevel ?? 1;
        questProgress = d.questProgress ?? 0;
        quests = d.quests || [];
        questIdCounter = d.questIdCounter ?? 0;
        genLevels = d.genLevels || {cat:1, dog:1};
        shopItems = d.shopItems || shopItems;
        shopNextRefresh = Date.now() + (d.shopNextRefresh ?? SHOP_REFRESH_MS);
        discoveredItems = new Set(d.discoveredItems || []);
        specialMissionCycles = d.specialMissionCycles || [0,0,0];
        pmType = d.pmType ?? 0;
        pmProgress = d.pmProgress ?? 0;
        isTutorialActive = d.isTutorialActive ?? true;
    }

    let saveTimeout = null;
    function saveGame() {
        const data = getGameData();
        localStorage.setItem('mergeGame', JSON.stringify(data));
        // í´ë¼ìš°ë“œ ì €ì¥ (ë””ë°”ìš´ìŠ¤: 3ì´ˆ)
        if (currentUser) {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveToCloud(data), 3000);
        }
    }

    async function saveToCloud(data) {
        if (!currentUser) return;
        try {
            await db.collection('saves').doc(currentUser.uid).set(data);
            console.log('Cloud save complete');
        } catch (e) {
            console.error('Cloud save failed:', e);
        }
    }

    async function loadFromCloud() {
        if (!currentUser) return false;
        try {
            const doc = await db.collection('saves').doc(currentUser.uid).get();
            if (doc.exists) {
                const cloudData = doc.data();
                const localData = localStorage.getItem('mergeGame');
                const localSavedAt = localData ? JSON.parse(localData).savedAt || 0 : 0;
                const cloudSavedAt = cloudData.savedAt || 0;
                // í´ë¼ìš°ë“œ ë°ì´í„°ê°€ ë” ìµœì‹ ì´ë©´ ì ìš©
                if (cloudSavedAt > localSavedAt) {
                    applyGameData(cloudData);
                    localStorage.setItem('mergeGame', JSON.stringify(cloudData));
                    updateAll();
                    showToast('í´ë¼ìš°ë“œì—ì„œ ë¶ˆëŸ¬ì˜´!');
                    return true;
                }
            }
            return false;
        } catch (e) {
            console.error('Cloud load failed:', e);
            return false;
        }
    }

    function loadGame() {
        const saved = localStorage.getItem('mergeGame');
        if (!saved) return false;
        try {
            applyGameData(JSON.parse(saved));
            return true;
        } catch(e) { console.error('Load failed:', e); return false; }
    }

    // --- ì´ˆê¸°í™” í•¨ìˆ˜ ---
    function init() {
        // ë³´ë“œ ì…€ ìƒì„±
        createBoardCells();
        createStorageCells();
        createShopCells();

        // ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        const loaded = loadGame();

        // êµ¬ì¡° í˜„ì¥ì´ ë¹„ì–´ìˆìœ¼ë©´ ì´ˆê¸°í™”
        if (loaded && apartmentState.every(x => !x || x === null)) {
            initApartment();
        }
        // êµ¬ì¡° ì§„í–‰ë„ë¥¼ ì‹¤ì œ ìƒíƒœì™€ ë™ê¸°í™”
        if (loaded) {
            currentSetRescues = apartmentState.filter(x => x && x.rescued).length;
        }

        if (!loaded) {
            // ìƒˆ ê²Œì„: ì´ˆê¸° ì¼€ì´ì§€ ë°°ì¹˜
            boardState[0] = { type: 'cat_generator' };
            boardState[4] = { type: 'dog_generator' };

            // ì¼ë¶€ ë³´ë“œ ì…€ ì ê¸ˆ (í•˜ë‹¨ë¶€ - 7í–‰)
            boardState[30] = { type: 'upgrade_mission', target: 'cat', reqLevel: 2 };
            boardState[31] = { type: 'upgrade_mission', target: 'dog', reqLevel: 2 };
            for (let i = 32; i < 35; i++) {
                if (boardState[i] === null) {
                    boardState[i] = { type: 'locked_board' };
                }
            }

            // ì•„íŒŒíŠ¸ ì´ˆê¸°í™”
            initApartment();

            // ìƒì  ì´ˆê¸°í™”
            refreshShop();

            // í€˜ìŠ¤íŠ¸ ìƒì„± (6ê°œ)
            for (let i = 0; i < 6; i++) {
                generateNewQuest();
            }
        }

        // íƒ€ì´ë¨¸ ì‹œì‘
        startEnergyRecovery();
        startShopTimer();
        startAnimalHPTimer();
        startRescueTimer();
        startCooldownTimer();

        // ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë“±ë¡
        document.addEventListener('mousedown', handleDragStart);
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);
        document.addEventListener('touchstart', handleDragStart, { passive: false });
        document.addEventListener('touchmove', handleDragMove, { passive: false });
        document.addEventListener('touchend', handleDragEnd);

        // ì´ˆê¸° ë Œë”ë§
        updateAll();

        console.log(loaded ? 'Game loaded!' : 'New game started!');
    }

    function createBoardCells() {
        boardEl.innerHTML = '';
        for (let i = 0; i < BOARD_SIZE; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.zone = 'board';
            cell.dataset.index = i;
            cell.onclick = () => handleCellClick('board', i);
            boardEl.appendChild(cell);
        }
    }

    function createStorageCells() {
        storageEl.innerHTML = '';
        for (let i = 0; i < STORAGE_SIZE; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.zone = 'storage';
            cell.dataset.index = i;
            cell.onclick = () => handleCellClick('storage', i);
            storageEl.appendChild(cell);
        }
    }

    function createShopCells() {
        shopGrid.innerHTML = '';
        for (let i = 0; i < SHOP_SIZE; i++) {
            const cell = document.createElement('div');
            cell.className = 'shop-cell';
            cell.dataset.index = i;
            shopGrid.appendChild(cell);
        }
    }

    // --- ë°œê²¬ ê¸°ë¡ ---
    function discoverItem(type, level) {
        discoveredItems.add(`${type}_${level}`);
    }

    // --- í€˜ìŠ¤íŠ¸ í•¨ìˆ˜ ---
    function generateNewQuest() {
        const npc=NPC_AVATARS[Math.floor(Math.random()*NPC_AVATARS.length)];
        // ë ˆë²¨ë³„ ë‚œì´ë„ ìŠ¤ì¼€ì¼ë§
        const twoItemChance = Math.min(0.3 + userLevel * 0.05, 0.8); // 30%~80%
        const cnt = Math.random() < twoItemChance ? 2 : 1;
        const minLv = Math.min(Math.max(2, Math.floor(userLevel / 2)), 6); // 2~6
        const maxLvAnimal = Math.min(minLv + 3 + Math.floor(userLevel / 4), 10); // ~10
        const maxLvSnack = Math.min(Math.ceil(minLv / 2) + 2, 5); // ~5
        const reqs = []; let sc = 0;
        for(let i=0; i<cnt; i++) {
            const isSnack = Math.random() < 0.15;
            const base = Math.random() > 0.5 ? 'cat' : 'dog';
            const type = isSnack ? base + '_snack' : base;
            const min = isSnack ? Math.max(2, minLv - 1) : minLv;
            const max = isSnack ? maxLvSnack : maxLvAnimal;
            const lv = Math.floor(Math.random() * (max - min + 1)) + min;
            reqs.push({type, level: lv}); sc += (lv * (isSnack ? 15 : 10));
        }
        quests.push({id:questIdCounter++, npc, reqs, reward:20+sc+Math.floor(Math.random()*10)});
        updateQuestUI();
    }

    function updateQuestUI() {
        questContainer.innerHTML=''; const inv={};
        [...boardState,...storageState].forEach(i=>{ if(i&&!i.type.includes('locked')&&!i.type.includes('generator')&&!i.type.includes('mission')) inv[`${i.type}_${i.level}`]=(inv[`${i.type}_${i.level}`]||0)+1; });

        // ì™„ë£Œ ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬ í•¨ìˆ˜
        const canComplete = (q) => {
            const tInv={...inv};
            for(const r of q.reqs) {
                const k=`${r.type}_${r.level}`;
                if(tInv[k]>0) tInv[k]--; else return false;
            }
            return true;
        };

        // ì™„ë£Œ ê°€ëŠ¥í•œ í€˜ìŠ¤íŠ¸ ë¨¼ì € ì •ë ¬
        quests.sort((a, b) => canComplete(b) - canComplete(a));

        // ì™„ë£Œ ê°€ëŠ¥ í€˜ìŠ¤íŠ¸ ìˆ˜ ì²´í¬
        const readyCount = quests.filter(q => canComplete(q)).length;
        // ìƒˆë¡œìš´ ì™„ë£Œ ê°€ëŠ¥ í€˜ìŠ¤íŠ¸ ìƒê¸°ë©´ 1í˜ì´ì§€ë¡œ ìë™ ì´ë™
        if(readyCount > prevReadyCount && questPage > 0) {
            questPage = 0;
        }
        prevReadyCount = readyCount;

        // í˜ì´ì§€ ë²”ìœ„ ì²´í¬
        const maxPage = Math.ceil(quests.length / 3) - 1;
        if (questPage > maxPage) questPage = Math.max(0, maxPage);
        const start = questPage * 3, end = start + 3;

        quests.slice(start, end).forEach((q, idx)=>{
            const i = start + idx;
            const d=document.createElement('div'); d.className='quest-card';
            const ok = canComplete(q);
            if(ok) d.classList.add('ready');
            let h=`<div class="quest-npc">${q.npc}</div><div class="quest-reqs">`;
            q.reqs.forEach(r=>{
                let l; if(r.type==='cat')l=CATS; else if(r.type==='dog')l=DOGS; else if(r.type.includes('snack')) l=r.type.includes('cat')?CAT_SNACKS:DOG_SNACKS;
                h+=`<div class="req-item" title="Lv.${r.level}"><span class="text-lg">${l[r.level-1].emoji}</span></div>`;
            });
            h+=`</div><div class="text-[9px] text-yellow-600 mb-1">ë³´ìƒ: ${q.reward}ğŸª™</div><div class="quest-btn ${ok?'complete':'incomplete'}" onclick="${ok?`completeQuest(${i})`:''}">${ok?'ì™„ë£Œ!':'êµ¬í•´ì¤˜'}</div>`;
            d.innerHTML=h; questContainer.appendChild(d);
        });
        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        document.getElementById('quest-prev').disabled = questPage === 0;
        document.getElementById('quest-next').disabled = questPage >= maxPage;
    }

    function scrollQuests(dir) {
        const maxPage = Math.ceil(quests.length / 3) - 1;
        questPage = Math.max(0, Math.min(maxPage, questPage + dir));
        updateQuestUI();
    }

    function completeQuest(i) {
        const q=quests[i], rem=[...q.reqs];
        const delArr=(arr)=>{ for(let j=0; j<arr.length; j++){ if(rem.length===0)break; const it=arr[j]; if(it&&!it.type.includes('locked')&&!it.type.includes('generator')){ const idx=rem.findIndex(r=>r.type===it.type&&r.level===it.level); if(idx!==-1){ arr[j]=null; rem.splice(idx,1); } } } };
        delArr(boardState); if(rem.length>0) delArr(storageState);
        coins+=q.reward; cumulativeCoins+=q.reward; questProgress++; showToast(`ì™„ë£Œ! +${q.reward}ì½”ì¸`);
        if(questProgress>=userLevel*2) { userLevel++; questProgress=0; diamonds+=userLevel*5; document.getElementById('levelup-num').innerText=userLevel; document.getElementById('levelup-reward').innerText=userLevel*5; document.getElementById('levelup-overlay').style.display='flex'; }
        quests.splice(i,1); generateNewQuest(); updateAll();
    }

    // --- ì•„ì´í…œ ìƒì„± ---
    function spawnItem(baseType, inputLevel = 1, isFree = false) {
        if(!isFree) { if(energy<=0) { openEnergyPopup(); return; } energy--; updateUI(); updateTimerUI(); }
        const empties=[]; boardState.forEach((v,i)=>{ if(v===null) empties.push(i); });
        if(empties.length===0) { showToast("ê³µê°„ ë¶€ì¡±!"); return; }
        let finalType=baseType, finalLevel=inputLevel, isLucky=false;
        if(inputLevel===1 && (baseType==='cat'||baseType==='dog')) {
            const rand=Math.random(), gl=genLevels[baseType];
            const luckChance = 0.05 + (gl-1)*0.01; // 5%~9%
            if(rand < luckChance) {
                // í–‰ìš´: Lv1â†’2, Lv2â†’3, Lv3+â†’4
                const luckyLv = gl >= 3 ? 4 : gl + 1;
                const isSnack = Math.random() < 0.5; // 50% í™•ë¥ ë¡œ ê°„ì‹
                if(isSnack) { finalType += '_snack'; finalLevel = Math.min(luckyLv, 5); }
                else { finalLevel = luckyLv; }
                isLucky = true;
            } else if(rand < luckChance + SNACK_CHANCE) {
                // ì¼ë°˜ ê°„ì‹ (15%)
                finalType += '_snack'; finalLevel = 1;
            }
        }
        // ìƒì„±ê¸° ìœ„ì¹˜ ì°¾ê¸°
        const genIdx = boardState.findIndex(x => x && x.type === `${baseType}_generator`);
        const genRow = Math.floor(genIdx / GRID_COLS), genCol = genIdx % GRID_COLS;
        // ê±°ë¦¬ìˆœ ì •ë ¬ (ë§¨í•´íŠ¼ ê±°ë¦¬)
        empties.sort((a, b) => {
            const aRow = Math.floor(a / GRID_COLS), aCol = a % GRID_COLS;
            const bRow = Math.floor(b / GRID_COLS), bCol = b % GRID_COLS;
            const aDist = Math.abs(aRow - genRow) + Math.abs(aCol - genCol);
            const bDist = Math.abs(bRow - genRow) + Math.abs(bCol - genCol);
            return aDist - bDist;
        });
        const targetIdx = empties[0];
        boardState[targetIdx]={type:finalType, level:finalLevel};
        discoverItem(finalType, finalLevel);
        addPmProgress(1); // ìƒì„± ë¯¸ì…˜ ì§„í–‰
        renderGrid('board', boardState, boardEl);
        const cell=boardEl.children[targetIdx];
        if(cell&&cell.firstChild) { cell.firstChild.classList.add('pop-anim'); setTimeout(()=>cell.firstChild.classList.remove('pop-anim'),400); }
        // ìƒì„± ìœ„ì¹˜ì— ì´í™íŠ¸
        setTimeout(() => { spawnItemEffect(cell, isLucky); }, 50);
        if(isLucky) { showLuckyEffect(cell); }
    }

    function handleCellClick(zone, idx) {
        const s=zone==='board'?boardState:storageState, it=s[idx]; if(!it)return;
        if(it.type==='locked_board') { if(coins>=UNLOCK_COST_BOARD){ coins-=UNLOCK_COST_BOARD; s[idx]=null; showToast("í•´ì œ!"); updateAll(); } else showToast("ì½”ì¸ë¶€ì¡±"); }
        else if(it.type==='locked_storage') { if(idx>0 && s[idx-1]?.type==='locked_storage') { showToast("ì• ì¹¸ë¶€í„°!"); return; } if(diamonds>=it.cost){ diamonds-=it.cost; s[idx]=null; showToast("í™•ì¥!"); updateAll(); } else showToast("ë‹¤ì´ì•„ë¶€ì¡±"); }
        else if(it.type==='upgrade_mission') {
            const done = genLevels[it.target] >= it.reqLevel;
            if(done) {
                // ë‹¬ì„± ì™„ë£Œ - ì…€ í•´ì œ
                s[idx] = null;
                showToast("ë¯¸ì…˜ ì™„ë£Œ! ì¹¸ í•´ì œ!");
                updateAll();
            } else {
                // ë¯¸ë‹¬ì„± - ì—…ê·¸ë ˆì´ë“œ íƒ­ìœ¼ë¡œ ì´ë™
                openGuide(it.target);
                switchGuideTab('upgrade');
            }
        }
        else if(it.type.includes('generator')) triggerGen(idx, it);
    }

    function triggerGen(idx, item) {
        const cell=boardEl.children[idx], cage=cell.querySelector('.cage-generator');
        if(cage){
            cage.classList.add('cage-shake');
            setTimeout(()=>cage.classList.remove('cage-shake'),300);
            spawnParticles(cell);
        }
        const baseType=item.type.replace('_generator','');
        if(['bird','fish','reptile'].includes(baseType)) {
            if(item.cooldown>Date.now()){ showToast("ê³¼ì—´!"); return; }
            item.clicks=(item.clicks||0)+1; if(item.clicks>=6){ item.cooldown=Date.now()+60000; item.clicks=0; showToast("ê³¼ì—´! 1ë¶„ íœ´ì‹"); }
            spawnItem(baseType, 1, true);
        } else spawnItem(baseType, 1, false);
    }
    function spawnParticles(cell) {
        const particles = ['âœ¨', 'â­', 'ğŸ’«', 'ğŸŒŸ', 'âœ¦'];
        const rect = cell.getBoundingClientRect();
        for(let i = 0; i < 6; i++) {
            const p = document.createElement('div');
            p.className = 'spawn-particle';
            p.innerText = particles[Math.floor(Math.random() * particles.length)];
            const angle = (i / 6) * Math.PI * 2;
            const dist = 40 + Math.random() * 20;
            p.style.setProperty('--tx', `${Math.cos(angle) * dist}px`);
            p.style.setProperty('--ty', `${Math.sin(angle) * dist}px`);
            p.style.left = `${rect.left + rect.width/2}px`;
            p.style.top = `${rect.top + rect.height/2}px`;
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 600);
        }
    }
    function spawnItemEffect(cell, isLucky) {
        const rect = cell.getBoundingClientRect();
        // ë§ ì´í™íŠ¸
        const ring = document.createElement('div');
        ring.className = 'spawn-ring';
        ring.style.left = `${rect.left + rect.width/2}px`;
        ring.style.top = `${rect.top + rect.height/2}px`;
        if(isLucky) ring.classList.add('lucky');
        document.body.appendChild(ring);
        setTimeout(() => ring.remove(), 500);
        // ì‘ì€ íŒŒí‹°í´
        const sparkles = isLucky ? ['ğŸŒŸ', 'â­', 'âœ¨', 'ğŸ’', 'ğŸ‰'] : ['âœ¨', 'Â·', 'â€¢'];
        const particleCount = isLucky ? 12 : 4;
        for(let i = 0; i < particleCount; i++) {
            const s = document.createElement('div');
            s.className = 'spawn-particle';
            s.innerText = sparkles[Math.floor(Math.random() * sparkles.length)];
            s.style.fontSize = isLucky ? '1.2rem' : '0.6rem';
            const angle = (i / particleCount) * Math.PI * 2 + Math.random() * 0.5;
            const dist = isLucky ? (40 + Math.random() * 30) : (25 + Math.random() * 15);
            s.style.setProperty('--tx', `${Math.cos(angle) * dist}px`);
            s.style.setProperty('--ty', `${Math.sin(angle) * dist}px`);
            s.style.left = `${rect.left + rect.width/2}px`;
            s.style.top = `${rect.top + rect.height/2}px`;
            document.body.appendChild(s);
            setTimeout(() => s.remove(), isLucky ? 700 : 500);
        }
    }

    function showLuckyEffect(cell) {
        // ì…€ ê¸€ë¡œìš°
        cell.classList.add('lucky-glow');
        setTimeout(() => cell.classList.remove('lucky-glow'), 800);
        // í™”ë©´ í”Œë˜ì‹œ
        const flash = document.createElement('div');
        flash.className = 'lucky-flash';
        document.body.appendChild(flash);
        setTimeout(() => flash.remove(), 500);
        // í° Lucky! í…ìŠ¤íŠ¸
        const txt = document.createElement('div');
        txt.className = 'lucky-text';
        txt.innerText = 'âœ¨ Lucky! âœ¨';
        document.body.appendChild(txt);
        setTimeout(() => txt.remove(), 1000);
    }

    // --- ê·¸ë¦¬ë“œ ë Œë”ë§ ---
    function renderGrid(zone, state, cont) {
        const cells=cont.querySelectorAll('.cell');
        cells.forEach((c, i) => {
            if(dragData && dragData.zone===zone && dragData.index===i) return;
            c.className='cell'; c.innerHTML='';
            const item=state[i];
            if(item) {
                if(item.type==='locked_board') { c.classList.add('locked'); c.innerHTML=`<div class="text-xl opacity-50">ğŸ”’</div><div class="text-[8px] font-bold text-gray-500">${UNLOCK_COST_BOARD}ğŸª™</div>`; }
                else if(item.type==='locked_storage') { c.classList.add('storage-locked'); c.innerHTML=`<div class="text-xl">ğŸ”’</div><div class="text-[9px] font-bold mt-1">ğŸ’${item.cost}</div>`; }
                else if(item.type==='upgrade_mission') {
                    const done = genLevels[item.target] >= item.reqLevel;
                    const name = item.target === 'cat' ? 'ìº£íƒ€ì›Œ' : 'ê°œì§‘';
                    c.classList.add('upgrade-mission-cell');
                    if(done) c.classList.add('done');
                    c.innerHTML=`<div class="text-lg">${done ? 'âœ…' : 'ğŸ¯'}</div><div class="text-[8px] font-bold">${name} Lv.${item.reqLevel}</div>`;
                    c.dataset.missionTarget = item.target;
                }
                else c.appendChild(createItem(item, zone, i));
            }
        });
    }

    function createItem(item, zone, index) {
        if(item.type.includes('generator')) {
            const d=document.createElement('div'); d.className='cage-generator';
            let emoji='ğŸ“¦', label='ì¼€ì´ì§€', type=item.type.replace('_generator','');
            let specialUI='';
            if(['bird','fish','reptile'].includes(type)) {
                const rem=6-(item.clicks||0);
                if(item.cooldown>Date.now()) specialUI=`<div class="cooldown-overlay"><span>ğŸ’¤</span><span>${Math.ceil((item.cooldown-Date.now())/1000)}s</span></div>`;
                else specialUI=`<div class="usage-badge">${rem}/6</div>`;
            }
            if(type==='cat') { emoji='ğŸ±'; label=`ìº£íƒ€ì›Œ (Lv.${genLevels.cat})`; }
            else if(type==='dog') { emoji='ğŸ¶'; label=`ê°œì§‘ (Lv.${genLevels.dog})`; }
            else if(type==='bird') { emoji='ğŸ¦'; label='ìƒˆì¥'; } else if(type==='fish') { emoji='ğŸ '; label='ì–´í•­'; } else if(type==='reptile') { emoji='ğŸ¦'; label='ì‚¬ìœ¡ì¥'; }
            d.innerHTML=`${specialUI}<div class="animal-inside">${emoji}</div><div class="cage-label">${label}</div><div class="help-btn" data-gen-type="${type}">?</div>`;
            return d;
        }
        const d=document.createElement('div'); d.className='item';
        let list, isSnack=item.type.includes('snack');
        if(item.type==='cat') list=CATS; else if(item.type==='dog') list=DOGS;
        else if(item.type==='cat_snack') list=CAT_SNACKS; else if(item.type==='dog_snack') list=DOG_SNACKS;
        else if(item.type==='bird') list=BIRDS; else if(item.type==='fish') list=FISH; else if(item.type==='reptile') list=REPTILES;
        const data=list[item.level-1]||list[list.length-1];
        d.innerHTML=`<div class="${isSnack?'bg-square':'bg-circle'}" style="background-color:${data.color}"></div><div style="font-size:${isSnack?'1.5rem':'2rem'}">${data.emoji}</div><div class="level-badge">Lv.${item.level}</div>`;
        const sellBtn=document.createElement('div'); sellBtn.className='sell-btn'; sellBtn.innerText='â“’';
        sellBtn.onclick=(e)=>askSellItem(zone,index,e); d.appendChild(sellBtn);
        return d;
    }

    // --- UI ì—…ë°ì´íŠ¸ ---
    function updateAll() { renderGrid('board',boardState,boardEl); renderGrid('storage',storageState,storageEl); renderShop(); renderApartment(); updateUI(); updateTimerUI(); updateQuestUI(); updateSpecialQuestUI(); updateRescueQuestUI(); updateSpecialMissionUI(); updatePmUI(); saveGame(); }
    function updateUI() { coinEl.innerText=coins.toLocaleString(); diamondEl.innerText=diamonds.toLocaleString(); energyEl.innerText=energy; levelEl.innerText=`Lv.${userLevel}`; questProgEl.innerText=`${questProgress}/${userLevel*2}`; energyEl.className=energy===0?"text-xs font-bold text-red-500":"text-xs font-bold text-yellow-500"; }
    function updateTimerUI() { energyTimerEl.innerText=energy>=MAX_ENERGY?"FULL":`${Math.floor(recoveryCountdown/60)}:${(recoveryCountdown%60).toString().padStart(2,'0')}`; }

    function updateSpecialQuestUI() {
        while(cumulativeCoins>=nextSpecialTarget) { giveSpecialReward(); showMilestonePopup("ëˆ„ì  ì½”ì¸ ëª©í‘œ ë‹¬ì„±!","50 ì½”ì¸"); nextSpecialTarget+=SPECIAL_QUEST_STEP; if(nextSpecialTarget>SPECIAL_QUEST_GOAL){ cumulativeCoins=0; nextSpecialTarget=SPECIAL_QUEST_STEP; showToast("ëˆ„ì  ì½”ì¸ ë¦¬ì…‹!"); break; } }
        const disp=Math.min(cumulativeCoins,SPECIAL_QUEST_GOAL); cumulativeBar.style.width=`${(disp/SPECIAL_QUEST_GOAL)*100}%`; cumulativeText.innerText=`${Math.floor(disp).toLocaleString()} / ${SPECIAL_QUEST_GOAL.toLocaleString()}`;
    }
    function updateRescueQuestUI() {
        // 3ë§ˆë¦¬ ì„¸íŠ¸ ì™„ë£Œ ì‹œ ë³´ìƒ
        if(currentSetRescues >= 3) {
            coins += RESCUE_QUEST_REWARD;
            showToast(`ëª¨ë‘ êµ¬ì¡° ì™„ë£Œ! +${RESCUE_QUEST_REWARD}ì½”ì¸`);
            showMilestonePopup("ëª¨ë‘ êµ¬ì¡° ë‹¬ì„±!", `${RESCUE_QUEST_REWARD} ì½”ì¸`);
            currentSetRescues = 0;
            updateUI();
        }
        // UI ì—…ë°ì´íŠ¸
        rescueBar.style.width = `${(currentSetRescues/3)*100}%`;
        rescueText.innerText = `${currentSetRescues} / 3`;
    }

    // --- ìƒì‹œ ë¯¸ì…˜ ---
    function addPmProgress(type) {
        if(type !== pmType) return; // í˜„ì¬ ë¯¸ì…˜ íƒ€ì…ì´ ì•„ë‹ˆë©´ ë¬´ì‹œ
        pmProgress++;
        if(pmProgress >= PM_GOALS[pmType]) {
            coins += PM_REWARD;
            showToast(`ìƒì‹œ ë¯¸ì…˜ ì™„ë£Œ! +${PM_REWARD}ğŸª™`);
            showMilestonePopup(PM_TITLES[pmType] + " ì™„ë£Œ!", `${PM_REWARD} ì½”ì¸`);
            pmProgress = 0;
            pmType = pmType === 0 ? 1 : 0; // íƒ€ì… ì „í™˜
            updateUI();
        }
        updatePmUI();
    }
    function updatePmUI() {
        const goal = PM_GOALS[pmType];
        document.getElementById('pm-label').innerText = `${PM_ICONS[pmType]} ${PM_TITLES[pmType]}(${PM_REWARD}ğŸª™)`;
        document.getElementById('pm-bar').style.width = `${(pmProgress / goal) * 100}%`;
        document.getElementById('pm-text').innerText = `${pmProgress}/${goal}`;
    }

    // --- ìœ í‹¸ë¦¬í‹° ---
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.opacity='1'; setTimeout(()=>t.style.opacity='0',2000); }
    function showMilestonePopup(t,r){ document.getElementById('milestone-text').innerText=t; document.getElementById('milestone-reward').innerText=r; document.getElementById('milestone-overlay').style.display='flex'; }
    function closeOverlay(id){ document.getElementById(id).style.display='none'; }
    function giveSpecialReward() { coins+=SPECIAL_QUEST_REWARD_COINS; updateUI(); }
    function openEnergyPopup() { document.getElementById('popup-coin-val').innerText=coins.toLocaleString(); document.getElementById('energy-err').classList.add('hidden'); document.getElementById('energy-popup').style.display='flex'; }
    function buyEnergy() { document.getElementById('energy-err').classList.add('hidden'); if(coins>=ENERGY_COST){ coins-=ENERGY_COST; energy=MAX_ENERGY; recoveryCountdown=RECOVERY_SEC; closeOverlay('energy-popup'); showToast("ì¶©ì „ ì™„ë£Œ!"); updateUI(); updateTimerUI(); } else { document.getElementById('energy-err').innerText="ì½”ì¸ ë¶€ì¡±!"; document.getElementById('energy-err').classList.remove('hidden'); } }

    // --- ìŠ¤í˜ì…œ ë¯¸ì…˜ ---
    // ìŠ¬ë¡¯ë³„ í™œì„±í™” ë ˆë²¨: ìŠ¬ë¡¯0(ìƒˆ)=3,12,21..., ìŠ¬ë¡¯1(ë¬¼ê³ ê¸°)=6,15,24..., ìŠ¬ë¡¯2(íŒŒì¶©ë¥˜)=9,18,27...
    function getSlotUnlockLevel(slotIdx, cycle) { return (slotIdx + 1) * 3 + cycle * 9; }
    function updateSpecialMissionUI() {
        const types = ['bird', 'fish', 'reptile'];
        for (let i = 0; i < 3; i++) {
            const unlockLv = getSlotUnlockLevel(i, specialMissionCycles[i]);
            const isActive = userLevel >= unlockLv;
            updateSlot(i, isActive, types[i], unlockLv);
        }
    }
    function updateSlot(i, isActive, t, unlockLv) {
        const c = document.getElementById(`sp-mission-${i}`), txt = document.getElementById(`sp-text-${i}`), btn = document.getElementById(`sp-btn-${i}`);
        if (isActive) {
            c.classList.add('active');
            const hasGen = boardState.some(x => x && x.type === `${t}_generator`);
            const hasMax = boardState.some(x => x && x.type === t && x.level === 7);
            // ì¼€ì´ì§€ê°€ ì—†ê³  Lv.7ë„ ì—†ìœ¼ë©´ ìƒì„±
            if (!hasGen && !hasMax) { spawnSpecialGenerator(t); }
            const nameKo = t === 'bird' ? 'ìƒˆ' : t === 'fish' ? 'ë¬¼ê³ ê¸°' : 'íŒŒì¶©ë¥˜';
            if (hasMax) { txt.innerText = "ëª©í‘œë‹¬ì„±!"; btn.style.display = "block"; }
            else { txt.innerText = `Lv.7 ${nameKo}\në§Œë“¤ê¸°`; btn.style.display = "none"; }
        } else {
            c.classList.remove('active');
            txt.innerText = `Lv.${unlockLv}\nì˜¤í”ˆ`;
            btn.style.display = "none";
        }
    }
    function spawnSpecialGenerator(t) { const e=boardState.findIndex(x=>x===null); if(e!==-1){ boardState[e]={type:`${t}_generator`, clicks:0, cooldown:0}; renderGrid('board',boardState,boardEl); showToast("ìŠ¤í˜ì…œ ì¼€ì´ì§€ ë„ì°©!"); } else showToast("ê³µê°„ ë¶€ì¡±!"); }
    function completeSpecialMission(idx) {
        const type=['bird','fish','reptile'][idx]; coins+=500; diamonds+=10; showToast(`ì™„ë£Œ! +500ğŸª™ +10ğŸ’`);
        for(let i=0;i<BOARD_SIZE;i++){ if(boardState[i]&&(boardState[i].type===type||boardState[i].type===`${type}_generator`)) boardState[i]=null; }
        specialMissionCycles[idx]++; // ë‹¤ìŒ ì‚¬ì´í´ë¡œ
        const nextLv = getSlotUnlockLevel(idx, specialMissionCycles[idx]);
        document.getElementById(`sp-text-${idx}`).innerText=`Lv.${nextLv}\nì˜¤í”ˆ`; document.getElementById(`sp-btn-${idx}`).style.display="none";
        for(let i=0;i<SHOP_SIZE;i++){ if(shopItems[i]&&shopItems[i].type.includes(type)) shopItems[i]=generateRandomShopItem(getActiveTypes()); }
        renderShop(); updateAll();
    }

    // --- íŒë§¤ ---
    function askSellItem(z, i, e) {
        e.stopPropagation(); const it=z==='board'?boardState[i]:storageState[i]; if(!it)return;
        sellTarget={zone:z, index:i, item:it}; const p=it.level;
        let list; if(it.type.includes('cat')) list=it.type.includes('snack')?CAT_SNACKS:CATS; else if(it.type.includes('dog')) list=it.type.includes('snack')?DOG_SNACKS:DOGS; else if(it.type.includes('bird')) list=BIRDS; else if(it.type.includes('fish')) list=FISH; else list=REPTILES;
        const n=(list[it.level-1]||list[list.length-1]).name;
        document.getElementById('sell-desc').innerText=`'${n} (Lv.${it.level})' - ${p}ì½”ì¸`;
        document.getElementById('sell-popup').style.display='flex';
    }
    document.getElementById('confirm-sell-btn').onclick=()=>{ if(sellTarget){ const p=sellTarget.item.level; coins+=p; cumulativeCoins+=p; (sellTarget.zone==='board'?boardState:storageState)[sellTarget.index]=null; updateAll(); showToast(`${p}ì½”ì¸ íšë“!`); closeOverlay('sell-popup'); sellTarget=null; } };

    // --- ìƒì  ---
    function startShopTimer(){ setInterval(()=>{ if(Date.now()>=shopNextRefresh) refreshShop(); const d=shopNextRefresh-Date.now(), m=Math.floor(d/60000), s=Math.floor((d%60000)/1000); document.getElementById('shop-timer-badge').innerText=`ê°±ì‹ : ${m}:${s.toString().padStart(2,'0')}`; },1000); }
    function getActiveTypes() { const t=[]; if(boardState.some(i=>i&&i.type==='cat_generator')) t.push('cat'); if(boardState.some(i=>i&&i.type==='dog_generator')) t.push('dog'); ['bird','fish','reptile'].forEach(x=>{ if(boardState.some(i=>i&&i.type===`${x}_generator`)) t.push(x); }); if(t.length===0) t.push('cat','dog'); return t; }
    function refreshShop() { shopNextRefresh=Date.now()+SHOP_REFRESH_MS; const t=getActiveTypes(); for(let i=0;i<SHOP_SIZE-1;i++) shopItems[i]=generateRandomShopItem(t); shopItems[SHOP_SIZE-1]={type:'diamond_pack', amount:10, price:500}; renderShop(); }
    function generateRandomShopItem(types) { const tb=types[Math.floor(Math.random()*types.length)], canSnack=(tb==='cat'||tb==='dog'), isS=canSnack&&Math.random()<0.3, type=isS?`${tb}_snack`:tb, lv=Math.floor(Math.random()*5)+1; return {type,level:lv}; }
    function renderShop() {
        shopGrid.innerHTML=''; shopItems.forEach((item,idx)=>{
            const d=document.createElement('div'); d.className='shop-cell';
            if(item){
                d.onclick=()=>buyShopItem(idx);
                if(item.type==='diamond_pack') {
                    d.innerHTML=`<div class="bg-circle" style="background-color:#67e8f9"></div><div style="font-size:1.2rem">ğŸ’x${item.amount}</div><div class="shop-price-tag" style="color:#fbbf24">ğŸª™${item.price}</div>`;
                } else {
                    let list; if(item.type.includes('cat')) list=item.type.includes('snack')?CAT_SNACKS:CATS; else if(item.type.includes('dog')) list=item.type.includes('snack')?DOG_SNACKS:DOGS; else if(item.type.includes('bird')) list=BIRDS; else if(item.type.includes('fish')) list=FISH; else list=REPTILES;
                    const data=list[item.level-1]||list[list.length-1], isS=item.type.includes('snack');
                    d.innerHTML=`<div class="${isS?'bg-square':'bg-circle'}" style="background-color:${data.color}"></div><div style="font-size:1.2rem">${data.emoji}</div><div class="level-badge">Lv.${item.level}</div><div class="shop-price-tag">ğŸ’${item.level}</div>`;
                }
            } else d.innerHTML=`<span class="text-xs text-gray-400">í’ˆì ˆ</span>`;
            shopGrid.appendChild(d);
        });
    }
    function buyShopItem(idx) {
        const item=shopItems[idx]; if(!item)return;
        // ë‹¤ì´ì•„ íŒ© êµ¬ë§¤
        if(item.type==='diamond_pack') {
            if(coins<item.price){ showToast("ì½”ì¸ ë¶€ì¡±!"); return; }
            coins-=item.price; diamonds+=item.amount;
            showToast(`ğŸ’ +${item.amount} íšë“!`); updateAll(); return;
        }
        // ì¼ë°˜ ì•„ì´í…œ êµ¬ë§¤
        const p=item.level;
        if(diamonds<p){ showToast("ë‹¤ì´ì•„ ë¶€ì¡±!"); return; }
        let tz='board', eIdx=boardState.findIndex(v=>v===null);
        if(eIdx===-1){ const si=storageState.findIndex(v=>v===null); if(si!==-1){ tz='storage'; eIdx=si; } }
        if(eIdx===-1){ showToast("ê³µê°„ ë¶€ì¡±!"); return; }
        diamonds-=p; (tz==='board'?boardState:storageState)[eIdx]={...item};
        discoverItem(item.type, item.level);
        shopItems[idx]=generateRandomShopItem(getActiveTypes()); showToast("êµ¬ë§¤ ì™„ë£Œ!"); updateAll(); renderShop();
    }

    // --- ì•„íŒŒíŠ¸ & ë£°ë › ---
    function initApartment(){
        const emojis = ['ğŸ˜¿', 'ğŸ™€'];
        let assigned = [];
        for(let i=0; i<APARTMENT_ROOMS; i++){
            let emoji;
            // 3ê°œ ëª¨ë‘ ê°™ì€ ì´ëª¨ì§€ ë°©ì§€
            if(i === 2 && assigned[0] === assigned[1]) {
                emoji = assigned[0] === emojis[0] ? emojis[1] : emojis[0];
            } else {
                emoji = emojis[Math.floor(Math.random() * emojis.length)];
            }
            assigned.push(emoji);
            apartmentState[i] = { emoji: emoji, hp: 100, fireHp: 100, rescued: false };
        }
        renderApartment();
    }
    function startAnimalHPTimer(){ setInterval(()=>{ let ch=false; let helpRooms=[]; apartmentState.forEach((r,i)=>{ if(r && !r.rescued){ const prevHp = r.hp; r.hp-=ANIMAL_HP_DECAY; if(Math.floor(prevHp/10) > Math.floor(r.hp/10) && r.hp > 0){ helpRooms.push(i); } if(r.hp<=0){ apartmentState[i]=null; showToast("êµ¬ì¡° ì‹¤íŒ¨..."); } ch=true; } }); if(ch) { const allDoneOrNull = apartmentState.every(x => !x || x.rescued); if(allDoneOrNull && apartmentState.some(x => x === null)) { currentSetRescues=0; setTimeout(()=>{ showToast("ìƒˆ êµ¬ì¡° ìš”ì²­!"); initApartment(); }, 2000); } else { renderApartment(); helpRooms.forEach(i => showHelpBubble(i)); } } }, ANIMAL_HP_DECAY_SEC*1000); }
    function showHelpBubble(roomIdx) {
        const room = apartmentEl.children[roomIdx];
        if(!room) return;
        const bubble = document.createElement('div');
        bubble.className = 'help-bubble';
        bubble.innerText = 'HELP!';
        room.appendChild(bubble);
        setTimeout(() => bubble.remove(), 1500);
    }
    function renderApartment(){
        apartmentEl.innerHTML=''; apartmentState.forEach((r,i)=>{
            const d=document.createElement('div'); d.className='apt-room';
            if(r && r.rescued) {
                d.classList.add('rescued');
                const happyEmoji = r.emoji==='ğŸ˜¿' ? 'ğŸ˜º' : 'ğŸ˜¸';
                d.innerHTML=`<div class="rescued-badge">âœ… êµ¬ì¡° ì™„ë£Œ</div><div class="text-3xl z-10">${happyEmoji}</div>`;
            } else if(r) {
                d.onclick=()=>{ isTutorialActive=false; openRoulette(i); renderApartment(); };
                let html=`<div class="status-badge fire-badge absolute top-1"><span>ğŸ”¥</span><span>${r.fireHp}</span></div><div class="fire-icon">ğŸ”¥</div><div class="text-3xl z-10">${r.emoji}</div><div class="status-badge hp-badge absolute bottom-1"><span>â¤ï¸</span><span>${r.hp}</span></div><div class="fire-overlay"></div>`;
                if(isTutorialActive) html+=`<div class="tutorial-badge">CLICK!</div>`;
                d.innerHTML=html;
            } else {
                d.classList.add('empty');
                d.innerHTML=`<span class="text-gray-500 text-sm">ë¹ˆ ë°©</span>`;
            }
            apartmentEl.appendChild(d);
        });
    }
    function openRoulette(i){ if(isSpinning)return; currentRouletteRoom=i; const r=apartmentState[i]; if(!r)return; currentRotation=0; rouletteWheel.style.transition='none'; rouletteWheel.style.transform='rotate(0deg)'; rouletteWheel.offsetHeight; renderRouletteLabels(); updateRoulettePopupUI(r); document.getElementById('roulette-err').classList.add('hidden'); document.getElementById('roulette-popup').style.display='flex'; }
    function renderRouletteLabels() {
        // ê¸°ì¡´ ë¼ë²¨ ì œê±°
        rouletteWheel.querySelectorAll('.roulette-label').forEach(el => el.remove());
        const radius = 70; // ë¼ë²¨ ìœ„ì¹˜ ë°˜ì§€ë¦„
        ROULETTE_SEGMENTS.forEach((val, idx) => {
            const angle = (idx * 60 + 30) * Math.PI / 180; // ê° ì„¸ê·¸ë¨¼íŠ¸ ì¤‘ì•™ (30ë„ì”© ì˜¤í”„ì…‹)
            const x = 96 + radius * Math.sin(angle); // ì¤‘ì‹¬ 96px ê¸°ì¤€
            const y = 96 - radius * Math.cos(angle);
            const label = document.createElement('div');
            label.className = 'roulette-label';
            label.innerText = val;
            label.style.left = `${x}px`;
            label.style.top = `${y}px`;
            label.style.transform = 'translate(-50%, -50%)';
            rouletteWheel.appendChild(label);
        });
    }
    function updateRoulettePopupUI(r){ const b=document.getElementById('popup-fire-hp-bar'), t=document.getElementById('popup-fire-hp-text'); b.style.width=`${r.fireHp}%`; t.innerText=`${r.fireHp}/100`; document.getElementById('roulette-coin-val').innerText=coins.toLocaleString(); }
    let currentRotation = 0;
    function startSpin(){
        if(isSpinning)return; document.getElementById('roulette-err').classList.add('hidden');
        if(coins<FIRE_EXTINGUISH_COST){ const e=document.getElementById('roulette-err'); e.innerText="ì½”ì¸ ë¶€ì¡±!"; e.classList.remove('hidden'); return; }
        if(currentRouletteRoom===-1||!apartmentState[currentRouletteRoom])return;
        coins-=FIRE_EXTINGUISH_COST; updateUI(); updateRoulettePopupUI(apartmentState[currentRouletteRoom]);
        isSpinning=true;
        const deg=Math.floor(Math.random()*360);
        const spins = 360 * 5; // 5ë°”í€´
        currentRotation += spins + deg;
        rouletteWheel.style.transition='transform 3s cubic-bezier(0.25, 0.1, 0.25, 1)';
        rouletteWheel.style.transform=`rotate(${currentRotation}deg)`;
        setTimeout(()=>finishSpin(currentRotation),3000);
    }
    function finishSpin(angle){
        isSpinning=false; const n=angle%360, p=(360-n)%360, idx=Math.floor(p/60), dmg=ROULETTE_SEGMENTS[idx], r=apartmentState[currentRouletteRoom];
        r.fireHp-=dmg; showToast(`ğŸ”¥ ë¶ˆ ì²´ë ¥ -${dmg}!`);
        if(r.fireHp<=0){
            currentSetRescues++;
            showToast(`êµ¬ì¡° ì„±ê³µ!`);
            r.rescued=true; r.hp=100; // êµ¬ì¡° ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
            closeOverlay('roulette-popup'); updateRescueQuestUI();
            // ëª¨ë‘ êµ¬ì¡° ì™„ë£Œë˜ë©´ ìƒˆ ë¼ìš´ë“œ
            const allRescued = apartmentState.every(x => x && x.rescued);
            if(allRescued) setTimeout(()=>{ showToast("ëª¨ë“  ë™ë¬¼ êµ¬ì¡° ì™„ë£Œ! ìƒˆ êµ¬ì¡° ìš”ì²­!"); initApartment(); }, 2000);
        }
        else updateRoulettePopupUI(r); renderApartment(); updateUI();
    }

    // --- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ---
    function handleDragStart(e) {
        if(e.target.closest('.help-btn')||e.target.closest('.quest-btn')||e.target.closest('.sp-btn')||e.target.closest('#btn-spin')||e.target.closest('.sell-btn')||e.target.closest('.shop-cell')){ if(e.target.closest('.help-btn')) openGuide(e.target.closest('.help-btn').dataset.genType); e.stopPropagation(); return; }
        const t=e.target.closest('.item, .cage-generator'); if(!t)return;
        const p=t.parentElement; if(p.classList.contains('locked')||p.classList.contains('storage-locked'))return;
        e.preventDefault(); const z=p.dataset.zone, i=parseInt(p.dataset.index);
        dragData={zone:z, index:i, el:t, startX:e.touches?e.touches[0].clientX:e.clientX, startY:e.touches?e.touches[0].clientY:e.clientY};
        const r=t.getBoundingClientRect(); dragData.offsetX=dragData.startX-r.left; dragData.offsetY=dragData.startY-r.top;
        t.style.position='fixed'; t.style.width=r.width+'px'; t.style.height=r.height+'px'; t.style.left=r.left+'px'; t.style.top=r.top+'px'; t.style.zIndex=1000; t.style.pointerEvents='none';
    }
    function handleDragMove(e) {
        if(!dragData)return; e.preventDefault();
        const cx=e.touches?e.touches[0].clientX:e.clientX, cy=e.touches?e.touches[0].clientY:e.clientY;
        dragData.el.style.left=(cx-dragData.offsetX)+'px'; dragData.el.style.top=(cy-dragData.offsetY)+'px';
    }
    function handleDragEnd(e) {
        if(!dragData)return;
        const cx=e.changedTouches?e.changedTouches[0].clientX:e.clientX, cy=e.changedTouches?e.changedTouches[0].clientY:e.clientY;
        if(Math.hypot(cx-dragData.startX, cy-dragData.startY)<5) { dragData.el.style.display=''; handleCellClick(dragData.zone, dragData.index); dragData=null; updateAll(); return; }
        dragData.el.style.display='none'; const el=document.elementFromPoint(cx,cy); dragData.el.style.display='flex';
        const tc=el?el.closest('.cell'):null;
        if(tc) { const tz=tc.dataset.zone, ti=parseInt(tc.dataset.index), ts=tz==='board'?boardState:storageState; if(ts[ti]&&(ts[ti].type.includes('locked'))) showToast("ì ê²¨ìˆìŒ!"); else moveItem(dragData.zone, dragData.index, tz, ti); }
        dragData=null; updateAll();
    }
    function moveItem(fz, fi, tz, ti) {
        if(fz===tz && fi===ti) return;
        const ss=fz==='board'?boardState:storageState, ts=tz==='board'?boardState:storageState; const fIt=ss[fi], tIt=ts[ti];
        if(!tIt) { ts[ti]=fIt; ss[fi]=null; return; }
        if(fIt.type===tIt.type && fIt.level===tIt.level) {
            let max=11; if(fIt.type.includes('snack')) max=5; if(['bird','fish','reptile'].includes(fIt.type)) max=7;
            if(fIt.level<max) { const newLv=fIt.level+1; ts[ti]={type:fIt.type, level:newLv}; ss[fi]=null; discoverItem(fIt.type, newLv); addPmProgress(0); setTimeout(()=>{ showFloatText((tz==='board'?boardEl:storageEl).children[ti], "UP!", "#f43f5e"); },50); } else { ts[ti]=fIt; ss[fi]=tIt; }
        } else { ts[ti]=fIt; ss[fi]=tIt; }
    }
    function showFloatText(c,t,col) { if(!c)return; const r=c.getBoundingClientRect(); const d=document.createElement('div'); d.className='floating-text'; d.innerText=t; d.style.color=col; d.style.left=(r.left+r.width/2-10)+'px'; d.style.top=r.top+'px'; document.body.appendChild(d); setTimeout(()=>d.remove(),1000); }

    // --- ë„ê°/ëª¨ë‹¬ ---
    function openGuide(type) {
        currentGuideType = type;
        currentGuideTab = 'animal';
        document.getElementById('guide-modal').classList.add('show');
        switchGuideTab('animal');
    }

    function closeModal() {
        document.getElementById('guide-modal').classList.remove('show');
    }

    function switchGuideTab(tab) {
        currentGuideTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');

        const listContainer = document.getElementById('guide-list-container');
        const upgradeContainer = document.getElementById('upgrade-container');

        if (tab === 'upgrade') {
            listContainer.classList.add('hidden');
            upgradeContainer.classList.remove('hidden');
            upgradeContainer.classList.add('flex');
            updateUpgradeUI();
        } else {
            listContainer.classList.remove('hidden');
            upgradeContainer.classList.add('hidden');
            upgradeContainer.classList.remove('flex');
            renderGuideList(tab);
        }
    }

    function renderGuideList(tab) {
        const container = document.getElementById('guide-list-container');
        let list = [];

        if (tab === 'animal') {
            if (currentGuideType === 'cat') list = CATS;
            else if (currentGuideType === 'dog') list = DOGS;
            else if (currentGuideType === 'bird') list = BIRDS;
            else if (currentGuideType === 'fish') list = FISH;
            else if (currentGuideType === 'reptile') list = REPTILES;
        } else if (tab === 'snack') {
            if (currentGuideType === 'cat' || currentGuideType === 'dog') {
                list = currentGuideType === 'cat' ? CAT_SNACKS : DOG_SNACKS;
            } else {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">ì´ ë™ë¬¼ì€ ê°„ì‹ì´ ì—†ì–´ìš”</div>';
                return;
            }
        }

        // ë°œê²¬í•œ ë™ë¬¼ ì²´í¬ - ì „ì—­ discoveredItems ì‚¬ìš©
        let html = '<div class="guide-list">';
        list.forEach(item => {
            const key = `${currentGuideType}${tab === 'snack' ? '_snack' : ''}_${item.level}`;
            const isDiscovered = discoveredItems.has(key);
            html += `
                <div class="guide-item ${isDiscovered ? '' : 'locked'}">
                    <div class="guide-emoji">${item.emoji}</div>
                    <div class="guide-name">${isDiscovered ? item.name : '???'}</div>
                    <div class="guide-level">Lv.${item.level}</div>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    function updateUpgradeUI() {
        const type = currentGuideType;
        const upgradeContent = document.getElementById('upgrade-content');
        const upgradeMsg = document.getElementById('upgrade-msg');
        if (type !== 'cat' && type !== 'dog') {
            if(upgradeContent) upgradeContent.style.display = 'none';
            if(upgradeMsg) upgradeMsg.style.display = 'block';
            return;
        }
        if(upgradeContent) upgradeContent.style.display = 'block';
        if(upgradeMsg) upgradeMsg.style.display = 'none';
        const currentLv = genLevels[type];
        const nextLv = Math.min(currentLv + 1, CAGE_MAX_LEVEL);
        document.getElementById('upg-current-lv').innerText = currentLv;
        document.getElementById('upg-current-luck').innerText = 5 + (currentLv - 1);
        document.getElementById('upg-next-lv').innerText = nextLv;
        document.getElementById('upg-next-luck').innerText = 5 + (nextLv - 1);
    }

    function upgradeGenerator() {
        const type = currentGuideType;
        if (type !== 'cat' && type !== 'dog') return;
        if (genLevels[type] >= CAGE_MAX_LEVEL) {
            showToast("ìµœëŒ€ ë ˆë²¨!");
            return;
        }
        if (coins < CAGE_UPGRADE_COST) {
            showToast("ì½”ì¸ ë¶€ì¡±!");
            return;
        }
        coins -= CAGE_UPGRADE_COST;
        genLevels[type]++;
        showToast(`${type === 'cat' ? 'ìº£íƒ€ì›Œ' : 'ê°œì§‘'} Lv.${genLevels[type]}!`);
        updateUpgradeUI();
        updateAll();
    }

    // --- íƒ€ì´ë¨¸ë“¤ ---
    function startCooldownTimer() { setInterval(() => { let needsUpdate=false; [...boardState, ...storageState].forEach(i => { if (i&&i.type.endsWith('_generator')&&i.cooldown>0&&i.cooldown<=Date.now()){ i.cooldown=0; i.clicks=0; needsUpdate=true; } }); if(needsUpdate) { renderGrid('board', boardState, boardEl); renderGrid('storage', storageState, storageEl); } }, 1000); }
    function startEnergyRecovery() { setInterval(() => { if(energy<MAX_ENERGY) { recoveryCountdown--; if(recoveryCountdown<=0) { energy++; recoveryCountdown=RECOVERY_SEC; updateUI(); } updateTimerUI(); } else { recoveryCountdown=RECOVERY_SEC; updateTimerUI(); } }, 1000); }
    function startRescueTimer() {
        setInterval(() => {
            // êµ¬ì¡°ë˜ì§€ ì•Šì€ ë™ë¬¼ ì¤‘ ê°€ì¥ ë‚®ì€ HP ì°¾ê¸°
            let minHp = Infinity;
            apartmentState.forEach(r => { if(r && !r.rescued && r.hp < minHp) minHp = r.hp; });
            if(minHp === Infinity) { rescueTimerEl.innerText = '--:--'; return; }
            // HPê°€ 0ì´ ë  ë•Œê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚° (HP / ê°ì†ŒëŸ‰ * ê°ì†Œì£¼ê¸°)
            const remainSec = Math.ceil(minHp / ANIMAL_HP_DECAY) * ANIMAL_HP_DECAY_SEC;
            const m = Math.floor(remainSec / 60), s = remainSec % 60;
            rescueTimerEl.innerText = `${m}:${s.toString().padStart(2,'0')}`;
        }, 1000);
    }

    // ê²Œì„ ì‹œì‘
    init();
</script>
</body>
</html>
