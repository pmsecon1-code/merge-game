rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // 공통 함수: 인증 확인
    function isAuthenticated() {
      return request.auth != null;
    }

    // 공통 함수: 본인 문서 확인
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // 공통 함수: 숫자 범위 검증
    function isValidNumber(value, min, max) {
      return value is number && value >= min && value <= max;
    }

    // 공통 함수: 배열 크기 검증
    function isValidArray(value, maxSize) {
      return value is list && value.size() <= maxSize;
    }

    // ========================================
    // 게임 저장 데이터 (/saves/{userId})
    // ========================================
    match /saves/{userId} {
      // 읽기: 본인만 가능
      allow read: if isOwner(userId);

      // 쓰기: 본인만 + 데이터 검증
      allow write: if isOwner(userId) && isValidSaveData(request.resource.data);

      // 저장 데이터 검증 함수
      function isValidSaveData(data) {
        return data.keys().hasAll(['coins', 'diamonds', 'energy', 'userLevel', 'savedAt'])
          // 숫자 필드 범위 검증
          && isValidNumber(data.coins, 0, 9999999)           // 코인: 0 ~ 999만
          && isValidNumber(data.diamonds, 0, 99999)          // 다이아: 0 ~ 9만
          && isValidNumber(data.energy, 0, 999)              // 에너지: 0 ~ 999 (초과 허용)
          && isValidNumber(data.userLevel, 1, 999)           // 레벨: 1 ~ 999
          && isValidNumber(data.cumulativeCoins, 0, 9999999) // 누적코인
          && isValidNumber(data.questProgress, 0, 100)       // 퀘스트 진행
          // 배열 크기 검증
          && isValidArray(data.boardState, 35)               // 보드: 최대 35칸
          && isValidArray(data.storageState, 10)             // 창고: 최대 10칸
          && isValidArray(data.quests, 10)                   // 퀘스트: 최대 10개
          && isValidArray(data.shopItems, 10)                // 상점: 최대 10개
          && isValidArray(data.discoveredItems, 100)         // 도감: 최대 100개
          // 앨범 검증
          && isValidNumber(data.cards, 0, 9999)                // 카드: 0 ~ 9999
          && isValidArray(data.album, 100)                     // 앨범: 최대 100개 (81사진+9보상키)
          // 주사위 여행 검증
          && isValidNumber(data.diceTripPosition, 0, 50)       // 위치: 0~50
          && isValidNumber(data.diceCount, 0, 999)             // 주사위: 0~999
          && isValidArray(data.visitedSteps, 50)               // 방문 칸: 최대 50개
          // 스페셜 퀘스트 순환 인덱스 검증
          && isValidNumber(data.currentSpecialIndex, 0, 2)
          // 튜토리얼 검증
          && isValidNumber(data.tutorialStep, 0, 4)
          // 타임스탬프 검증 (미래 시간 방지)
          && data.savedAt <= request.time.toMillis() + 60000; // 1분 여유
      }
    }

    // ========================================
    // 세션 관리 (/sessions/{userId})
    // ========================================
    match /sessions/{userId} {
      // 읽기: 본인만 가능
      allow read: if isOwner(userId);

      // 쓰기: 본인만 + 데이터 검증
      allow write: if isOwner(userId) && isValidSessionData(request.resource.data);

      // 세션 데이터 검증 함수
      function isValidSessionData(data) {
        return data.keys().hasAll(['sessionId', 'loginAt'])
          && data.sessionId is string
          && data.sessionId.size() <= 50              // 세션 ID 길이 제한
          && data.loginAt is number
          && data.loginAt <= request.time.toMillis() + 60000; // 미래 시간 방지
      }
    }

    // ========================================
    // 레이스 (/races/{raceId})
    // ========================================
    match /races/{raceId} {
      // 참가자 확인 (player1 또는 player2)
      function isPlayer() {
        return isAuthenticated() &&
          (resource.data.player1Uid == request.auth.uid ||
           resource.data.player2Uid == request.auth.uid);
      }

      // 레이스/초대 생성 검증
      function isValidRaceCreate() {
        let data = request.resource.data;
        return data.player1Uid == request.auth.uid
          && data.player2Uid is string
          && (data.status == 'pending' || data.status == 'active')
          && data.createdAt is number;
      }

      // 레이스 업데이트 검증
      function isValidRaceUpdate() {
        let data = request.resource.data;
        let prev = resource.data;
        // player1Uid, player2Uid는 변경 불가
        return data.player1Uid == prev.player1Uid
          && data.player2Uid == prev.player2Uid
          // status 전환 규칙
          && (
            // pending → active/declined/expired/cancelled
            (prev.status == 'pending' &&
              (data.status == 'active' || data.status == 'declined' ||
               data.status == 'expired' || data.status == 'cancelled'))
            ||
            // active → completed
            (prev.status == 'active' && data.status == 'completed')
            ||
            // 같은 status 유지 (진행도 업데이트 등)
            (data.status == prev.status)
          )
          // active 상태일 때 진행도 검증
          && (data.status != 'active' ||
              (isValidNumber(data.player1Progress, 0, 15) &&
               isValidNumber(data.player2Progress, 0, 15)));
      }

      // 읽기: 참가자만
      allow read: if isPlayer();
      // 생성: 인증된 사용자
      allow create: if isAuthenticated() && isValidRaceCreate();
      // 업데이트: 참가자만
      allow update: if isPlayer() && isValidRaceUpdate();
    }

    // ========================================
    // 초대 코드 (/raceCodes/{code}) - 영구 코드
    // ========================================
    match /raceCodes/{code} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
        && request.resource.data.ownerUid == request.auth.uid
        && request.resource.data.ownerName is string
        && request.resource.data.createdAt is number;
    }

    // ========================================
    // 기타 모든 문서: 접근 거부
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
