rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // 공통 함수: 인증 확인
    function isAuthenticated() {
      return request.auth != null;
    }

    // 공통 함수: 본인 문서 확인
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // 공통 함수: 숫자 범위 검증
    function isValidNumber(value, min, max) {
      return value is number && value >= min && value <= max;
    }

    // 공통 함수: 배열 크기 검증
    function isValidArray(value, maxSize) {
      return value is list && value.size() <= maxSize;
    }

    // ========================================
    // 게임 저장 데이터 (/saves/{userId})
    // ========================================
    match /saves/{userId} {
      // 읽기: 본인만 가능
      allow read: if isOwner(userId);

      // 쓰기: 본인만 + 데이터 검증
      allow write: if isOwner(userId) && isValidSaveData(request.resource.data);

      // 저장 데이터 검증 함수
      function isValidSaveData(data) {
        return data.keys().hasAll(['coins', 'diamonds', 'energy', 'userLevel', 'savedAt'])
          // 숫자 필드 범위 검증
          && isValidNumber(data.coins, 0, 9999999)           // 코인: 0 ~ 999만
          && isValidNumber(data.diamonds, 0, 99999)          // 다이아: 0 ~ 9만
          && isValidNumber(data.energy, 0, 100)              // 에너지: 0 ~ 100
          && isValidNumber(data.userLevel, 1, 999)           // 레벨: 1 ~ 999
          && isValidNumber(data.cumulativeCoins, 0, 9999999) // 누적코인
          && isValidNumber(data.currentSetRescues, 0, 3)     // 구조 진행: 0~3
          && isValidNumber(data.questProgress, 0, 100)       // 퀘스트 진행
          && isValidNumber(data.pmProgress, 0, 200)          // 상시미션 진행
          // 배열 크기 검증
          && isValidArray(data.boardState, 35)               // 보드: 최대 35칸
          && isValidArray(data.storageState, 10)             // 창고: 최대 10칸
          && isValidArray(data.apartmentState, 5)            // 구조현장: 최대 5칸
          && isValidArray(data.quests, 10)                   // 퀘스트: 최대 10개
          && isValidArray(data.shopItems, 10)                // 상점: 최대 10개
          && isValidArray(data.discoveredItems, 100)         // 도감: 최대 100개
          // 앨범 검증
          && isValidNumber(data.cards, 0, 9999)                // 카드: 0 ~ 9999
          && isValidArray(data.album, 100)                     // 앨범: 최대 100개 (81사진+9보상키)
          // 타임스탬프 검증 (미래 시간 방지)
          && data.savedAt <= request.time.toMillis() + 60000; // 1분 여유
      }
    }

    // ========================================
    // 세션 관리 (/sessions/{userId})
    // ========================================
    match /sessions/{userId} {
      // 읽기: 본인만 가능
      allow read: if isOwner(userId);

      // 쓰기: 본인만 + 데이터 검증
      allow write: if isOwner(userId) && isValidSessionData(request.resource.data);

      // 세션 데이터 검증 함수
      function isValidSessionData(data) {
        return data.keys().hasAll(['sessionId', 'loginAt'])
          && data.sessionId is string
          && data.sessionId.size() <= 50              // 세션 ID 길이 제한
          && data.loginAt is number
          && data.loginAt <= request.time.toMillis() + 60000; // 미래 시간 방지
      }
    }

    // ========================================
    // 레이스 (/races/{raceId})
    // ========================================
    match /races/{raceId} {
      // 참가자 확인
      function isParticipant() {
        return isAuthenticated() &&
          (resource.data.hostUid == request.auth.uid ||
           resource.data.guestUid == request.auth.uid);
      }

      // 호스트 확인
      function isHost() {
        return isAuthenticated() && resource.data.hostUid == request.auth.uid;
      }

      // 게스트 참가 가능 여부 (pending 상태 + 아직 게스트 없음)
      function canJoinAsGuest() {
        return isAuthenticated()
          && resource.data.status == 'pending'
          && resource.data.guestUid == null
          && resource.data.hostUid != request.auth.uid;
      }

      // 레이스 생성 검증
      function isValidRaceCreate() {
        let data = request.resource.data;
        return data.hostUid == request.auth.uid
          && data.guestUid == null
          && data.status == 'pending'
          && data.hostProgress == 0
          && data.guestProgress == 0
          && data.winnerUid == null
          && data.createdAt is number
          && data.expiresAt is number;
      }

      // 레이스 업데이트 검증
      function isValidRaceUpdate() {
        let data = request.resource.data;
        let prev = resource.data;
        // hostUid는 변경 불가
        return data.hostUid == prev.hostUid
          // 진행도는 0~15
          && isValidNumber(data.hostProgress, 0, 15)
          && isValidNumber(data.guestProgress, 0, 15);
      }

      // 게스트 참가 업데이트 검증
      function isValidGuestJoin() {
        let data = request.resource.data;
        let prev = resource.data;
        return data.hostUid == prev.hostUid
          && data.guestUid == request.auth.uid
          && data.status == 'active'
          && data.hostProgress == 0
          && data.guestProgress == 0;
      }

      // 읽기: 참가자 또는 참가 가능한 pending 레이스
      allow read: if isParticipant() || canJoinAsGuest();
      allow create: if isAuthenticated() && isValidRaceCreate();
      // 업데이트: 참가자가 진행도 업데이트 또는 게스트 참가
      allow update: if (isParticipant() && isValidRaceUpdate())
                    || (canJoinAsGuest() && isValidGuestJoin());
      allow delete: if isHost() && resource.data.status == 'pending';
    }

    // ========================================
    // 초대 코드 (/raceCodes/{code})
    // ========================================
    match /raceCodes/{code} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
        && request.resource.data.hostUid == request.auth.uid
        && request.resource.data.raceId is string
        && request.resource.data.hostName is string
        && request.resource.data.createdAt is number
        && request.resource.data.expiresAt is number;
      allow delete: if isAuthenticated();
    }

    // ========================================
    // 기타 모든 문서: 접근 거부
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
