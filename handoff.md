# ë©ëƒ¥ ë¨¸ì§€ ê²Œì„ - Architecture (v4.0.0)

## ê°œìš”

**ë©ëƒ¥ ë¨¸ì§€**ëŠ” ë™ë¬¼ì„ í•©ì„±í•˜ì—¬ ì„±ì¥ì‹œí‚¤ëŠ” ëª¨ë°”ì¼ ì¹œí™”ì  ì›¹ ê²Œì„ì…ë‹ˆë‹¤.

- **URL**: https://pmsecon1-code.github.io/merge-game/
- **ë²„ì „**: 4.0.0
- **Firebase í”„ë¡œì íŠ¸**: `merge-game-7cf5f`

---

## íŒŒì¼ êµ¬ì¡°

```
merge2/
â”œâ”€â”€ index.html          # ë©”ì¸ (HTML + ê²Œì„ ë¡œì§, ~1400ì¤„)
â”œâ”€â”€ css/
â”‚   â””â”€â”€ styles.css      # ëª¨ë“  CSS (600+ ì¤„)
â”œâ”€â”€ js/
â”‚   â””â”€â”€ constants.js    # ìƒìˆ˜ + ë°ì´í„° + í—¬í¼ í•¨ìˆ˜
â”œâ”€â”€ firestore.rules     # Firebase ë³´ì•ˆ ê·œì¹™ (Consoleì—ì„œ ë°°í¬ í•„ìš”)
â””â”€â”€ handoff.md          # ì´ ë¬¸ì„œ
```

---

## ì¸ì¦ ì‹œìŠ¤í…œ (v4.0.0)

### ë¡œê·¸ì¸ í•„ìˆ˜
- ê²Œì„ ì‹œì‘ ì „ Google ë¡œê·¸ì¸ í•„ìˆ˜
- ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ê²Œì„ UI ìˆ¨ê¹€

### í™”ë©´ íë¦„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                 â”‚
â”‚  [ì‚¬ì´íŠ¸ ì ‘ì†]                                   â”‚
â”‚       â†“                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚  ë¡œê·¸ì¸ í™”ë©´     â”‚  â† ê²Œì„ ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€        â”‚
â”‚  â”‚  ğŸ±ğŸ¶           â”‚                            â”‚
â”‚  â”‚  ë©ëƒ¥ ë¨¸ì§€       â”‚                            â”‚
â”‚  â”‚  [Google ë¡œê·¸ì¸] â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚       â†“ (ë¡œê·¸ì¸ ì„±ê³µ)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚  ì„¸ì…˜ ë“±ë¡       â”‚  â†’ Firestore sessions/{uid} â”‚
â”‚  â”‚  í´ë¼ìš°ë“œ ë¡œë“œ   â”‚  â†’ Firestore saves/{uid}    â”‚
â”‚  â”‚  ê²Œì„ í™”ë©´ í‘œì‹œ  â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚       â†“ (ë¡œê·¸ì•„ì›ƒ ë˜ëŠ” ë‹¤ë¥¸ ê¸°ê¸° ë¡œê·¸ì¸)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚  ë¡œê·¸ì¸ í™”ë©´     â”‚  â† ìë™ ì´ë™                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì¸ì¦ ì½”ë“œ íë¦„
```javascript
// 1. í˜ì´ì§€ ë¡œë“œ ì‹œ
auth.getRedirectResult()  // redirect ê²°ê³¼ ì²˜ë¦¬

// 2. ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
startGoogleLogin()
  â†’ auth.signInWithRedirect(googleProvider)

// 3. ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
auth.onAuthStateChanged(user => {
  if (user) {
    registerSession()     // ì„¸ì…˜ ë“±ë¡
    loadFromCloud()       // í´ë¼ìš°ë“œ ë¡œë“œ
    showGameScreen()      // ê²Œì„ í‘œì‹œ
  } else {
    showLoginScreen()     // ë¡œê·¸ì¸ í™”ë©´
  }
})
```

---

## ë‹¨ì¼ ì„¸ì…˜ ì •ì±…

### ëª©ì 
í•œ ê³„ì •ìœ¼ë¡œ ë™ì‹œì— ì—¬ëŸ¬ ê¸°ê¸°ì—ì„œ í”Œë ˆì´ ë°©ì§€

### ë™ì‘ ë°©ì‹
```
[ê¸°ê¸° Aì—ì„œ ë¡œê·¸ì¸]
  â†’ registerSession() â†’ sessions/{uid} = { sessionId: "abc123", ... }
  â†’ currentSessionId = "abc123"

[ê¸°ê¸° Bì—ì„œ ê°™ì€ ê³„ì • ë¡œê·¸ì¸]
  â†’ registerSession() â†’ sessions/{uid} = { sessionId: "xyz789", ... }

[ê¸°ê¸° A: 10ì´ˆë§ˆë‹¤ checkSession()]
  â†’ Firestore sessionId ("xyz789") â‰  local sessionId ("abc123")
  â†’ "ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë¡œê·¸ì¸ë˜ì–´ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤" í† ìŠ¤íŠ¸
  â†’ auth.signOut() â†’ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
```

### ê´€ë ¨ í•¨ìˆ˜
| í•¨ìˆ˜ | ì—­í•  |
|------|------|
| `generateSessionId()` | ê³ ìœ  ì„¸ì…˜ ID ìƒì„± |
| `registerSession()` | Firestoreì— ì„¸ì…˜ ë“±ë¡ |
| `checkSession()` | 10ì´ˆë§ˆë‹¤ ì„¸ì…˜ ìœ íš¨ì„± í™•ì¸ |

---

## ë°ì´í„° ì €ì¥ ì‹œìŠ¤í…œ

### ì €ì¥ íë¦„
```
[ê²Œì„ ì•¡ì…˜ ë°œìƒ]
     â†“
updateAll()
     â†“
saveGame()
     â”œâ”€â”€ localStorage.setItem() â”€â”€â”€ ì¦‰ì‹œ ì €ì¥ (ë¡œì»¬ ë°±ì—…)
     â””â”€â”€ saveToCloud() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 500ms ë””ë°”ìš´ìŠ¤ í›„ Firestore ì €ì¥

[ì¤‘ìš” ì•¡ì…˜ (êµ¬ì¡° ì™„ë£Œ ë“±)]
     â†“
saveGameNow() â”€â”€â”€ localStorage + Firestore ì¦‰ì‹œ ì €ì¥

[í˜ì´ì§€ ì´íƒˆ]
     â†“
beforeunload â†’ localStorage ì €ì¥
visibilitychange â†’ saveGameNow()
```

### ë°ì´í„° ìš°ì„ ìˆœìœ„
```
v4.0.0: í´ë¼ìš°ë“œ ë°ì´í„°ë§Œ ì‚¬ìš© (ë¡œì»¬ì€ ë°±ì—…ìš©)

[ë¡œê·¸ì¸ ì‹œ]
  â†’ loadFromCloud()
  â†’ í´ë¼ìš°ë“œ ë°ì´í„° ìˆìœ¼ë©´ ì ìš©
  â†’ ì—†ìœ¼ë©´ initNewGame() (ìƒˆ ê²Œì„)
```

### ì €ì¥ ë°ì´í„° êµ¬ì¡°
```javascript
{
  // ë³´ë“œ ìƒíƒœ
  boardState: [{type, level}, ...],      // 35ì¹¸
  storageState: [{type, level}, ...],    // 5ì¹¸
  apartmentState: [{type, level, hp, rescued}, ...], // 3ì¹¸

  // ì¬í™”
  coins: number,
  cumulativeCoins: number,
  diamonds: number,
  energy: number,

  // ì§„í–‰ë„
  userLevel: number,
  questProgress: number,
  quests: [{id, type, reqs, reward}, ...],
  currentSetRescues: number,

  // ìƒì„±ê¸°
  genLevels: {cat: number, dog: number},

  // ìƒì 
  shopItems: [...],
  shopNextRefresh: number,

  // ê¸°íƒ€
  discoveredItems: [...],
  specialMissionCycles: [n, n, n],
  pmType: number,
  pmProgress: number,
  savedAt: timestamp
}
```

---

## Firebase êµ¬ì¡°

### Firestore ì»¬ë ‰ì…˜
| ì»¬ë ‰ì…˜ | ë¬¸ì„œ | ìš©ë„ |
|--------|------|------|
| `saves` | `{uid}` | ê²Œì„ ì „ì²´ ìƒíƒœ |
| `sessions` | `{uid}` | ì„¸ì…˜ ê´€ë¦¬ (ë‹¨ì¼ ë¡œê·¸ì¸) |

### ë³´ì•ˆ ê·œì¹™ (firestore.rules)
```javascript
// ë³¸ì¸ ë¬¸ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥
match /saves/{userId} {
  allow read, write: if request.auth.uid == userId
                     && isValidSaveData(request.resource.data);
}

match /sessions/{userId} {
  allow read, write: if request.auth.uid == userId;
}

// ë°ì´í„° ê²€ì¦
- ìˆ«ì ë²”ìœ„: coins 0~999ë§Œ, energy 0~100, ...
- ë°°ì—´ í¬ê¸°: boardState 35ì¹¸, storageState 10ì¹¸, ...
- íƒ€ì„ìŠ¤íƒ¬í”„: ë¯¸ë˜ ì‹œê°„ ë°©ì§€
```

**ì£¼ì˜**: Firebase Consoleì—ì„œ ê·œì¹™ ë°°í¬ í•„ìš”!

---

## ê²Œì„ ì‹œìŠ¤í…œ

### UI ë ˆì´ì•„ì›ƒ (ìœ„â†’ì•„ë˜)
| ìˆœì„œ | ìš”ì†Œ |
|------|------|
| 0 | ë¡œê·¸ì¸ í™”ë©´ (ë¹„ë¡œê·¸ì¸ ì‹œ) |
| 1 | ìƒë‹¨ë°” (ì—ë„ˆì§€, ì½”ì¸, ë‹¤ì´ì•„, ë ˆë²¨, ë¡œê·¸ì•„ì›ƒ) |
| 2 | ğŸ‘‘ ëˆ„ì  ì½”ì¸ (1000 ë‹¬ì„± ì‹œ ë³´ìƒ) |
| 3 | ì¼ë°˜ í€˜ìŠ¤íŠ¸ (6ê°œ, 3ê°œì”© í˜ì´ì§€) |
| 4 | ë§µ (5Ã—7 = 35ì¹¸) |
| 5 | ğŸ”¨ ìƒì‹œ ë¯¸ì…˜ |
| 6 | ìŠ¤í˜ì…œ í€˜ìŠ¤íŠ¸ (ğŸ¦ğŸ ğŸ¦) |
| 7 | ğŸš‘ êµ¬ì¡° í˜„ì¥ (3ë§ˆë¦¬) |
| 8 | ìƒì  (5ì¹¸) |
| 9 | ì°½ê³  (5ì¹¸) |

### ë³´ë“œ êµ¬ì„± (5Ã—7)
```
[0 ][1 ][2 ][3 ][4 ]   â† ìº£íƒ€ì›Œ(0), ê°œì§‘(4)
[5 ][6 ][7 ][8 ][9 ]
[10][11][12][13][14]
[15][16][17][18][19]
[20][21][22][23][24]
[25][26][27][28][29]
[30][31][32][33][34]   â† ë¯¸ì…˜(30,31), ì ê¸ˆ(32~34)
```

### ìƒì„±ê¸° (ì¼€ì´ì§€)
| íƒ€ì… | ì´ë¦„ | ìµœëŒ€ ë ˆë²¨ | ìƒì„±ë¬¼ |
|------|------|----------|--------|
| cat | ìº£íƒ€ì›Œ | 5 | ê³ ì–‘ì´ (11ë‹¨ê³„) + ê³ ì–‘ì´ ê°„ì‹ |
| dog | ê°œì§‘ | 5 | ê°•ì•„ì§€ (11ë‹¨ê³„) + ê°•ì•„ì§€ ê°„ì‹ |
| bird | ìƒˆì¥ | - | ìƒˆ (7ë‹¨ê³„) |
| fish | ì–´í•­ | - | ë¬¼ê³ ê¸° (7ë‹¨ê³„) |
| reptile | ì‚¬ìœ¡ì¥ | - | íŒŒì¶©ë¥˜ (7ë‹¨ê³„) |

### ë³´ìƒ êµ¬ì¡°
| í•­ëª© | ë³´ìƒ |
|------|------|
| í€˜ìŠ¤íŠ¸ ì™„ë£Œ | ê°€ë³€ (ë ˆë²¨ ìŠ¤ì¼€ì¼ë§) |
| ëˆ„ì  ì½”ì¸ 1000 | ì¹¸ë§ˆë‹¤ 50ğŸª™ |
| êµ¬ì¡° ì™„ë£Œ (3ë§ˆë¦¬) | 500ğŸª™ |
| ìŠ¤í˜ì…œ ë¯¸ì…˜ | 500ğŸª™ + 10ğŸ’ |
| ìƒì‹œ ë¯¸ì…˜ | 100ğŸª™ |
| ë ˆë²¨ì—… | ë ˆë²¨ Ã— 5 ğŸ’ |

---

## ì£¼ìš” í•¨ìˆ˜ ëª©ë¡

### ì¸ì¦
| í•¨ìˆ˜ | ì—­í•  |
|------|------|
| `startGoogleLogin()` | Google ë¡œê·¸ì¸ ì‹œì‘ |
| `handleGoogleLogin()` | ìƒë‹¨ë°” ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ |
| `showLoginScreen()` | ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ |
| `showGameScreen()` | ê²Œì„ í™”ë©´ í‘œì‹œ |

### ì„¸ì…˜
| í•¨ìˆ˜ | ì—­í•  |
|------|------|
| `registerSession()` | Firestoreì— ì„¸ì…˜ ë“±ë¡ |
| `checkSession()` | ì„¸ì…˜ ìœ íš¨ì„± í™•ì¸ (10ì´ˆ ì£¼ê¸°) |

### ì €ì¥/ë¡œë“œ
| í•¨ìˆ˜ | ì—­í•  |
|------|------|
| `saveGame()` | ë¡œì»¬ + í´ë¼ìš°ë“œ ì €ì¥ (ë””ë°”ìš´ìŠ¤) |
| `saveGameNow()` | ì¦‰ì‹œ ì €ì¥ |
| `saveToCloud()` | Firestore ì €ì¥ |
| `loadFromCloud()` | Firestore ë¡œë“œ |
| `getGameData()` | ì €ì¥í•  ë°ì´í„° ê°ì²´ ìƒì„± |
| `applyGameData()` | ë¡œë“œí•œ ë°ì´í„° ì ìš© |
| `validateGameData()` | ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ |

### ê²Œì„ ì´ˆê¸°í™”
| í•¨ìˆ˜ | ì—­í•  |
|------|------|
| `init()` | UI ì…€ ìƒì„±, íƒ€ì´ë¨¸ ì‹œì‘, ì´ë²¤íŠ¸ ë“±ë¡ |
| `initNewGame()` | ìƒˆ ê²Œì„ ë°ì´í„° ì´ˆê¸°í™” |
| `initApartment()` | êµ¬ì¡° í˜„ì¥ ë™ë¬¼ ë°°ì¹˜ |
| `refreshShop()` | ìƒì  ì•„ì´í…œ ê°±ì‹  |

### ê²Œì„ ë¡œì§
| í•¨ìˆ˜ | ì—­í•  |
|------|------|
| `spawnItem()` | ë™ë¬¼/ê°„ì‹ ìƒì„± |
| `mergeItems()` | ì•„ì´í…œ í•©ì„± |
| `updateAll()` | ì „ì²´ UI ê°±ì‹  + ì €ì¥ |

---

## ìƒìˆ˜ (js/constants.js)

### ê·¸ë¦¬ë“œ
```javascript
GRID_COLS = 5
GRID_ROWS = 7
BOARD_SIZE = 35
STORAGE_SIZE = 5
APARTMENT_ROOMS = 3
SHOP_SIZE = 5
```

### ë°¸ëŸ°ìŠ¤
```javascript
MAX_ENERGY = 100
RECOVERY_SEC = 30
SHOP_REFRESH_MS = 300000  // 5ë¶„
UNLOCK_COST_BOARD = 100
ENERGY_COST = 500
RESCUE_QUEST_REWARD = 500
```

---

## To-do

- [x] ë¡œê·¸ì¸ í•„ìˆ˜ ì‹œìŠ¤í…œ (v4.0.0) âœ…
- [x] í´ë¼ìš°ë“œ ë°ì´í„° ìš°ì„  âœ…
- [x] ë‹¨ì¼ ì„¸ì…˜ ì •ì±… âœ…
- [x] íŒŒì¼ ë¶„ë¦¬ (CSS, ìƒìˆ˜) âœ…
- [x] ìºì‹œ ë¹„í™œì„±í™” ë©”íƒ€ íƒœê·¸ âœ…
- [ ] **Firebase Consoleì—ì„œ firestore.rules ë°°í¬**
- [ ] ì‚¬ìš´ë“œ íš¨ê³¼ ì¶”ê°€
- [ ] ë°¸ëŸ°ìŠ¤ í…ŒìŠ¤íŠ¸
- [ ] ëª¨ë°”ì¼ ìµœì í™” ê²€ì¦
- [ ] íŠœí† ë¦¬ì–¼ í™•ì¥

---

## ë³€ê²½ ì´ë ¥

### v4.0.0 (2026-02-03)
- ë¡œê·¸ì¸ í•„ìˆ˜ ì‹œìŠ¤í…œ ë„ì…
- ëœë”© í˜ì´ì§€ (íƒ€ì´í‹€ + Google ë¡œê·¸ì¸)
- í´ë¼ìš°ë“œ ë°ì´í„°ë§Œ ì‚¬ìš© (ë¡œì»¬ vs í´ë¼ìš°ë“œ ë¹„êµ ì œê±°)
- ë§¤ ë¡œê·¸ì¸ ì‹œ ì„¸ì…˜ ë“±ë¡
- FirebaseUI ì œê±° â†’ ì§ì ‘ Google ì¸ì¦
- ìºì‹œ ë¹„í™œì„±í™” ë©”íƒ€ íƒœê·¸

### v3.x (2026-02-03)
- Firebase ì•„í‚¤í…ì²˜ ê°œì„  (P0~P2)
- ëª¨ë°”ì¼ redirect ë¡œê·¸ì¸ ì§€ì›
- í¬ë¡œìŠ¤ ë””ë°”ì´ìŠ¤ ë™ê¸°í™”
- Firestore ë³´ì•ˆ ê·œì¹™
- íŒŒì¼ ë¶„ë¦¬ (CSS, ìƒìˆ˜)

### v2.x (2026-02-02)
- Firebase ì—°ë™, í´ë¼ìš°ë“œ ì €ì¥
- ë‹¨ì¼ ì„¸ì…˜ ì •ì±…
- êµ¬ì¡° ì‹œìŠ¤í…œ ê°œí¸
- í€˜ìŠ¤íŠ¸ ì‹œìŠ¤í…œ ê°œì„ 
- ìƒì‹œ ë¯¸ì…˜ ì¶”ê°€

### v1.x (2026-02-02)
- ì´ˆê¸° êµ¬í˜„
- ê¸°ë³¸ ê²Œì„ ë¡œì§
- localStorage ì €ì¥
