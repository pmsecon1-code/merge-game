# 멍냥 머지 게임 - Handoff

## 2026-02-02 작업 내용 (계속)

### 12. 도감 시스템 개선
- `discoveredItems` 전역 Set으로 발견한 아이템 추적
- 현재 맵 상태가 아닌 세션 중 발견한 모든 아이템 표시
- 케이지 업그레이드 UI 구조 분리 (`upgrade-content`, `upgrade-msg`)

### 13. 버그 수정
- 구조 보상 팝업: "100 코인" → "500 코인" (RESCUE_QUEST_REWARD 사용)
- 스페셜 퀘스트 텍스트 한글화: bird→새, fish→물고기, reptile→파충류

### 14. 일반 퀘스트 시스템 대폭 개선
- 퀘스트 개수: 3개 → **6개**
- UI: 3개씩 표시 + 좌우 네비게이션 버튼 (`‹` `›`)
- 레벨업 기준: 레벨×3 → **레벨×2** 퀘스트 완료
- **레벨별 난이도 자동 스케일링**
- **완료 가능 퀘스트 자동 정렬** (앞으로)
- **자동 페이지 이동**: 완료 가능 퀘스트 수 증가 시마다 1페이지로 이동
  - `prevReadyCount` 추적하여 새 완료 가능 퀘스트 감지
  - 사용자 수동 페이지 이동 허용
  - 이후 새 완료 가능 퀘스트 생기면 다시 자동 이동

### 15. 생성기 행운 시스템 개선
- 행운 확률: 5% + (레벨-1)%
- 행운 발동 시: Lv.1→2, Lv.2→3, Lv.3+→4 동물/간식 (50:50)

### 16. Lucky 이펙트 강화
- 화면 플래시, 셀 글로우, 큰 텍스트 `✨ Lucky! ✨`
- 확장 링 100px, 파티클 12개

### 17. 상시 미션 시스템 추가
- **보드 축소**: 5×8 → 5×7 (35칸)
- **8번째 줄**: 상시 미션 바 (한 줄 UI)
- **미션 순환**: 🔨 100번 합성 ↔ ✨ 200번 생성
- **보상**: 100🪙
- **UI**: `🔨 100번 합성하기(100🪙) [████] 3/100`

### 18. 생성기 이름 변경
- 고양이 → **캣타워**
- 강아지 → **개집**

### 19. 7행 업그레이드 미션 셀 추가
- **30번 셀**: 🎯 캣타워 Lv.2 달성하기
- **31번 셀**: 🎯 개집 Lv.2 달성하기
- **클릭 동작**:
  - 미달성: 해당 생성기 업그레이드 탭으로 이동
  - 달성: 셀 해제 (사용 가능)
- **스타일**: 미달성=노란 점선, 달성=초록 실선+✅

### 20. 게임 저장/불러오기 (localStorage)
- **자동 저장**: `updateAll()` 호출 시마다 자동 저장
- **자동 불러오기**: `init()` 시 저장된 데이터 있으면 불러오기
- **저장 항목**:
  - boardState, storageState, apartmentState
  - coins, cumulativeCoins, diamonds, energy
  - userLevel, questProgress, quests
  - genLevels, shopItems, shopNextRefresh
  - discoveredItems, specialMissionCycles
  - pmType, pmProgress, isTutorialActive
- **새 게임 vs 불러오기**: 저장 데이터 없으면 기본 초기화 진행

### 21. Firebase 연동 (클라우드 저장)
- **Firebase 프로젝트**: `merge-game-7cf5f`
- **인증**: Google 로그인
- **DB**: Firestore (`/saves/{userId}`)
- **저장 주기**:
  - localStorage: 즉시 (매 액션)
  - Firestore: 3초 디바운스
- **동기화 로직**:
  - 로그인 시 클라우드 vs 로컬 `savedAt` 비교
  - 최신 데이터 자동 적용
- **보안 규칙**: 본인 UID 문서만 읽기/쓰기 허용
- **UI**: 상단바 🔑 로그인 버튼

### 22. UI 레이아웃 전체 재배치
- **변경 순서**:
  1. 👑 누적 코인
  2. 일반 퀘스트 (6개)
  3. 맵 (5×7)
  4. 🔨 상시 미션
  5. 스페셜 퀘스트 (🐦🐠🦎)
  6. 🚑 구조 달성 + 구조 현장
  7. 상점
  8. 창고

### 23. 로드 시 렌더링 버그 수정
- `updateAll()`에 `renderShop()`, `renderApartment()` 추가
- 로드 시 상점/구조현장이 표시되지 않던 문제 해결
- 구조 현장 즉시 초기화 (2초 지연 제거)
  - `apartmentState`가 비어있으면 `initApartment()` 즉시 호출

---

## 이전 작업 (2026-02-02)

### 1~11. 초기 구현
- 프로젝트 초기화, 누락 함수 구현
- 구조 현장 3x1, HELP 말풍선
- 상점 개선, 다이아 판매
- 생성기 거리 우선 배치, 파티클 효과
- 퀘스트 무지개 테두리, 보상 UI 통일
- 스페셜 퀘스트 순환 (새/물고기/파충류)
- 룰렛 파란 그라데이션, 숫자 라벨
- 동물 이모지/색상 구분 강화
- 레이아웃 정사각형 셀, 스크롤 가능

---

## 현재 상태

### UI 레이아웃 (위→아래)
| 순서 | 요소 |
|------|------|
| 1 | 상단바 (에너지, 코인, 다이아, 레벨, 로그인) |
| 2 | 👑 누적 코인 |
| 3 | 일반 퀘스트 (6개, 3개씩 페이지) |
| 4 | 맵 (5×7) |
| 5 | 🔨 상시 미션 |
| 6 | 스페셜 퀘스트 (🐦🐠🦎) |
| 7 | 🚑 구조 달성 + 구조 현장 |
| 8 | 상점 |
| 9 | 창고 |

### 시스템 상태
| 시스템 | 상태 |
|--------|------|
| 메인 보드 | 5×7 (35칸), 7행: 미션2+잠금3 |
| 창고 | 5칸, 다이아로 해제 |
| 구조 현장 | 3x1 (3마리), 😿/🙀 랜덤, HELP 말풍선 |
| 상점 | 4칸 랜덤 + 1칸 다이아 판매 |
| 스페셜 미션 | 새/물고기/파충류 (Lv.3,6,9 + 9n 순환) |
| 일반 퀘스트 | 6개, 자동 정렬, 새 완료 가능 시 자동 이동 |
| 상시 미션 | 합성 100회 ↔ 생성 200회, 100🪙 |
| 저장 | localStorage + Firebase (Google 로그인 시) |

### 퀘스트 자동 이동 로직
```
prevReadyCount = 이전 완료 가능 수
readyCount = 현재 완료 가능 수

if (readyCount > prevReadyCount && questPage > 0)
    → 1페이지로 자동 이동

prevReadyCount = readyCount
```

### 7행 셀 구성
| 인덱스 | 내용 | 클릭 |
|--------|------|------|
| 30 | 캣타워 Lv.2 미션 | 미달성→업그레이드탭, 달성→해제 |
| 31 | 개집 Lv.2 미션 | 미달성→업그레이드탭, 달성→해제 |
| 32~34 | 잠금 🔒 | 코인으로 해제 |

### 생성기 이름
| 타입 | 이름 |
|------|------|
| 고양이 | 캣타워 (Lv.X) |
| 강아지 | 개집 (Lv.X) |
| 새 | 새장 |
| 물고기 | 어항 |
| 파충류 | 사육장 |

### 보상 구조
| 항목 | 보상 |
|------|------|
| 퀘스트 완료 | 가변 (레벨 스케일링) |
| 누적 코인 마일스톤 | 칸마다 50🪙 |
| 구조 달성 마일스톤 | 칸마다 500🪙 |
| 스페셜 미션 | 500🪙 + 10💎 |
| 상시 미션 | 100🪙 |
| 레벨업 | 레벨 x 5 💎 |

---

## To-do
- [x] 게임 저장/불러오기 (localStorage) ✅
- [x] GitHub Pages 배포 ✅
- [x] Firebase 클라우드 저장 ✅
- [ ] 사운드 효과 추가
- [ ] 밸런스 테스트
- [ ] 모바일 최적화 검증
- [ ] 튜토리얼 확장
